<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WikiScroll</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --w1:#667eea;--w2:#764ba2;
  --h1:#11998e;--h2:#38ef7d;
  --glass:rgba(10,10,18,.87);
  --border:rgba(255,255,255,.09);
  --dim:rgba(255,255,255,.48);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;overscroll-behavior:none;}
body{font-family:'DM Sans',sans-serif;background:#07070d;color:#fff;}

/* â”€â”€ HEADER â”€â”€ */
.hdr{
  position:fixed;top:0;left:0;right:0;z-index:300;
  display:grid;grid-template-columns:1fr auto 1fr;
  align-items:center;gap:8px;
  padding:max(13px,env(safe-area-inset-top)) 16px 13px;
  background:linear-gradient(to bottom,rgba(7,7,13,.97) 60%,transparent);
}
.hdr-left,.hdr-mid,.hdr-right{display:flex;align-items:center;}
.hdr-left{justify-content:flex-start;}
.hdr-mid{justify-content:center;}
.hdr-right{justify-content:flex-end;gap:7px;}
.logo{
  font-family:'Syne',sans-serif;font-size:22px;font-weight:800;letter-spacing:-1px;
  background:linear-gradient(135deg,var(--w1),var(--w2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  white-space:nowrap;
}
body.how .logo{
  background:linear-gradient(135deg,var(--h1),var(--h2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}

/* â”€â”€ TOGGLE â”€â”€ */
.toggle{
  display:flex;background:rgba(255,255,255,.06);
  border:1px solid var(--border);border-radius:50px;padding:3px;gap:2px;
}
.tbtn{
  font-family:'Syne',sans-serif;font-size:12px;font-weight:700;
  padding:6px 14px;border-radius:50px;border:none;cursor:pointer;
  background:transparent;color:var(--dim);transition:all .22s;white-space:nowrap;
}
.tbtn.on{color:#fff;}
.tbtn.won{background:linear-gradient(135deg,var(--w1),var(--w2));box-shadow:0 2px 12px rgba(102,126,234,.4);}
.tbtn.hon{background:linear-gradient(135deg,var(--h1),var(--h2));box-shadow:0 2px 12px rgba(56,239,125,.25);}

/* â”€â”€ PILLS / BADGES â”€â”€ */
.pill{
  display:flex;align-items:center;gap:6px;padding:6px 13px;height:32px;
  background:rgba(255,255,255,.07);border:1px solid var(--border);border-radius:50px;
  color:#fff;cursor:pointer;font-size:12px;font-weight:500;
  transition:background .2s;white-space:nowrap;font-family:'DM Sans',sans-serif;flex-shrink:0;
}
.pill:hover{background:rgba(255,255,255,.13);}
.badge{font-size:10px;font-weight:700;padding:1px 5px;border-radius:20px;background:var(--w2);line-height:1.4;}
body.how .badge{background:var(--h1);}
.topic-badge{background:var(--w1);}

/* â”€â”€ DESKTOP LANG DROPDOWN â”€â”€ */
.lang-wrap{position:relative;}
.lang-dd{
  position:absolute;top:calc(100% + 8px);right:0;
  background:rgba(12,12,20,.98);border:1px solid var(--border);
  border-radius:16px;padding:6px;min-width:185px;
  display:none;max-height:360px;overflow-y:auto;
  box-shadow:0 20px 60px rgba(0,0,0,.7);z-index:400;
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.08) transparent;
}
.lang-dd.open{display:block;}
.lopt{
  padding:9px 12px;cursor:pointer;border-radius:10px;
  display:flex;align-items:center;gap:9px;
  font-size:13px;color:rgba(255,255,255,.8);transition:background .15s;
}
.lopt:hover,.lopt.sel{background:rgba(255,255,255,.08);}

/* â”€â”€ HAMBURGER BTN â”€â”€ */
.burger-btn{
  display:none;align-items:center;justify-content:center;
  width:36px;height:36px;border-radius:50%;
  background:rgba(255,255,255,.07);border:1px solid var(--border);
  cursor:pointer;flex-shrink:0;position:relative;transition:background .2s;
}
.burger-btn:hover{background:rgba(255,255,255,.13);}
.burger-btn svg{width:18px;height:18px;display:block;}
.burger-dot{
  position:absolute;top:-3px;right:-3px;width:8px;height:8px;
  border-radius:50%;background:var(--w1);display:none;
}
body.how .burger-dot{background:var(--h1);}

/* â”€â”€ BURGER MENU â”€â”€ */
.burger-menu{
  position:fixed;top:0;left:0;right:0;z-index:299;
  background:rgba(7,7,13,.99);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  max-height:0;overflow:hidden;
  transition:max-height .3s cubic-bezier(.4,0,.2,1);
}
.burger-menu.open{max-height:100dvh;overflow-y:auto;}
.burger-inner{
  padding:calc(max(13px,env(safe-area-inset-top)) + 60px) 18px calc(18px + env(safe-area-inset-bottom));
}
.burger-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 0;border-bottom:1px solid var(--border);
}
.burger-row:last-child{border-bottom:none;padding-bottom:0;}
.burger-row-label{display:flex;align-items:center;gap:10px;color:rgba(255,255,255,.75);font-size:14px;font-weight:500;}
.burger-row-label .ico{font-size:18px;line-height:1;}
.burger-row-sub{font-size:11px;color:var(--dim);font-weight:400;margin-top:2px;}
.burger-action{
  display:flex;align-items:center;gap:7px;padding:7px 14px;border-radius:50px;
  background:rgba(255,255,255,.07);border:1px solid var(--border);
  color:#fff;cursor:pointer;font-size:12px;font-weight:500;
  font-family:'DM Sans',sans-serif;transition:background .2s;white-space:nowrap;
}
.burger-action:hover{background:rgba(255,255,255,.13);}
.burger-action.active{background:rgba(102,126,234,.18);border-color:rgba(102,126,234,.35);color:#a5b4fc;}

/* â”€â”€ INLINE LANG GRID (mobile) â”€â”€ */
.burger-lang-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:7px;
  max-height:0;overflow:hidden;
  transition:max-height .25s ease,padding .25s ease;padding:0;
}
.burger-lang-grid.open{max-height:340px;padding:10px 0 4px;}
.blopt{
  display:flex;align-items:center;gap:8px;padding:10px 12px;
  border-radius:12px;background:rgba(255,255,255,.05);
  border:1px solid var(--border);color:rgba(255,255,255,.8);
  cursor:pointer;font-size:13px;transition:background .15s,border-color .15s;
}
.blopt:hover{background:rgba(255,255,255,.1);}
.blopt.sel{background:rgba(102,126,234,.15);border-color:rgba(102,126,234,.35);color:#c4ccf5;}

/* â”€â”€ INLINE TOPIC CHIPS (mobile) â”€â”€ */
.burger-topics{
  max-height:0;overflow:hidden;
  transition:max-height .25s ease,padding .25s ease;padding:0;
}
.burger-topics.open{max-height:280px;padding:10px 0 4px;}
.burger-topic-grid{display:flex;flex-wrap:wrap;gap:7px;}
.btopic{
  display:flex;align-items:center;gap:6px;padding:8px 13px;
  border-radius:50px;background:rgba(255,255,255,.05);
  border:1px solid var(--border);color:rgba(255,255,255,.75);
  cursor:pointer;font-size:12px;font-weight:500;
  transition:background .15s,border-color .15s;
}
.btopic:hover{background:rgba(255,255,255,.1);}
.btopic.on{background:rgba(102,126,234,.18);border-color:rgba(102,126,234,.4);color:#a5b4fc;}

/* â”€â”€ TOGGLE SWITCH â”€â”€ */
.toggle-sw{
  width:44px;height:24px;border-radius:12px;border:none;
  background:rgba(255,255,255,.15);cursor:pointer;position:relative;
  transition:background .2s;flex-shrink:0;
}
.toggle-sw::after{
  content:'';position:absolute;top:2px;left:2px;
  width:20px;height:20px;border-radius:50%;
  background:#fff;transition:transform .2s;
  box-shadow:0 1px 4px rgba(0,0,0,.3);
}
.toggle-sw.on{background:var(--w1);}
body.how .toggle-sw.on{background:var(--h1);}
.toggle-sw.on::after{transform:translateX(20px);}

/* â”€â”€ TOPIC SHEET â”€â”€ */
.sheet-overlay{
  position:fixed;inset:0;z-index:480;background:rgba(0,0,0,.5);
  display:none;backdrop-filter:blur(4px);
}
.sheet-overlay.open{display:block;}
.topic-sheet{
  position:fixed;bottom:-100%;left:0;right:0;z-index:490;
  background:rgba(8,8,14,.98);backdrop-filter:blur(24px);
  border-top:1px solid var(--border);border-radius:24px 24px 0 0;
  padding:0 24px calc(24px + env(safe-area-inset-bottom));
  transition:bottom .32s cubic-bezier(.4,0,.2,1);
  max-height:55vh;overflow-y:auto;
}
.topic-sheet.open{bottom:0;}
.sheet-handle{width:36px;height:4px;background:rgba(255,255,255,.14);border-radius:2px;margin:16px auto 20px;}
.sheet-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:6px;}
.sheet-sub{font-size:13px;color:var(--dim);margin-bottom:20px;line-height:1.5;}
.topic-grid{display:flex;flex-wrap:wrap;gap:10px;}
.topic-chip{
  display:flex;align-items:center;gap:8px;padding:11px 18px;
  border-radius:50px;border:1px solid var(--border);
  background:rgba(255,255,255,.06);color:rgba(255,255,255,.8);
  cursor:pointer;font-size:14px;font-weight:500;transition:all .18s;
}
.topic-chip:hover{background:rgba(255,255,255,.11);}
.topic-chip.on{background:rgba(102,126,234,.2);border-color:rgba(102,126,234,.45);color:#b8c2f8;}
.sheet-reset{
  margin-top:18px;padding:10px 22px;border-radius:50px;border:1px solid var(--border);
  background:transparent;color:var(--dim);cursor:pointer;font-size:13px;
  font-family:'DM Sans',sans-serif;transition:all .18s;
}
.sheet-reset:hover{background:rgba(255,255,255,.07);color:#fff;}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{
  position:fixed;inset:0;z-index:500;display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,.6);backdrop-filter:blur(6px);
}
.modal-overlay.open{display:flex;}
.modal{
  width:min(420px,88vw);background:rgba(12,12,20,.98);
  border:1px solid var(--border);border-radius:24px;padding:32px;
  box-shadow:0 30px 80px rgba(0,0,0,.7);text-align:center;position:relative;
  animation:mshow .22s ease;
}
@keyframes mshow{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.modal-close{
  position:absolute;top:16px;right:18px;font-size:18px;cursor:pointer;
  background:none;border:none;color:var(--dim);transition:color .2s;
}
.modal-close:hover{color:#fff;}
.modal-logo{
  font-family:'Syne',sans-serif;font-size:26px;font-weight:800;letter-spacing:-1px;
  background:linear-gradient(135deg,var(--w1),var(--w2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:14px;
}
.modal-body{font-size:14px;line-height:1.7;color:rgba(255,255,255,.72);margin-bottom:18px;}
.modal-contact{font-size:12px;color:var(--dim);}
.modal-contact a{color:#a5b4fc;text-decoration:none;}

/* â”€â”€ FEED / CARDS â”€â”€ */
.feed{
  height:100vh;overflow-y:scroll;scroll-snap-type:y mandatory;
  scrollbar-width:none;-ms-overflow-style:none;
  touch-action:pan-y;-webkit-overflow-scrolling:touch;
  outline:none;
}
.feed::-webkit-scrollbar{display:none;}
.card{
  height:100vh;scroll-snap-align:start;position:relative;
  display:flex;align-items:center;justify-content:center;
  background:#07070d;overflow:hidden;will-change:transform;
  content-visibility:auto;contain-intrinsic-size:100vw 100vh;
}
.cbg{position:absolute;inset:0;z-index:0;}
.cbg img{width:100%;height:100%;object-fit:cover;opacity:.45;filter:blur(28px) saturate(1.6);transform:scale(1.12) translateZ(0);}
.cveil{
  position:absolute;inset:0;
  background:rgba(7,7,13,.45),
    radial-gradient(ellipse at 30% 30%,rgba(102,126,234,.1) 0%,transparent 60%),
    radial-gradient(ellipse at 75% 75%,rgba(118,75,162,.07) 0%,transparent 55%);
}
.card.how .cveil{
  background:rgba(7,7,13,.45),
    radial-gradient(ellipse at 30% 30%,rgba(17,153,142,.1) 0%,transparent 60%),
    radial-gradient(ellipse at 75% 75%,rgba(56,239,125,.06) 0%,transparent 55%);
}

/* â”€â”€ SWIPE INDICATORS â”€â”€ */
.swipe-ind{
  position:absolute;z-index:2;top:50%;transform:translateY(-50%);
  font-family:'Syne',sans-serif;font-weight:800;font-size:20px;letter-spacing:.5px;
  padding:10px 18px;border-radius:14px;border:3px solid;
  opacity:0;pointer-events:none;transition:opacity .06s;
  text-shadow:0 2px 8px rgba(0,0,0,.5);
}
.like-ind{left:22px;color:#4ade80;border-color:#4ade80;transform:translateY(-50%) rotate(-14deg);}
.skip-ind{right:22px;color:#f87171;border-color:#f87171;transform:translateY(-50%) rotate(14deg);}

/* â”€â”€ OTD BADGE â”€â”€ */
.otd-badge{
  position:absolute;z-index:2;
  top:max(68px,calc(env(safe-area-inset-top) + 56px));
  left:50%;transform:translateX(-50%);
  display:flex;align-items:center;gap:6px;white-space:nowrap;
  padding:5px 14px;border-radius:50px;
  background:rgba(251,191,36,.14);border:1px solid rgba(251,191,36,.38);
  color:#fcd34d;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;
  letter-spacing:.8px;pointer-events:none;
}
.otd-star{
  position:absolute;z-index:2;
  top:max(66px,calc(env(safe-area-inset-top) + 54px));
  right:14px;
  font-size:28px;pointer-events:none;
  filter:drop-shadow(0 2px 8px rgba(251,191,36,.5));
  animation:otdPulse 2.5s ease-in-out infinite;
}
@keyframes otdPulse{0%,100%{opacity:.85;transform:scale(1)}50%{opacity:1;transform:scale(1.12)}}

/* â”€â”€ PANEL â”€â”€ */
.panel{
  position:relative;z-index:1;width:min(660px,90vw);max-height:74vh;padding:24px;
  background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-radius:26px;border:1px solid var(--border);
  box-shadow:0 30px 80px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.05);
  display:flex;flex-direction:column;overflow:hidden;
}
.chip{
  display:inline-flex;align-items:center;gap:5px;
  font-family:'Syne',sans-serif;font-size:10px;font-weight:700;
  letter-spacing:1.1px;text-transform:uppercase;
  padding:3px 10px;border-radius:20px;margin-bottom:14px;width:fit-content;flex-shrink:0;
}
.chip.w{background:rgba(102,126,234,.16);color:#a5b4fc;border:1px solid rgba(102,126,234,.22);}
.chip.h{background:rgba(17,153,142,.15);color:#6ee7b7;border:1px solid rgba(17,153,142,.22);}
.art-img{width:100%;max-height:220px;object-fit:contain;border-radius:16px;margin-bottom:14px;flex-shrink:0;background:rgba(0,0,0,.25);}
.art-title{
  font-family:'Syne',sans-serif;font-size:21px;font-weight:700;
  line-height:1.22;letter-spacing:-.4px;margin-bottom:10px;flex-shrink:0;
  overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
}
.art-body{
  font-size:14px;line-height:1.65;color:rgba(255,255,255,.73);
  flex-shrink:1;min-height:0;margin-bottom:18px;
  overflow:hidden;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;
}
.acts{display:flex;gap:10px;flex-shrink:0;flex-wrap:nowrap;margin-top:auto;}
.act{
  display:flex;align-items:center;gap:8px;padding:14px 20px;border-radius:14px;
  border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.07);
  color:#fff;cursor:pointer;font-size:15px;font-weight:500;
  transition:background .25s ease,border-color .25s ease,color .25s ease,opacity .1s;
  white-space:nowrap;font-family:'DM Sans',sans-serif;
  -webkit-tap-highlight-color:transparent;
  overflow:hidden;outline:none;
}
.act:hover{background:rgba(255,255,255,.13);}
.act:active{opacity:.75;}
.act:focus-visible{box-shadow:0 0 0 2px rgba(102,126,234,.5);}
.act.liked{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35);color:#fca5a5;}
.act.cta{flex:1;justify-content:center;border:none;font-weight:600;background:linear-gradient(135deg,var(--w1),var(--w2));}
.act.cta.hcta{background:linear-gradient(135deg,var(--h1),var(--h2));}
.act.cta:hover{filter:brightness(1.1);}

/* â”€â”€ SPINNER â”€â”€ */
.spin-wrap{height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;}
.spin{width:42px;height:42px;border:3px solid rgba(255,255,255,.07);border-top-color:var(--w1);border-radius:50%;animation:rot .85s linear infinite;}
.spin.h{border-top-color:var(--h1);}
.spin-lbl{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:.5px;color:var(--dim);}
@keyframes rot{to{transform:rotate(360deg);}}

/* â”€â”€ HINT â”€â”€ */
.hint{
  position:fixed;left:50%;z-index:100;
  bottom:max(26px,calc(env(safe-area-inset-bottom) + 12px));
  display:none;flex-direction:column;align-items:center;gap:6px;pointer-events:none;
  animation:hshow .4s .3s both,hbounce 2s .7s infinite;
}
@keyframes hshow{from{opacity:0}to{opacity:1}}
@keyframes hbounce{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-8px)}}
.hint-txt{font-size:11px;color:var(--dim);letter-spacing:.4px;}
.hint-arr{width:16px;height:16px;border-right:2px solid var(--dim);border-bottom:2px solid var(--dim);transform:rotate(45deg);}

/* â”€â”€ LIKES PANEL â”€â”€ */
.lp{
  position:fixed;top:0;right:-430px;width:420px;height:100vh;
  background:rgba(8,8,14,.97);backdrop-filter:blur(22px);
  border-left:1px solid var(--border);z-index:400;
  transition:right .32s cubic-bezier(.4,0,.2,1);overflow-y:auto;
  padding:max(84px,calc(env(safe-area-inset-top) + 70px)) 18px max(24px,env(safe-area-inset-bottom));
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.07) transparent;
}
.lp.open{right:0;}
.lp-hdr{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center;}
.lp-x{font-size:20px;cursor:pointer;background:none;border:none;color:var(--dim);transition:color .2s;}
.lp-x:hover{color:#fff;}
.li{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;}
.li-src{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;opacity:.5;margin-bottom:4px;}
.li-offline{font-size:10px;color:#4ade80;opacity:.7;margin-bottom:4px;display:flex;align-items:center;gap:4px;}
.li-ttl{font-family:'Syne',sans-serif;font-size:14px;font-weight:600;margin-bottom:5px;line-height:1.3;}
.li-body{font-size:12px;color:var(--dim);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;margin-bottom:9px;}
.li-acts{display:flex;gap:7px;}
.li-btn{font-size:11px;padding:4px 11px;background:rgba(255,255,255,.07);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,.8);cursor:pointer;transition:background .18s;}
.li-btn:hover{background:rgba(255,255,255,.14);}
.empty{text-align:center;padding:44px 20px;color:var(--dim);}
.empty-ico{font-size:42px;margin-bottom:12px;}
.empty-ttl{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:rgba(255,255,255,.6);margin-bottom:6px;}
.empty-txt{font-size:13px;line-height:1.6;}

/* â”€â”€ AMBIENT MODE â”€â”€ */
.ambient-overlay{
  position:fixed;inset:0;z-index:700;
  display:none;flex-direction:column;align-items:center;justify-content:center;
}
.ambient-overlay.open{display:flex;animation:ambIn .65s cubic-bezier(.4,0,.2,1) forwards;}
.ambient-overlay.closing{animation:ambOut .4s ease forwards;}
@keyframes ambIn{from{background:rgba(0,0,0,0)}to{background:rgba(0,0,0,.88)}}
@keyframes ambOut{from{background:rgba(0,0,0,.88);opacity:1}to{background:rgba(0,0,0,0);opacity:0}}
.ambient-bg{
  position:absolute;inset:-40px;z-index:0;
  background-size:cover;background-position:center;
  filter:blur(48px) saturate(1.5) brightness(.4);
  transform:scale(1.08) translateZ(0);
  animation:ambBgIn .9s cubic-bezier(.4,0,.2,1) forwards;
}
@keyframes ambBgIn{from{opacity:0;filter:blur(10px) saturate(1) brightness(.2)}to{opacity:1;filter:blur(48px) saturate(1.5) brightness(.4)}}
.ambient-content{
  position:relative;z-index:1;text-align:center;
  padding:40px 32px;max-width:min(620px,90vw);max-height:80vh;overflow-y:auto;
  animation:ambContentIn .8s .18s cubic-bezier(.4,0,.2,1) both;
  pointer-events:auto;
  scrollbar-width:none;-ms-overflow-style:none;
}
.ambient-content::-webkit-scrollbar{display:none;}
@keyframes ambContentIn{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
.ambient-label{
  font-family:'Syne',sans-serif;font-size:11px;font-weight:700;
  letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,.35);margin-bottom:28px;
}
.ambient-title{
  font-family:'Syne',sans-serif;
  font-size:clamp(28px,5.5vw,56px);
  font-weight:800;line-height:1.08;letter-spacing:-1.5px;
  color:#fff;margin-bottom:24px;
  text-shadow:0 4px 40px rgba(0,0,0,.6);
}
.ambient-excerpt{
  font-size:15px;line-height:1.75;color:rgba(255,255,255,.52);
  display:-webkit-box;-webkit-line-clamp:12;-webkit-box-orient:vertical;overflow:hidden;
}
.ambient-close{
  position:absolute;top:max(20px,env(safe-area-inset-top));right:20px;z-index:2;
  width:44px;height:44px;border-radius:50%;
  background:rgba(255,255,255,.09);border:1px solid rgba(255,255,255,.12);
  cursor:pointer;color:#fff;font-size:18px;
  display:flex;align-items:center;justify-content:center;
  transition:background .2s;
}
.ambient-close:hover{background:rgba(255,255,255,.18);}
.ambient-hint{
  position:absolute;bottom:max(28px,env(safe-area-inset-bottom));
  font-size:11px;color:rgba(255,255,255,.28);letter-spacing:.5px;
  animation:ambHintIn 1s 1.8s both;pointer-events:none;z-index:1;
}
@keyframes ambHintIn{from{opacity:0}to{opacity:1}}

/* â”€â”€ MISC â”€â”€ */
.heart{position:fixed;font-size:68px;pointer-events:none;z-index:999;transform:translate(-50%,-50%);animation:hpop .7s ease-out forwards;}
@keyframes hpop{0%{transform:translate(-50%,-50%) scale(0);opacity:1}50%{transform:translate(-50%,-50%) scale(1.3);opacity:1}100%{transform:translate(-50%,-60%) scale(1);opacity:0}}
.toast{
  position:fixed;bottom:68px;left:50%;transform:translateX(-50%);
  background:rgba(20,20,30,.96);border:1px solid var(--border);
  color:#fff;padding:9px 18px;border-radius:50px;
  font-size:13px;z-index:9999;pointer-events:none;animation:tin .22s ease;
}
@keyframes tin{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.err{position:relative;z-index:1;width:min(440px,88vw);padding:32px;text-align:center;background:var(--glass);backdrop-filter:blur(20px);border-radius:24px;border:1px solid rgba(239,68,68,.22);}
.err-ico{font-size:40px;margin-bottom:12px;}
.err-ttl{font-size:18px;font-weight:500;margin-bottom:8px;}
.err-msg{font-size:13px;color:var(--dim);line-height:1.6;margin-bottom:20px;}
.err-btn{padding:10px 24px;border:none;border-radius:12px;cursor:pointer;background:linear-gradient(135deg,var(--w1),var(--w2));color:#fff;font-size:14px;font-weight:600;font-family:'DM Sans',sans-serif;}
body.how .err-btn{background:linear-gradient(135deg,var(--h1),var(--h2));}

/* â”€â”€ META ROW (category tag + reading time) â”€â”€ */
.meta-row{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-shrink:0;flex-wrap:wrap;}
.cat-tag{
  display:inline-flex;align-items:center;gap:4px;
  font-size:10px;font-weight:600;letter-spacing:.4px;
  padding:3px 9px;border-radius:20px;
  background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);
  color:rgba(255,255,255,.65);
}
.read-time{
  font-size:11px;color:var(--dim);letter-spacing:.2px;
}

/* â”€â”€ KEYBOARD SHORTCUT BAR â”€â”€ */
.kb-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:200;
  display:none;align-items:center;justify-content:center;gap:20px;
  padding:10px 20px max(10px,env(safe-area-inset-bottom));
  background:linear-gradient(to top,rgba(7,7,13,.95) 60%,transparent);
  opacity:0;transition:opacity .3s;pointer-events:none;
}
.kb-bar.show{opacity:1;}
.kb-hint{display:flex;align-items:center;gap:6px;font-size:11px;color:rgba(255,255,255,.35);}
.kb-key{
  display:inline-flex;align-items:center;justify-content:center;
  min-width:22px;height:20px;padding:0 5px;
  border-radius:5px;border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.06);
  font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;
  color:rgba(255,255,255,.5);letter-spacing:.3px;
}
@media(min-width:601px){.kb-bar{display:flex;}}
@media(max-width:600px){.kb-bar{display:none !important;}}

/* â”€â”€ STREAK BADGE IN BURGER â”€â”€ */
.streak-row{
  display:flex;align-items:center;gap:8px;
  font-size:13px;color:rgba(255,255,255,.65);
}
.streak-fire{font-size:16px;line-height:1;}
.streak-num{font-weight:700;color:#fbbf24;}
.streak-label{font-size:11px;color:var(--dim);}

/* â”€â”€ BETA TAG â”€â”€ */
.beta-tag{
  display:inline-block;font-size:9px;font-weight:700;letter-spacing:.8px;
  text-transform:uppercase;padding:2px 6px;border-radius:6px;
  background:rgba(251,191,36,.15);color:#fbbf24;border:1px solid rgba(251,191,36,.25);
  vertical-align:middle;margin-left:6px;line-height:1.3;
}

/* â”€â”€ DEEPER BUTTON (rabbit hole) â”€â”€ */
.deeper-row{display:flex;flex-shrink:0;margin-top:8px;}
.act.deeper{
  flex:1;justify-content:center;gap:6px;
  padding:10px 16px;border-radius:12px;font-size:13px;
  background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.18);
  color:rgba(251,191,36,.85);
}
.act.deeper:hover{background:rgba(251,191,36,.12);}
.act.deeper.used{opacity:.4;pointer-events:none;}

/* â”€â”€ SHARE IMAGE OVERLAY â”€â”€ */
.share-img-overlay{
  position:fixed;inset:0;z-index:800;display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,.7);backdrop-filter:blur(6px);
}
.share-img-overlay.open{display:flex;}
.share-img-card{
  background:rgba(12,12,20,.98);border:1px solid var(--border);
  border-radius:20px;padding:24px;width:min(380px,90vw);text-align:center;
  animation:mshow .22s ease;
}
.share-img-preview{
  width:100%;border-radius:14px;margin-bottom:16px;
  box-shadow:0 8px 30px rgba(0,0,0,.5);
}
.share-img-actions{display:flex;gap:10px;justify-content:center;}
.share-img-btn{
  padding:10px 20px;border-radius:12px;border:1px solid var(--border);
  background:rgba(255,255,255,.07);color:#fff;cursor:pointer;
  font-size:13px;font-weight:500;font-family:'DM Sans',sans-serif;
  transition:background .2s;
}
.share-img-btn:hover{background:rgba(255,255,255,.14);}
.share-img-btn.primary{border:none;background:linear-gradient(135deg,var(--w1),var(--w2));font-weight:600;}
body.how .share-img-btn.primary{background:linear-gradient(135deg,var(--h1),var(--h2));}
.share-img-close{
  position:absolute;top:12px;right:14px;background:none;border:none;
  color:var(--dim);font-size:18px;cursor:pointer;
}

/* â”€â”€ SETTINGS PANEL (desktop) â”€â”€ */
.sp-backdrop{
  position:fixed;inset:0;z-index:399;
  background:rgba(0,0,0,.4);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
  opacity:0;pointer-events:none;
  transition:opacity .32s cubic-bezier(.4,0,.2,1);
}
.sp-backdrop.open{opacity:1;pointer-events:auto;}
.sp{
  position:fixed;top:0;right:-440px;width:420px;height:100vh;
  background:rgba(8,8,14,.97);backdrop-filter:blur(22px);
  border-left:1px solid var(--border);z-index:400;
  transition:right .32s cubic-bezier(.4,0,.2,1);overflow-y:auto;
  padding:max(84px,calc(env(safe-area-inset-top) + 70px)) 22px max(24px,env(safe-area-inset-bottom));
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.07) transparent;
}
.sp.open{right:0;}
.sp-hdr{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;}
.sp-x{font-size:20px;cursor:pointer;background:none;border:none;color:var(--dim);transition:color .2s;}
.sp-x:hover{color:#fff;}
.sp-section{margin-bottom:22px;}
.sp-section-title{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;color:rgba(255,255,255,.35);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;}
.sp-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 0;border-bottom:1px solid var(--border);
}
.sp-row:last-child{border-bottom:none;}
.sp-row-label{display:flex;align-items:center;gap:10px;color:rgba(255,255,255,.75);font-size:14px;font-weight:500;flex:1;min-width:0;}
.sp-row-label .ico{font-size:18px;line-height:1;flex-shrink:0;}
.sp-row-sub{font-size:11px;color:var(--dim);font-weight:400;margin-top:2px;}
.sp-about{
  margin-top:8px;padding:20px;border-radius:16px;
  background:rgba(255,255,255,.03);border:1px solid var(--border);
  text-align:center;
}
.sp-about-logo{
  font-family:'Syne',sans-serif;font-size:22px;font-weight:800;letter-spacing:-1px;
  background:linear-gradient(135deg,var(--w1),var(--w2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:10px;
}
body.how .sp-about-logo{
  background:linear-gradient(135deg,var(--h1),var(--h2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.sp-about-body{font-size:13px;line-height:1.7;color:rgba(255,255,255,.55);margin-bottom:10px;}
.sp-about-contact{font-size:11px;color:var(--dim);}

/* â”€â”€ DESKTOP SWIPE FLASH â”€â”€ */
.swipe-flash{
  position:absolute;inset:0;z-index:3;pointer-events:none;
  border-radius:0;opacity:0;
  transition:opacity .35s ease-out;
}
.swipe-flash.like{background:radial-gradient(ellipse at center,rgba(74,222,128,.18) 0%,transparent 70%);}
.swipe-flash.skip{background:radial-gradient(ellipse at center,rgba(248,113,113,.15) 0%,transparent 70%);}
.swipe-flash.show{opacity:1;}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:600px){
  .hdr{grid-template-columns:auto 1fr auto;}
  .logo{font-size:19px;}
  .tbtn{font-size:11px;padding:5px 10px;}
  .panel{width:93vw;max-height:86vh;padding:18px;border-radius:22px;}
  .art-title{font-size:19px;}
  .lp{width:100%;right:-100%;}
  .act{padding:12px 16px;font-size:14px;}
  .hdr-right > .lang-wrap,
  .hdr-right > #likesBtn,
  .hdr-right > #topicsBtn,
  .hdr-right > #settingsBtn{display:none;}
  .burger-btn{display:flex;}
  .card{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;}
  .card img{pointer-events:none;}
  .sp{width:100%;right:-100%;}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="hdr-left"><div class="logo">WikiScroll</div></div>
  <div class="hdr-mid">
    <div class="toggle">
      <button class="tbtn won on" id="wBtn">Wikipedia</button>
      <button class="tbtn" id="hBtn">Wikivoyage</button>
    </div>
  </div>
  <div class="hdr-right">
    <div class="lang-wrap">
      <button class="pill" id="langBtn"><span>ğŸŒ</span><span id="langTxt">English</span></button>
      <div class="lang-dd" id="langDd"></div>
    </div>
    <button class="pill" id="likesBtn">
      <span>â¤ï¸</span><span>Likes</span>
      <span class="badge" id="badge" style="display:none">0</span>
    </button>
    <button class="pill" id="topicsBtn">
      <span>ğŸ¯</span><span>Topics</span>
      <span class="badge topic-badge" id="topicBadge" style="display:none">0</span>
    </button>
    <button class="pill" id="settingsBtn"><span>âš™ï¸</span><span>Settings</span></button>
    <button class="burger-btn" id="burgerBtn" title="Menu">
      <span class="burger-dot" id="burgerDot"></span>
      <svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
        <line x1="2" y1="4.5" x2="16" y2="4.5"/>
        <line x1="2" y1="9" x2="16" y2="9"/>
        <line x1="2" y1="13.5" x2="16" y2="13.5"/>
      </svg>
    </button>
  </div>
</header>

<!-- MOBILE BURGER MENU -->
<div class="burger-menu" id="burgerMenu">
  <div class="burger-inner">
    <div class="burger-row">
      <div class="burger-row-label"><span class="ico">ğŸŒ</span><span id="burgerLangTxt">English</span></div>
      <button class="burger-action" id="burgerLangBtn">Change â€º</button>
    </div>
    <div class="burger-lang-grid" id="burgerLangGrid"></div>
    <div class="burger-row">
      <div class="burger-row-label"><span class="ico">ğŸ¯</span><span>Topics</span></div>
      <button class="burger-action" id="burgerTopicsBtn">Filter â€º</button>
    </div>
    <div class="burger-topics" id="burgerTopics">
      <div class="burger-topic-grid" id="burgerTopicGrid"></div>
    </div>
    <div class="burger-row">
      <div class="burger-row-label">
        <span class="ico">ğŸ‘†</span>
        <div><div>Swipe Gestures</div><div class="burger-row-sub">Left to skip Â· Right to like</div></div>
      </div>
      <button class="toggle-sw on" id="swipeToggle" role="switch" aria-label="Toggle swipe gestures"></button>
    </div>
    <div class="burger-row">
      <div class="burger-row-label">
        <span class="ico">ğŸ‡</span>
        <div><div>Rabbit Hole <span class="beta-tag">Beta</span></div><div class="burger-row-sub">Adds a "Go deeper" button to explore related articles from the one you're reading</div></div>
      </div>
      <button class="toggle-sw" id="rabbitToggle" role="switch" aria-label="Toggle rabbit hole mode"></button>
    </div>
    <div class="burger-row">
      <div class="burger-row-label"><span class="ico">â¤ï¸</span><span>Saved Articles</span></div>
      <button class="burger-action" id="burgerLikesBtn">
        View <span class="badge" id="burgerBadge" style="display:none">0</span>
      </button>
    </div>
    <div class="burger-row">
      <div class="burger-row-label"><span class="ico">â„¹ï¸</span><span>About</span></div>
      <button class="burger-action" id="burgerAboutBtn">Open â€º</button>
    </div>
    <div class="burger-row">
      <div class="burger-row-label"><span class="ico">ğŸ“Š</span><span>Today's Stats</span></div>
      <div class="streak-row" id="streakDisplay">
        <span class="streak-fire">ğŸ”¥</span>
        <span><span class="streak-num" id="streakCount">0</span> articles</span>
        <span class="streak-label" id="streakLabel"></span>
      </div>
    </div>
  </div>
</div>

<!-- TOPIC SHEET -->
<div class="sheet-overlay" id="sheetOverlay"></div>
<div class="topic-sheet" id="topicSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Topics</div>
  <div class="sheet-sub">Select topics to bias your feed. Leave all off for fully random.</div>
  <div class="topic-grid" id="topicGrid"></div>
  <button class="sheet-reset" id="sheetReset">Clear all topics</button>
</div>

<!-- LIKES PANEL -->
<div class="lp" id="lp">
  <div class="lp-hdr"><span>Saved Articles</span><button class="lp-x" id="lpClose">âœ•</button></div>
  <div id="likedList"></div>
</div>

<!-- FEED -->
<div class="feed" id="feed" tabindex="0">
  <div class="spin-wrap" id="spinner">
    <div class="spin"></div>
    <div class="spin-lbl">Loading articlesâ€¦</div>
  </div>
</div>

<!-- HINT -->
<div class="hint" id="hint">
  <div class="hint-txt">Scroll to discover</div>
  <div class="hint-arr"></div>
</div>

<!-- ABOUT MODAL -->
<div class="modal-overlay" id="aboutOverlay">
  <div class="modal">
    <button class="modal-close" id="modalClose">âœ•</button>
    <div class="modal-logo">WikiScroll</div>
    <div class="modal-body">
      Infinite scrolling through Wikipedia and Wikivoyage in multiple languages.<br><br>
      Swipe right to like Â· Left to skip Â· Long-press for Ambient Mode.
    </div>
    <div class="modal-contact">contact [at] wikiscroll.com</div>
  </div>
</div>

<!-- SETTINGS PANEL (desktop) -->
<div class="sp-backdrop" id="spBackdrop"></div>
<div class="sp" id="settingsPanel">
  <div class="sp-hdr"><span>Settings</span><button class="sp-x" id="spClose">âœ•</button></div>

  <div class="sp-section">
    <div class="sp-section-title">Gestures</div>
    <div class="sp-row">
      <div class="sp-row-label">
        <span class="ico">ğŸ‘†</span>
        <div><div>Swipe Gestures</div><div class="sp-row-sub">Left to skip Â· Right to like</div></div>
      </div>
      <button class="toggle-sw on" id="dkSwipeToggle" role="switch"></button>
    </div>
  </div>

  <div class="sp-section">
    <div class="sp-section-title">Features</div>
    <div class="sp-row">
      <div class="sp-row-label">
        <span class="ico">ğŸ‡</span>
        <div><div>Rabbit Hole <span class="beta-tag">Beta</span></div><div class="sp-row-sub">Adds a "Go deeper" button to explore related articles</div></div>
      </div>
      <button class="toggle-sw" id="dkRabbitToggle" role="switch"></button>
    </div>
    <div class="sp-row">
      <div class="sp-row-label">
        <span class="ico">âŒ¨ï¸</span>
        <div><div>Show Keyboard Hints</div><div class="sp-row-sub">Navigation bar at the bottom of the screen</div></div>
      </div>
      <button class="toggle-sw on" id="dkKbToggle" role="switch"></button>
    </div>
  </div>

  <div class="sp-section">
    <div class="sp-section-title">Stats</div>
    <div class="sp-row">
      <div class="sp-row-label">
        <span class="ico">ğŸ“Š</span><span>Today's Stats</span>
      </div>
      <div class="streak-row">
        <span class="streak-fire">ğŸ”¥</span>
        <span><span class="streak-num" id="dkStreakCount">0</span> articles</span>
        <span class="streak-label" id="dkStreakLabel"></span>
      </div>
    </div>
  </div>

  <div class="sp-section">
    <div class="sp-section-title">About</div>
    <div class="sp-about">
      <div class="sp-about-logo">WikiScroll</div>
      <div class="sp-about-body">
        Infinite scrolling through Wikipedia and Wikivoyage in multiple languages.<br><br>
        Swipe right to like Â· Left to skip Â· Long-press for Ambient Mode.
      </div>
      <div class="sp-about-contact">contact [at] wikiscroll.com</div>
    </div>
  </div>
</div>

<!-- AMBIENT OVERLAY -->
<div class="ambient-overlay" id="ambientOverlay">
  <div class="ambient-bg" id="ambientBg"></div>
  <div class="ambient-content">
    <div class="ambient-label">âœ¦ Ambient Mode</div>
    <div class="ambient-title" id="ambientTitle"></div>
    <div class="ambient-excerpt" id="ambientExcerpt"></div>
  </div>
  <button class="ambient-close" id="ambientClose">âœ•</button>
  <div class="ambient-hint">Tap anywhere to exit</div>
</div>

<!-- KEYBOARD SHORTCUT BAR (desktop only) -->
<div class="kb-bar" id="kbBar">
  <div class="kb-hint"><span class="kb-key">â†‘</span><span class="kb-key">â†“</span> Scroll</div>
  <div class="kb-hint"><span class="kb-key">â†</span><span class="kb-key">â†’</span> Swipe</div>
  <div class="kb-hint"><span class="kb-key">L</span> Like</div>
  <div class="kb-hint"><span class="kb-key">S</span> Share</div>
  <div class="kb-hint"><span class="kb-key">R</span> Read</div>
  <div class="kb-hint"><span class="kb-key">Space</span> Ambient</div>
  <div class="kb-hint"><span class="kb-key">Esc</span> Close</div>
</div>

<!-- SHARE AS IMAGE OVERLAY -->
<div class="share-img-overlay" id="shareImgOverlay">
  <div class="share-img-card" style="position:relative">
    <button class="share-img-close" id="shareImgClose">âœ•</button>
    <img class="share-img-preview" id="shareImgPreview" alt="Share card preview">
    <div class="share-img-actions">
      <button class="share-img-btn" id="shareImgDownload">ğŸ’¾ Save Image</button>
      <button class="share-img-btn primary" id="shareImgShare">ğŸ“¤ Share</button>
    </div>
  </div>
</div>

<script>
'use strict';

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LANGS = [
  {c:'en',n:'English',f:'ğŸ‡¬ğŸ‡§'},{c:'es',n:'EspaÃ±ol',f:'ğŸ‡ªğŸ‡¸'},
  {c:'fr',n:'FranÃ§ais',f:'ğŸ‡«ğŸ‡·'},{c:'de',n:'Deutsch',f:'ğŸ‡©ğŸ‡ª'},
  {c:'it',n:'Italiano',f:'ğŸ‡®ğŸ‡¹'},{c:'pt',n:'PortuguÃªs',f:'ğŸ‡µğŸ‡¹'},
  {c:'ru',n:'Ğ ÑƒÑÑĞºĞ¸Ğ¹',f:'ğŸ‡·ğŸ‡º'},{c:'ja',n:'æ—¥æœ¬èª',f:'ğŸ‡¯ğŸ‡µ'},
  {c:'zh',n:'ä¸­æ–‡',f:'ğŸ‡¨ğŸ‡³'},{c:'ar',n:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',f:'ğŸ‡¸ğŸ‡¦'},
  {c:'hi',n:'à¤¹à¤¿à¤¨à¥à¤¦à¥€',f:'ğŸ‡®ğŸ‡³'},{c:'ko',n:'í•œêµ­ì–´',f:'ğŸ‡°ğŸ‡·'},
  {c:'nl',n:'Nederlands',f:'ğŸ‡³ğŸ‡±'},{c:'pl',n:'Polski',f:'ğŸ‡µğŸ‡±'},
];

const TOPICS = [
  {
    id:'food',label:'Food',emoji:'ğŸ½ï¸',
    cats:['Category:Cheeses','Category:Cocktails','Category:Soups','Category:Breads','Category:Noodle dishes','Category:Rice dishes','Category:Chocolate','Category:Coffee','Category:Tea','Category:Sushi','Category:Stews','Category:Salads','Category:Cakes','Category:Cookies','Category:Pies','Category:Sauces','Category:Fermented foods','Category:Street food'],
    valid:/\b(dish|food|cuisine|ingredient|flavor|flavour|taste|cooked|eaten|recipe|meal|snack|drink|beverage|served|baked|fried|grilled|brewed|fermented|cheese|bread|pasta|meat|vegetable|fruit|spice|herb|sauce|soup|dessert|sweet|savoury|savory)\b/i,
    vCats:['Category:Food and drink','Category:Restaurants'],
  },
  {
    id:'science',label:'Science',emoji:'ğŸ”¬',
    cats:['Category:Chemical elements','Category:Constellations','Category:Exoplanets','Category:Minerals','Category:Mammals','Category:Birds','Category:Insects','Category:Fish','Category:Reptiles','Category:Amphibians','Category:Spiders','Category:Viruses','Category:Bacteria','Category:Fungi','Category:Mosses','Category:Orchids','Category:Subatomic particles','Category:Comets','Category:Asteroids'],
    valid:/\b(species|genus|family|order|class|element|compound|molecule|atom|particle|planet|star|galaxy|nebula|cell|protein|dna|rna|organism|native to|found in|named after|discovered|described by|scientific name|biology|chemistry|physics|astronomy|ecology|habitat|distribution)\b/i,
    vCats:['Category:Natural attractions','Category:National parks'],
  },
  {
    id:'history',label:'History',emoji:'ğŸ›ï¸',
    cats:['Category:Battles of World War II','Category:Battles of World War I','Category:Battles of the Napoleonic Wars','Category:Battles of the American Civil War','Category:Ancient Rome','Category:Ancient Egypt','Category:Ancient Greece','Category:Medieval castles','Category:Viking Age','Category:Crusades','Category:Byzantine Empire','Category:Ottoman Empire','Category:Mughal Empire','Category:Aztec','Category:Inca Empire','Category:Cold War'],
    valid:/\b(battle|war|siege|empire|kingdom|dynasty|ruled|conquered|revolt|revolution|treaty|medieval|ancient|century|\bbc\b|\bad\b|reign|fought|defeated|founded|established|occupation|invasion|rebellion|republic|pharaoh|emperor|general|army|navy|troops)\b/i,
    vCats:['Category:Historical sites','Category:Castles','Category:UNESCO World Heritage Sites'],
  },
  {
    id:'geo',label:'Geography',emoji:'ğŸŒ',
    cats:['Category:Islands of the Pacific Ocean','Category:Islands of the Atlantic Ocean','Category:Islands of the Indian Ocean','Category:Active volcanoes','Category:Mountain ranges','Category:Waterfalls','Category:Glaciers','Category:Deserts','Category:Caves','Category:Canyons','Category:Lagoons','Category:Atolls','Category:Peninsulas','Category:Straits','Category:Bays','Category:Rivers of Africa','Category:Rivers of Asia','Category:Rivers of South America'],
    valid:/\b(island|volcano|mountain|lake|river|ocean|sea|coast|peninsula|valley|glacier|desert|forest|national park|range|peak|summit|elevation|metres|meters|feet|kilometres|km|miles|located|situated|geography|terrain|climate|landscape|inlet|bay|strait|atoll|lagoon|cave|canyon|waterfall)\b/i,
    vCats:['Category:Islands','Category:National parks','Category:Natural attractions','Category:Mountains'],
  },
  {
    id:'arts',label:'Arts',emoji:'ğŸ¨',
    cats:['Category:Baroque paintings','Category:Renaissance paintings','Category:Impressionist paintings','Category:Operas','Category:Symphonies','Category:String quartets','Category:Gothic cathedrals','Category:Art Nouveau architecture','Category:Neoclassical architecture','Category:Modernist architecture','Category:Ancient Greek sculptures','Category:Ballet','Category:Silent films','Category:Jazz standards'],
    valid:/\b(painting|sculpture|architecture|composer|symphony|opera|ballet|novel|poem|film|director|musician|artist|gallery|museum|style|movement|genre|performed|written|painted|composed|concerto|sonata|fresco|mosaic|cathedral|palace|artwork|canvas|oil paint|watercolour|watercolor)\b/i,
    vCats:['Category:Museums','Category:Theatres','Category:Art galleries'],
  },
  {
    id:'tech',label:'Technology',emoji:'ğŸ’»',
    cats:['Category:Inventions by country','Category:Computing','Category:Aviation','Category:Spacecraft','Category:Rockets','Category:Bridges','Category:Tunnels','Category:Locomotives','Category:Motorcycles','Category:Cameras','Category:Telescopes','Category:Particle accelerators','Category:Nuclear reactors','Category:Radio telescopes','Category:Submarines'],
    valid:/\b(invented|invention|patent|engineer|machine|computer|software|hardware|technology|device|system|design|developed|processor|algorithm|network|digital|electric|mechanical|built|manufactured|aircraft|spacecraft|rocket|engine|motor|circuit|semiconductor|satellite|telescope|bridge|tunnel|locomotive)\b/i,
    vCats:['Category:Airports','Category:Bridges'],
  },
  {
    id:'people',label:'People',emoji:'ğŸ‘¤',
    cats:['Category:16th-century scientists','Category:17th-century scientists','Category:18th-century scientists','Category:19th-century scientists','Category:20th-century scientists','Category:Renaissance humanists','Category:Enlightenment philosophers','Category:Explorers of Africa','Category:Explorers of Asia','Category:Explorers of the Americas','Category:Women scientists','Category:Nobel laureates in Physics','Category:Nobel laureates in Chemistry','Category:Nobel laureates in Medicine'],
    valid:/\b(born|died|nationality|known for|notable|scientist|artist|philosopher|explorer|writer|inventor|leader|served as|worked as|educated|studied|mathematician|physician|biologist|chemist|physicist|astronomer|naturalist|theologian|statesman|admiral|general|discoverer)\b/i,
    vCats:[],
  },
  {
    id:'sports',label:'Sports',emoji:'âš½',
    cats:['Category:Athletics (track and field)','Category:Swimming','Category:Gymnastics','Category:Cycling','Category:Rowing','Category:Fencing','Category:Archery','Category:Weightlifting','Category:Wrestling','Category:Judo','Category:Karate','Category:Equestrian sports','Category:Sailing','Category:Shooting sports','Category:Bobsleigh','Category:Skiing','Category:Ice skating'],
    valid:/\b(sport|game|team|player|championship|tournament|league|match|athlete|olympic|medal|race|competition|played|competed|won|defeated|ranked|season|record|event|discipline|gold|silver|bronze|competing|coach|club|federation|world cup|grand prix)\b/i,
    vCats:['Category:Sports venues','Category:Stadiums'],
  },
];

const TOPIC_MAP     = Object.fromEntries(TOPICS.map(t => [t.id, t]));
const BAD_TITLE_RE  = /^(list of|lists of|timeline|history of|geography of|demographics|economy of|culture of|politics of|education in|deaths in|events of|index of|outline of|glossary|bibliography|filmography|discography|category:|talk:|wikipedia:)/i;
const GEO_RE        = /\b(city|town|village|municipality|district|region|province|state|country|island|archipelago|coast|peninsula|valley|mountain|lake|river|national park|nature reserve|capital|port|suburb|commune|department|prefecture|ward|borough|settlement|population|located in|situated in|lies in|part of)\b/i;
const NONPLACE_RE   = /\b(phrasebook|itinerary|travel topic|travel guide|travel warning|getting around|getting there|visa|currency|budget|accommodation|hostel|hotel tip|what to see|local cuisine|safety|scam)\b/i;

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let curMode = 'wiki', curLang = 'en';
let curTopics = new Set();
let swipeEnabled = true, rabbitHoleEnabled = false, kbBarEnabled = true;
let articles = [], liked = new Map(), queue = [];
let filling = false, hinted = false, sentinel = null;
let fillGeneration = 0;
let relatedInQueue = 0;
const MAX_RELATED_IN_QUEUE = 4;
const otdIds = new Set();

// â”€â”€ LOCALSTORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lsGet(k)    { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } }
function lsSet(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} }

function loadPersistedState() {
  const savedLikes = lsGet('ws_liked');
  if (Array.isArray(savedLikes)) { savedLikes.forEach(a => liked.set(a.id, a)); updateBadge(); }
  // Hydrate from IDB as fallback (e.g. localStorage cleared but IDB survives)
  IDB.getAll().then(items => {
    let changed = false;
    items.forEach(a => { if (!liked.has(a.id)) { liked.set(a.id, a); changed = true; } });
    if (changed) { saveLiked(); updateBadge(); }
  });
  const savedTopics = lsGet('ws_topics');
  if (Array.isArray(savedTopics)) { curTopics = new Set(savedTopics); updateTopicBadge(); }
  const settings = lsGet('ws_settings') || {};
  swipeEnabled = settings.swipe !== false;
  rabbitHoleEnabled = settings.rabbitHole === true;
  kbBarEnabled = settings.kbBar !== false;
  syncAllToggles();
}
function saveLiked()    { lsSet('ws_liked',    [...liked.values()]); }
function saveTopics()   { lsSet('ws_topics',   [...curTopics]); }
function saveSettings() { lsSet('ws_settings', { swipe: swipeEnabled, rabbitHole: rabbitHoleEnabled, kbBar: kbBarEnabled }); }

// â”€â”€ INDEXEDDB (offline cache for liked articles) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IDB = (() => {
  let db = null;
  const open = () => new Promise((res, rej) => {
    if (db) return res(db);
    const req = indexedDB.open('wikiscroll', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('articles', {keyPath:'id'});
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror   = () => rej();
  });
  const tx = async (mode, fn) => {
    try { const d = await open(); fn(d.transaction('articles', mode).objectStore('articles')); } catch(e) { console.warn('IDB operation failed:', e); }
  };
  return {
    put:    a  => tx('readwrite', s => s.put(a)),
    delete: id => tx('readwrite', s => s.delete(id)),
    getAll: () => open().then(d => new Promise((res) => {
        const req = d.transaction('articles','readonly').objectStore('articles').getAll();
        req.onsuccess = () => res(req.result || []);
        req.onerror   = () => res([]);
      })).catch(() => []),
  };
})();

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function stripHtml(s) { return String(s||'').replace(/<[^>]+>/g,''); }
function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t); setTimeout(() => t.remove(), 2200);
}
function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

// â”€â”€ AUTO-CATEGORY DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detectCategory(text) {
  const sample = (text||'').slice(0,600);
  for (const t of TOPICS) {
    if (t.valid && t.valid.test(sample)) return t;
  }
  return null;
}

// â”€â”€ READING TIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function readingTime(text) {
  const words = (text||'').trim().split(/\s+/).length;
  const mins = Math.max(1, Math.round(words / 200));
  return `${mins} min read`;
}

// â”€â”€ DAILY STATS / STREAK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayKey() { return new Date().toISOString().slice(0,10); }
function loadStats() {
  const s = lsGet('ws_stats') || { date:'', count:0, streak:0, lastDate:'' };
  const today = todayKey();
  if (s.date !== today) {
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
    const yKey = yesterday.toISOString().slice(0,10);
    s.streak = (s.date === yKey) ? s.streak + 1 : 1;
    s.lastDate = s.date;
    s.date = today;
    s.count = 0;
    lsSet('ws_stats', s);
  }
  return s;
}
function bumpStat() {
  const s = loadStats();
  s.count++;
  lsSet('ws_stats', s);
  syncStreakDisplay();
}
function syncStreakDisplay() {
  const s = loadStats();
  ['streakCount','dkStreakCount'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = s.count;
  });
  ['streakLabel','dkStreakLabel'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = s.streak > 1 ? `Â· ${s.streak}-day streak` : '';
  });
}

// â”€â”€ NETWORK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fetchOne(url) {
  const ac = new AbortController(), id = setTimeout(() => ac.abort(), 8000);
  return fetch(url, {signal:ac.signal}).then(r => r.ok ? r.json() : null).catch(() => null).finally(() => clearTimeout(id));
}
function toArticle(d, prefix) {
  return { id: prefix+d.pageid, src: prefix==='w'?'wiki':'how', title: d.title, body: d.extract, img: d.thumbnail?.source||'', url: d.content_urls?.desktop?.page||'#' };
}

// â”€â”€ ARTICLE VALIDATORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isValidTitle(t) { return t && !BAD_TITLE_RE.test(t.trim()); }
function isValidWikiPage(p, td) {
  if (!p?.thumbnail?.source) return false;
  const text = stripHtml(p.extract||'');
  if (text.length < 80 || !isValidTitle(p.title)) return false;
  if (td?.valid && !td.valid.test(text.slice(0,600))) return false;
  return true;
}
function wikiPageToArticle(p) {
  return { id:'w'+p.pageid, src:'wiki', title:p.title, body:stripHtml(p.extract||''), img:p.thumbnail.source, url:`https://en.wikipedia.org/wiki/${encodeURIComponent(p.title.replace(/ /g,'_'))}` };
}

// â”€â”€ FETCH FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWiki() {
  const url = `https://${curLang}.wikipedia.org/api/rest_v1/page/random/summary`;
  const all = await Promise.all(Array.from({length:12}, () => fetchOne(url)));
  return all.filter(d => d?.thumbnail?.source && d.extract?.length >= 80 && isValidTitle(d.title)).slice(0,5).map(d => toArticle(d,'w'));
}

async function fetchWikiByTopic() {
  const td = TOPIC_MAP[rand([...curTopics])];
  if (!td) return fetchWiki();
  for (let i=0; i<2; i++) {
    const cat = rand(td.cats);
    const url = ['https://en.wikipedia.org/w/api.php','?action=query','&generator=categorymembers',`&gcmtitle=${encodeURIComponent(cat)}`,'&gcmlimit=30','&gcmtype=page','&gcmnamespace=0','&prop=pageimages%7Cextracts','&exintro=1','&exchars=800','&piprop=thumbnail','&pithumbsize=500','&pilimit=30','&format=json','&origin=*'].join('');
    const data = await fetchOne(url);
    if (!data?.query?.pages) continue;
    const valid = Object.values(data.query.pages).filter(p => isValidWikiPage(p,td)).sort(() => Math.random()-.5).slice(0,5).map(wikiPageToArticle);
    if (valid.length >= 2) return valid;
  }
  return fetchWiki();
}

async function fetchVoyage() {
  const langs = curLang !== 'en' ? [curLang,'en'] : ['en'];
  for (const lang of langs) {
    // Topic-based Wikivoyage category fetch
    if (curTopics.size) {
      const vCats = [...curTopics].flatMap(tid => TOPIC_MAP[tid]?.vCats||[]);
      if (vCats.length) {
        const cat = rand(vCats);
        const url = ['https://en.wikivoyage.org/w/api.php','?action=query','&generator=categorymembers',`&gcmtitle=${encodeURIComponent(cat)}`,'&gcmlimit=25','&gcmtype=page','&gcmnamespace=0','&prop=pageimages%7Cextracts','&exintro=1','&exchars=600','&piprop=thumbnail','&pithumbsize=500','&pilimit=25','&format=json','&origin=*'].join('');
        const data = await fetchOne(url);
        if (data?.query?.pages) {
          const valid = Object.values(data.query.pages).filter(p => {
            if (!p?.thumbnail?.source || !isValidTitle(p.title)) return false;
            const s = stripHtml(p.extract||'').slice(0,500);
            return s.length >= 40 && GEO_RE.test(s) && !NONPLACE_RE.test(s);
          }).sort(() => Math.random()-.5).slice(0,5).map(p => ({
            id:'v'+p.pageid, src:'how', title:p.title, body:stripHtml(p.extract||''), img:p.thumbnail.source,
            url:`https://en.wikivoyage.org/wiki/${encodeURIComponent(p.title.replace(/ /g,'_'))}`,
          }));
          if (valid.length >= 2) return valid;
        }
      }
    }
    // Random fallback
    const url = `https://${lang}.wikivoyage.org/api/rest_v1/page/random/summary`;
    const all  = await Promise.all(Array.from({length:16}, () => fetchOne(url)));
    const good = all.filter(d => {
      if (!d?.thumbnail?.source || !isValidTitle(d.title) || d.extract?.length < 40) return false;
      const s = d.extract.slice(0,500);
      return GEO_RE.test(s) && !NONPLACE_RE.test(s);
    }).slice(0,5).map(d => toArticle(d,'v'));
    if (good.length) return good;
  }
  return [];
}

// â”€â”€ RABBIT HOLE: FETCH RELATED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchRelated(article) {
  if (article.src !== 'wiki') return [];
  // Use the Action API to get pages linked from this article, with extracts+thumbnails
  const title = encodeURIComponent(article.title.replace(/ /g, '_'));
  const url = [
    `https://${curLang}.wikipedia.org/w/api.php`,
    '?action=query',
    `&titles=${title}`,
    '&generator=links',
    '&gpllimit=30',
    '&gplnamespace=0',
    '&prop=pageimages%7Cextracts',
    '&exintro=1',
    '&exchars=800',
    '&piprop=thumbnail',
    '&pithumbsize=500',
    '&pilimit=30',
    '&format=json',
    '&origin=*',
  ].join('');
  const data = await fetchOne(url);
  if (!data?.query?.pages) return [];
  const seenIds = new Set(articles.map(a => a.id).concat(queue.map(a => a.id)));
  return Object.values(data.query.pages)
    .filter(p => p?.thumbnail?.source && isValidTitle(p.title) && !seenIds.has('w'+p.pageid))
    .filter(p => {
      const text = stripHtml(p.extract||'');
      return text.length >= 80;
    })
    .sort(() => Math.random() - 0.5)
    .slice(0, 3)
    .map(p => ({
      id: 'w'+p.pageid, src: 'wiki', title: p.title,
      body: stripHtml(p.extract||''),
      img: p.thumbnail.source,
      url: `https://${curLang}.wikipedia.org/wiki/${encodeURIComponent(p.title.replace(/ /g,'_'))}`,
      _related: true,
    }));
}

async function goDeeper(articleId, btn) {
  if (btn.classList.contains('used')) return;
  if (relatedInQueue >= MAX_RELATED_IN_QUEUE) {
    toast('Rabbit hole is full â€” scroll a bit first');
    return;
  }
  const a = articles.find(x => x.id === articleId);
  if (!a) return;
  btn.textContent = 'ğŸ‡ Diggingâ€¦';
  btn.style.pointerEvents = 'none';
  try {
    const related = await fetchRelated(a);
    if (!related.length) {
      toast('No related articles found');
      btn.textContent = 'ğŸ‡ Go deeper';
      btn.style.pointerEvents = '';
      return;
    }
    // Insert at positions 2-4 in the queue so there's a palette cleanser
    const insertAt = Math.min(2, queue.length);
    queue.splice(insertAt, 0, ...related);
    relatedInQueue += related.length;
    // Preload images
    related.forEach(art => { if (art.img) { const i = new Image(); i.src = art.img; } });
    btn.classList.add('used');
    btn.textContent = `ğŸ‡ ${related.length} added`;
    toast(`${related.length} related article${related.length>1?'s':''} queued`);
  } catch {
    btn.textContent = 'ğŸ‡ Go deeper';
    btn.style.pointerEvents = '';
    toast('Failed to fetch related articles');
  }
}

// â”€â”€ PREFETCH QUEUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const QUEUE_MIN = 8;
async function fillQueue() {
  if (filling) return; filling = true;
  const gen = fillGeneration;
  try {
    const fn = curMode === 'wiki' ? (curTopics.size ? fetchWikiByTopic : fetchWiki) : fetchVoyage;
    const [a, b] = await Promise.all([fn(), fn()]);
    if (gen !== fillGeneration) return; // stale â€” mode/lang changed while awaiting
    const fresh = [...a,...b];
    queue.push(...fresh);
    fresh.forEach(art => { if (art.img) { const i=new Image(); i.src=art.img; } });
  } finally { filling = false; }
}

function flushQueue(n) {
  const batch = queue.splice(0, n||5);
  if (!batch.length) return;
  batch.forEach(a => { if (a._related) relatedInQueue = Math.max(0, relatedInQueue-1); });
  articles.push(...batch);
  batch.forEach(renderCard);
  if (!hinted && articles.length >= 2) {
    hinted = true;
    const h = document.getElementById('hint');
    h.style.display = 'flex';
    setTimeout(() => { h.style.display='none'; }, 5500);
  }
  attachSentinel();
  if (queue.length < QUEUE_MIN) fillQueue();
}

function attachSentinel() {
  sentinel?.disconnect();
  const cards = document.getElementById('feed').querySelectorAll('.card');
  if (cards.length < 4) return;
  sentinel = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) { sentinel.disconnect(); flushQueue(5); }
  }, {rootMargin:'0px 0px 400% 0px'});
  sentinel.observe(cards[cards.length-4]);
}

// â”€â”€ DOM PRUNING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pruneOldCards() {
  const feed = document.getElementById('feed');
  const cards = feed.querySelectorAll('.card');
  const idx = Math.round(feed.scrollTop / window.innerHeight);
  let pruned = 0;
  cards.forEach((card, i) => {
    if (i < idx - 12) { card.remove(); pruned++; }
  });
  if (pruned) attachSentinel();
}
let pruneTimer = null;
document.getElementById('feed').addEventListener('scroll', () => {
  clearTimeout(pruneTimer);
  pruneTimer = setTimeout(pruneOldCards, 400);
}, {passive:true});

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
  fetchOnThisDay(); // fire and forget â€” populates otdIds in background
  try {
    await fillQueue();
    document.getElementById('spinner')?.remove();
    if (!queue.length) { showError(); return; }
    flushQueue(5);
  } catch(e) {
    console.error(e);
    document.getElementById('spinner')?.remove();
    showError();
  }
}

function resetFeed() {
  sentinel?.disconnect();
  fillGeneration++;
  articles=[]; queue=[]; hinted=false; filling=false; relatedInQueue=0;
  document.getElementById('hint').style.display = 'none';
  const isHow = curMode==='how';
  document.getElementById('feed').innerHTML = `<div class="spin-wrap" id="spinner"><div class="spin${isHow?' h':''}"></div><div class="spin-lbl">${isHow?'Loading destinationsâ€¦':'Loading articlesâ€¦'}</div></div>`;
  boot();
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCard(a) {
  const isHow   = a.src==='how', isLiked=liked.has(a.id);
  const pageid  = parseInt(a.id.slice(1));
  const isOTD   = a.src==='wiki' && otdIds.has(pageid);
  const img     = a.img ? `<img src="${esc(a.img)}" alt="" onerror="this.remove()">` : '';
  const artImg  = a.img ? `<img src="${esc(a.img)}" alt="" class="art-img" onerror="this.remove()">` : '';
  const cat     = detectCategory(a.body);
  const catHtml = cat ? `<span class="cat-tag">${cat.emoji} ${esc(cat.label)}</span>` : '';
  const rtHtml  = `<span class="read-time">â± ${readingTime(a.body)}</span>`;
  const card    = document.createElement('div');
  card.className = 'card'+(isHow?' how':'');
  card.dataset.id = a.id;
  card.innerHTML = `
    <div class="cbg">${img}<div class="cveil"></div></div>
    ${isOTD ? '<div class="otd-badge">ğŸ“… On This Day</div><div class="otd-star">â­</div>' : ''}
    <div class="swipe-ind like-ind">â¤ï¸ Like</div>
    <div class="swipe-ind skip-ind">âœ• Skip</div>
    <div class="panel">
      <div class="chip ${isHow?'h':'w'}">${isHow?'ğŸ—ºï¸ Wikivoyage':'ğŸ“– Wikipedia'}</div>
      ${artImg}
      <div class="meta-row">${catHtml}${rtHtml}</div>
      <h2 class="art-title"></h2>
      <p class="art-body"></p>
      <div class="acts">
        <button class="act${isLiked?' liked':''}" id="lb-${esc(a.id)}">${isLiked?'â¤ï¸ Liked':'ğŸ¤ Like'}</button>
        <button class="act">ğŸ“¤ Share</button>
        <button class="act cta${isHow?' hcta':''}">${isHow?'ğŸ“‹':'ğŸ“–'} Read Full Article</button>
      </div>
    </div>`;
  card.querySelector('.art-title').textContent = a.title;
  card.querySelector('.art-body').textContent  = a.body;
  const [likeBtn,shareBtn,readBtn] = card.querySelectorAll('.acts > .act');
  likeBtn.addEventListener('click',  () => toggleLike(a.id));
  shareBtn.addEventListener('click', () => doShare(a));
  readBtn.addEventListener('click',  () => window.open(a.url,'_blank'));
  // Rabbit Hole: add "Go deeper" button for wiki articles
  if (rabbitHoleEnabled && a.src === 'wiki') {
    const deeperRow = document.createElement('div');
    deeperRow.className = 'deeper-row';
    const deeperBtn = document.createElement('button');
    deeperBtn.className = 'act deeper';
    deeperBtn.textContent = 'ğŸ‡ Go deeper';
    deeperBtn.addEventListener('click', () => goDeeper(a.id, deeperBtn));
    deeperRow.appendChild(deeperBtn);
    card.querySelector('.panel').appendChild(deeperRow);
  }
  document.getElementById('feed').appendChild(card);
  bumpStat();
}

function showError() {
  const isHow = curMode==='how';
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<div class="cbg"><div class="cveil"></div></div><div class="err"><div class="err-ico">${isHow?'ğŸ—ºï¸':'ğŸ“–'}</div><div class="err-ttl">Nothing loaded</div><div class="err-msg">${isHow?'Wikivoyage':'Wikipedia'} didn't respond.</div><button class="err-btn">Try again</button></div>`;
  card.querySelector('.err-btn').addEventListener('click', resetFeed);
  document.getElementById('feed').appendChild(card);
}

// â”€â”€ LIKES + IDB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleLike(id) {
  const a = articles.find(x => x.id===id); if (!a) return;
  const wasLiked = liked.has(id);
  if (wasLiked) { liked.delete(id); IDB.delete(id); }
  else          { liked.set(id, a); IDB.put(a); }
  saveLiked(); updateBadge();
  const btn = document.getElementById('lb-'+id);
  if (btn) {
    const on = liked.has(id);
    if (on) {
      // Liking: instant class + text
      btn.className = 'act liked';
      btn.textContent = 'â¤ï¸ Liked';
    } else {
      // Unliking: remove class first (starts CSS transition), then swap text after a frame
      btn.className = 'act';
      requestAnimationFrame(() => { btn.textContent = 'ğŸ¤ Like'; });
    }
  }
}
function removeLike(id) {
  liked.delete(id); IDB.delete(id); saveLiked(); updateBadge();
  const btn = document.getElementById('lb-'+id);
  if (btn) { btn.className='act'; requestAnimationFrame(() => { btn.textContent='ğŸ¤ Like'; }); }
  renderLikedList();
}
function updateBadge() {
  const n = liked.size;
  ['badge','burgerBadge'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.textContent=n; el.style.display=n?'inline-block':'none'; }
  });
  const dot = document.getElementById('burgerDot');
  if (dot) dot.style.display = (n||curTopics.size) ? 'block' : 'none';
}
function updateTopicBadge() {
  const n = curTopics.size;
  const tb = document.getElementById('topicBadge');
  if (tb) { tb.textContent=n; tb.style.display=n?'inline-block':'none'; }
  const bb = document.getElementById('burgerTopicsBtn');
  if (bb) bb.className='burger-action'+(n?' active':'');
  const dtb = document.getElementById('topicsBtn');
  if (dtb) dtb.style.background = n?'rgba(102,126,234,.18)':'';
  const dot = document.getElementById('burgerDot');
  if (dot) dot.style.display = (liked.size||n) ? 'block' : 'none';
}

function renderLikedList() {
  const c = document.getElementById('likedList');
  if (!liked.size) {
    c.innerHTML = '<div class="empty"><div class="empty-ico">ğŸ”–</div><div class="empty-ttl">Nothing saved yet</div><div class="empty-txt">Like articles while scrolling to save them here. They\'ll be available offline too.</div></div>';
    return;
  }
  const offline = !navigator.onLine;
  c.innerHTML = [...liked.values()].reverse().map(a => `
    <div class="li">
      <div class="li-src">${a.src==='wiki'?'ğŸ“– Wikipedia':'ğŸ—ºï¸ Wikivoyage'}</div>
      ${offline ? '<div class="li-offline">âœ“ Available offline</div>' : ''}
      <div class="li-ttl">${esc(a.title)}</div>
      <div class="li-body">${esc(a.body.slice(0,130))}</div>
      <div class="li-acts">
        <button class="li-btn" data-read="${esc(a.url)}">Read</button>
        <button class="li-btn" data-share-url="${esc(a.url)}" data-share-title="${esc(a.title)}">Share</button>
        <button class="li-btn" data-unlike="${esc(a.id)}">Remove</button>
      </div>
    </div>`).join('');
}
document.getElementById('likedList').addEventListener('click', ev => {
  const btn = ev.target.closest('.li-btn'); if (!btn) return;
  if      (btn.dataset.read)     window.open(btn.dataset.read,'_blank');
  else if (btn.dataset.unlike)   removeLike(btn.dataset.unlike);
  else if (btn.dataset.shareUrl) doShare({url: btn.dataset.shareUrl, title: btn.dataset.shareTitle});
});

// â”€â”€ SHARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doShare(a) {
  // a can be an article object or {url, title} from liked list
  const url = a.url, title = a.title;
  if (!a.body) {
    // Simple share (from liked list with no body context)
    if (navigator.share) navigator.share({title,url}).catch(()=>{});
    else if (navigator.clipboard) navigator.clipboard.writeText(url).then(()=>toast('Link copied!')).catch(()=>{});
    return;
  }
  // Offer image share
  openShareImage(a);
}

function openShareImage(a) {
  const canvas = document.createElement('canvas');
  const W = 1080, H = 1350;
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d');

  // Background gradient
  const isHow = a.src === 'how';
  const grd = ctx.createLinearGradient(0, 0, W, H);
  if (isHow) { grd.addColorStop(0, '#0a1a18'); grd.addColorStop(0.5, '#0d2420'); grd.addColorStop(1, '#071510'); }
  else       { grd.addColorStop(0, '#0a0a18'); grd.addColorStop(0.5, '#141028'); grd.addColorStop(1, '#0d0820'); }
  ctx.fillStyle = grd;
  ctx.fillRect(0, 0, W, H);

  // Decorative gradient orbs
  const orb1 = ctx.createRadialGradient(W*0.25, H*0.2, 0, W*0.25, H*0.2, 400);
  orb1.addColorStop(0, isHow ? 'rgba(17,153,142,.15)' : 'rgba(102,126,234,.15)');
  orb1.addColorStop(1, 'transparent');
  ctx.fillStyle = orb1; ctx.fillRect(0, 0, W, H);
  const orb2 = ctx.createRadialGradient(W*0.8, H*0.7, 0, W*0.8, H*0.7, 350);
  orb2.addColorStop(0, isHow ? 'rgba(56,239,125,.08)' : 'rgba(118,75,162,.1)');
  orb2.addColorStop(1, 'transparent');
  ctx.fillStyle = orb2; ctx.fillRect(0, 0, W, H);

  // Source badge
  ctx.fillStyle = isHow ? 'rgba(17,153,142,.2)' : 'rgba(102,126,234,.2)';
  const badgeText = isHow ? 'ğŸ—ºï¸  WIKIVOYAGE' : 'ğŸ“–  WIKIPEDIA';
  ctx.font = '600 28px "DM Sans", sans-serif';
  const bw = ctx.measureText(badgeText).width + 48;
  const bx = (W - bw) / 2, by = 100;
  ctx.beginPath();
  ctx.roundRect(bx, by, bw, 52, 26);
  ctx.fill();
  ctx.fillStyle = isHow ? '#6ee7b7' : '#a5b4fc';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(badgeText, W/2, by+26);

  // Category tag
  const cat = detectCategory(a.body);
  if (cat) {
    ctx.font = '500 24px "DM Sans", sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,.35)';
    ctx.fillText(`${cat.emoji}  ${cat.label}`, W/2, by + 90);
  }

  // Title â€” word-wrap
  ctx.fillStyle = '#ffffff';
  ctx.font = '800 64px "Syne", sans-serif';
  ctx.textAlign = 'center';
  const titleY = cat ? 300 : 260;
  const titleLines = wrapText(ctx, a.title, W - 140, 64);
  titleLines.forEach((line, i) => {
    ctx.fillText(line, W/2, titleY + i * 78);
  });

  // Excerpt â€” word-wrap
  const excerptY = titleY + titleLines.length * 78 + 50;
  ctx.fillStyle = 'rgba(255,255,255,.55)';
  ctx.font = '400 30px "DM Sans", sans-serif';
  const bodyLines = wrapText(ctx, a.body.slice(0, 400), W - 140, 30);
  bodyLines.slice(0, 8).forEach((line, i) => {
    ctx.fillText(line, W/2, excerptY + i * 46);
  });

  // Bottom branding
  ctx.fillStyle = 'rgba(255,255,255,.2)';
  ctx.font = '700 26px "Syne", sans-serif';
  ctx.fillText('WikiScroll', W/2, H - 100);
  ctx.font = '400 20px "DM Sans", sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,.15)';
  ctx.fillText('wikiscroll.com', W/2, H - 65);

  // Divider line
  ctx.strokeStyle = 'rgba(255,255,255,.06)';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(W*0.3, H-130); ctx.lineTo(W*0.7, H-130); ctx.stroke();

  // Show preview
  const dataUrl = canvas.toDataURL('image/png');
  const preview = document.getElementById('shareImgPreview');
  preview.src = dataUrl;
  document.getElementById('shareImgOverlay').classList.add('open');
  // Store for share/download
  preview._canvas = canvas;
  preview._article = a;
}

function wrapText(ctx, text, maxW, fontSize) {
  const words = text.split(/\s+/);
  const lines = [];
  let cur = '';
  for (const w of words) {
    const test = cur ? cur + ' ' + w : w;
    if (ctx.measureText(test).width > maxW && cur) {
      lines.push(cur);
      cur = w;
    } else cur = test;
  }
  if (cur) lines.push(cur);
  return lines;
}

// Share image overlay events
document.getElementById('shareImgClose').addEventListener('click', () => {
  document.getElementById('shareImgOverlay').classList.remove('open');
});
document.getElementById('shareImgOverlay').addEventListener('click', ev => {
  if (ev.target === ev.currentTarget) ev.currentTarget.classList.remove('open');
});
document.getElementById('shareImgDownload').addEventListener('click', () => {
  const preview = document.getElementById('shareImgPreview');
  const link = document.createElement('a');
  link.download = `wikiscroll-${(preview._article?.title||'card').replace(/\s+/g,'-').slice(0,40)}.png`;
  link.href = preview.src;
  link.click();
  toast('Image saved!');
});
document.getElementById('shareImgShare').addEventListener('click', async () => {
  const preview = document.getElementById('shareImgPreview');
  const a = preview._article;
  if (navigator.share && navigator.canShare) {
    try {
      const blob = await new Promise(r => preview._canvas.toBlob(r, 'image/png'));
      const file = new File([blob], 'wikiscroll.png', {type:'image/png'});
      if (navigator.canShare({files:[file]})) {
        await navigator.share({title: a?.title||'WikiScroll', text: a?.title, url: a?.url, files:[file]});
      } else {
        await navigator.share({title: a?.title||'WikiScroll', url: a?.url});
      }
    } catch(e) { if (e.name!=='AbortError') toast('Share failed'); }
  } else if (a?.url) {
    if (navigator.clipboard) navigator.clipboard.writeText(a.url).then(()=>toast('Link copied!')).catch(()=>{});
  }
  document.getElementById('shareImgOverlay').classList.remove('open');
});

// â”€â”€ ON THIS DAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchOnThisDay() {
  try {
    const now = new Date();
    const data = await fetchOne(`https://en.wikipedia.org/api/rest_v1/feed/onthisday/events/${now.getMonth()+1}/${now.getDate()}`);
    (data?.events||[]).forEach(ev => (ev.pages||[]).forEach(p => { if (p.pageid) otdIds.add(p.pageid); }));
    // Badge any already-rendered cards that match
    document.getElementById('feed').querySelectorAll('.card').forEach(card => {
      const a = articles.find(x => x.id===card.dataset.id);
      if (a?.src==='wiki' && otdIds.has(parseInt(a.id.slice(1))) && !card.querySelector('.otd-badge')) {
        const badge = document.createElement('div');
        badge.className = 'otd-badge'; badge.textContent = 'ğŸ“… On This Day';
        card.appendChild(badge);
        const star = document.createElement('div');
        star.className = 'otd-star'; star.textContent = 'â­';
        card.appendChild(star);
      }
    });
  } catch {}
}

// â”€â”€ TOPICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTopicChips(container, cls) {
  container.innerHTML = TOPICS.map(t => `<button class="${cls}${curTopics.has(t.id)?' on':''}" data-tid="${t.id}">${t.emoji} ${t.label}</button>`).join('');
}
function toggleTopic(id) {
  curTopics.has(id) ? curTopics.delete(id) : curTopics.add(id);
  saveTopics(); updateTopicBadge();
  document.querySelectorAll('[data-tid]').forEach(el => el.classList.toggle('on', curTopics.has(el.dataset.tid)));
  resetFeed();
}

buildTopicChips(document.getElementById('topicGrid'),      'topic-chip');
buildTopicChips(document.getElementById('burgerTopicGrid'),'btopic');

document.getElementById('topicGrid').addEventListener('click', ev => {
  const c = ev.target.closest('.topic-chip'); if (c) toggleTopic(c.dataset.tid);
});
document.getElementById('burgerTopicGrid').addEventListener('click', ev => {
  const c = ev.target.closest('.btopic'); if (c) toggleTopic(c.dataset.tid);
});
document.getElementById('sheetReset').addEventListener('click', () => {
  curTopics.clear(); saveTopics(); updateTopicBadge();
  document.querySelectorAll('[data-tid]').forEach(el => el.classList.remove('on'));
  resetFeed();
});
function openTopicSheet()  { document.getElementById('topicSheet').classList.add('open');    document.getElementById('sheetOverlay').classList.add('open'); }
function closeTopicSheet() { document.getElementById('topicSheet').classList.remove('open'); document.getElementById('sheetOverlay').classList.remove('open'); }
document.getElementById('topicsBtn').addEventListener('click',    openTopicSheet);
document.getElementById('sheetOverlay').addEventListener('click', closeTopicSheet);

// â”€â”€ LANGUAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const desktopLangDd = document.getElementById('langDd');
const burgerLangGrid = document.getElementById('burgerLangGrid');

desktopLangDd.innerHTML  = LANGS.map(l => `<div class="lopt${l.c===curLang?' sel':''}" data-c="${l.c}">${l.f} ${l.n}</div>`).join('');
burgerLangGrid.innerHTML = LANGS.map(l => `<button class="blopt${l.c===curLang?' sel':''}" data-c="${l.c}">${l.f} ${l.n}</button>`).join('');

function setLang(c) {
  curLang = c;
  const lang = LANGS.find(l => l.c===c);
  if (lang) { document.getElementById('langTxt').textContent = lang.n; document.getElementById('burgerLangTxt').textContent = lang.n; }
  desktopLangDd.querySelectorAll('.lopt').forEach(o  => o.classList.toggle('sel',  o.dataset.c===curLang));
  burgerLangGrid.querySelectorAll('.blopt').forEach(o => o.classList.toggle('sel', o.dataset.c===curLang));
  resetFeed();
}

document.getElementById('langBtn').addEventListener('click', ev => { ev.stopPropagation(); desktopLangDd.classList.toggle('open'); });
desktopLangDd.addEventListener('click', ev => { const o=ev.target.closest('.lopt'); if(o){setLang(o.dataset.c);desktopLangDd.classList.remove('open');} });
document.addEventListener('click', ev => { if (!ev.target.closest('.lang-wrap')) desktopLangDd.classList.remove('open'); });

burgerLangGrid.addEventListener('click', ev => {
  const o = ev.target.closest('.blopt');
  if (!o) return;
  setLang(o.dataset.c);
  burgerLangGrid.classList.remove('open');
  document.getElementById('burgerLangBtn').textContent = 'Change â€º';
});
document.getElementById('burgerLangBtn').addEventListener('click', ev => {
  ev.stopPropagation();
  const isOpen = burgerLangGrid.classList.toggle('open');
  ev.currentTarget.textContent = isOpen ? 'Close âœ•' : 'Change â€º';
});

// â”€â”€ MODE TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMode(m) {
  if (curMode===m) return; curMode=m;
  const isHow = m==='how';
  document.getElementById('wBtn').className = 'tbtn'+(isHow?'':' won on');
  document.getElementById('hBtn').className = 'tbtn'+(isHow?' hon on':'');
  document.body.classList.toggle('how', isHow);
  resetFeed();
}
document.getElementById('wBtn').addEventListener('click', () => setMode('wiki'));
document.getElementById('hBtn').addEventListener('click', () => setMode('how'));

// â”€â”€ BURGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeBurger() {
  document.getElementById('burgerMenu').classList.remove('open');
  burgerLangGrid.classList.remove('open');
  document.getElementById('burgerLangBtn').textContent = 'Change â€º';
  document.getElementById('burgerTopics').classList.remove('open');
  document.getElementById('burgerTopicsBtn').textContent = 'Filter â€º';
}
document.getElementById('burgerBtn').addEventListener('click', ev => { ev.stopPropagation(); document.getElementById('burgerMenu').classList.toggle('open'); });
document.getElementById('burgerTopicsBtn').addEventListener('click', ev => {
  ev.stopPropagation();
  const isOpen = document.getElementById('burgerTopics').classList.toggle('open');
  ev.currentTarget.textContent = isOpen ? 'Close âœ•' : 'Filter â€º';
});
document.getElementById('burgerLikesBtn').addEventListener('click', () => { closeBurger(); document.getElementById('lp').classList.toggle('open'); renderLikedList(); });
document.getElementById('burgerAboutBtn').addEventListener('click', () => { closeBurger(); document.getElementById('aboutOverlay').classList.toggle('open'); });
document.addEventListener('click', ev => { if (!ev.target.closest('#burgerMenu')&&!ev.target.closest('#burgerBtn')) closeBurger(); });

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncAllToggles() {
  // Swipe â€” mobile + desktop
  document.getElementById('swipeToggle')?.classList.toggle('on', swipeEnabled);
  document.getElementById('dkSwipeToggle')?.classList.toggle('on', swipeEnabled);
  // Rabbit Hole â€” mobile + desktop
  document.getElementById('rabbitToggle')?.classList.toggle('on', rabbitHoleEnabled);
  document.getElementById('dkRabbitToggle')?.classList.toggle('on', rabbitHoleEnabled);
  // KB bar â€” desktop only
  document.getElementById('dkKbToggle')?.classList.toggle('on', kbBarEnabled);
}
function setSwipe(val) { swipeEnabled=val; saveSettings(); syncAllToggles(); }
function setRabbit(val) {
  rabbitHoleEnabled=val; saveSettings(); syncAllToggles();
  toast(rabbitHoleEnabled ? 'ğŸ‡ Rabbit Hole enabled' : 'Rabbit Hole disabled');
  if (rabbitHoleEnabled) resetFeed();
}
function setKbBar(val) { kbBarEnabled=val; saveSettings(); syncAllToggles(); }

// Mobile toggles
document.getElementById('swipeToggle').addEventListener('click', () => setSwipe(!swipeEnabled));
document.getElementById('rabbitToggle').addEventListener('click', () => setRabbit(!rabbitHoleEnabled));

// Desktop settings panel toggles
document.getElementById('dkSwipeToggle').addEventListener('click', () => setSwipe(!swipeEnabled));
document.getElementById('dkRabbitToggle').addEventListener('click', () => setRabbit(!rabbitHoleEnabled));
document.getElementById('dkKbToggle').addEventListener('click', () => setKbBar(!kbBarEnabled));

// Desktop settings panel open/close
function openSettings()  {
  document.getElementById('settingsPanel').classList.add('open');
  document.getElementById('spBackdrop').classList.add('open');
  syncStreakDisplay();
}
function closeSettings() {
  document.getElementById('settingsPanel').classList.remove('open');
  document.getElementById('spBackdrop').classList.remove('open');
}
document.getElementById('settingsBtn').addEventListener('click', () => {
  const panel = document.getElementById('settingsPanel');
  if (panel.classList.contains('open')) closeSettings();
  else openSettings();
});
document.getElementById('spClose').addEventListener('click', closeSettings);
document.getElementById('spBackdrop').addEventListener('click', closeSettings);

// â”€â”€ HEADER BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('likesBtn').addEventListener('click', () => { document.getElementById('lp').classList.toggle('open'); renderLikedList(); });
document.getElementById('lpClose').addEventListener('click',  () => document.getElementById('lp').classList.remove('open'));
document.getElementById('modalClose').addEventListener('click',() => document.getElementById('aboutOverlay').classList.remove('open'));
document.getElementById('aboutOverlay').addEventListener('click', function(ev) { if(ev.target===this) this.classList.remove('open'); });
document.addEventListener('keydown', ev => {
  if (ev.key!=='Escape') return;
  document.getElementById('aboutOverlay').classList.remove('open');
  document.getElementById('lp').classList.remove('open');
  document.getElementById('shareImgOverlay').classList.remove('open');
  closeSettings(); closeBurger(); closeTopicSheet(); closeAmbient();
  document.getElementById('feed').focus();
});

// â”€â”€ AMBIENT MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAmbient(card) {
  const a = articles.find(x => x.id===card.dataset.id); if (!a) return;
  document.getElementById('ambientTitle').textContent   = a.title;
  document.getElementById('ambientExcerpt').textContent = a.body;
  const bg = document.getElementById('ambientBg');
  bg.style.backgroundImage = a.img ? `url("${a.img.replace(/[\\"()]/g, '\\$&')}")` : '';
  const ov = document.getElementById('ambientOverlay');
  ov.classList.remove('closing'); ov.classList.add('open');
}

function closeAmbient() {
  const ov = document.getElementById('ambientOverlay');
  if (!ov.classList.contains('open')) return;
  ov.classList.add('closing');
  ov.addEventListener('animationend', () => {
    ov.classList.remove('open','closing');
    document.getElementById('feed').focus();
  }, {once:true});
}

document.getElementById('ambientOverlay').addEventListener('click', ev => {
  if (!ev.target.closest('.ambient-content,.ambient-close')) closeAmbient();
});
document.getElementById('ambientClose').addEventListener('click', closeAmbient);

// â”€â”€ SWIPE GESTURES + LONG PRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const feed = document.getElementById('feed');
  let startX=0, startY=0, curDx=0;
  let activeCard=null, swiping=false, lpTimer=null;

  function curCard() {
    const idx = Math.round(feed.scrollTop/window.innerHeight);
    return feed.querySelectorAll('.card')[idx]||null;
  }
  function ind(card, cls) { return card?.querySelector('.'+cls); }

  function applyDrag(card, dx) {
    card.style.transform  = `translateX(${dx}px) rotate(${dx*0.055}deg)`;
    card.style.transition = 'none';
    const p = Math.min(Math.abs(dx)/95,1);
    const li = ind(card,'like-ind'), si = ind(card,'skip-ind');
    if (dx>0) { if(li)li.style.opacity=p; if(si)si.style.opacity=0; }
    else       { if(si)si.style.opacity=p; if(li)li.style.opacity=0; }
  }

  function springBack(card) {
    card.style.transition='transform .38s cubic-bezier(.25,1,.5,1)';
    card.style.transform='';
    ['like-ind','skip-ind'].forEach(c=>{const el=ind(card,c);if(el)el.style.opacity=0;});
  }

  function flyOff(card, dir) {
    // Smoother desktop animation: longer duration, gentler curve, less extreme rotation
    const isTouch = 'ontouchstart' in window;
    const dur = isTouch ? '.2s' : '.35s';
    const dist = isTouch ? 150 : 120;
    const rot = isTouch ? 25 : 14;
    card.style.transition = `transform ${dur} cubic-bezier(.4,0,.2,1),opacity ${dur}`;
    card.style.transform  = `translateX(${dir>0?dist:-dist}vw) rotate(${dir>0?rot:-rot}deg)`;
    card.style.opacity    = '0';
    if (dir>0) toggleLike(card.dataset.id);

    // Desktop flash feedback on the NEXT card
    if (!isTouch) {
      const nextIdx = Math.round(feed.scrollTop/window.innerHeight) + 1;
      const nextCard = feed.querySelectorAll('.card')[nextIdx];
      if (nextCard) {
        let flash = nextCard.querySelector('.swipe-flash');
        if (!flash) {
          flash = document.createElement('div');
          flash.className = 'swipe-flash';
          nextCard.appendChild(flash);
        }
        flash.classList.remove('like','skip','show');
        void flash.offsetWidth; // force reflow
        flash.classList.add(dir>0?'like':'skip','show');
        setTimeout(() => flash.classList.remove('show'), 500);
      }
    }

    const scrollDelay = isTouch ? 195 : 280;
    const resetDelay = isTouch ? 420 : 500;
    setTimeout(() => {
      feed.scrollBy({top:window.innerHeight, behavior:'smooth'});
      setTimeout(()=>{ card.style.transform=''; card.style.opacity=''; springBack(card); }, resetDelay);
    }, scrollDelay);
  }

  document.addEventListener('touchstart', ev => {
    if (ev.touches.length>1) return;
    const card = ev.target.closest('.card');
    if (!card || ev.target.closest('button,.acts')) return;
    startX=ev.touches[0].clientX; startY=ev.touches[0].clientY;
    curDx=0; swiping=false; activeCard=card;
    lpTimer = setTimeout(()=>{ if(!swiping){ openAmbient(card); activeCard=null; } lpTimer=null; },620);
  },{passive:true});

  document.addEventListener('touchmove', ev => {
    if (!activeCard) return;
    const dx=ev.touches[0].clientX-startX, dy=ev.touches[0].clientY-startY;
    if (!swiping) {
      if (Math.abs(dy)>Math.abs(dx)+8) { clearTimeout(lpTimer); activeCard=null; return; }
      if (Math.abs(dx)>10) { swiping=true; clearTimeout(lpTimer); }
      else return;
    }
    if (activeCard!==curCard()) { springBack(activeCard); activeCard=null; return; }
    curDx=dx;
    if (swipeEnabled && ev.cancelable) { applyDrag(activeCard,curDx); ev.preventDefault(); }
  },{passive:false});

  document.addEventListener('touchend', ()=>{
    clearTimeout(lpTimer);
    if (!activeCard||!swiping) { activeCard=null; swiping=false; return; }
    const card=activeCard; activeCard=null; swiping=false;
    if (swipeEnabled && Math.abs(curDx)>90) flyOff(card, curDx>0?1:-1);
    else springBack(card);
  },{passive:true});

  // Desktop keyboard shortcuts
  document.addEventListener('keydown', ev => {
    if (ev.target.closest('input,textarea')) return;

    // Space always toggles ambient regardless of focus
    if (ev.key === ' ') {
      ev.preventDefault();
      const ov = document.getElementById('ambientOverlay');
      if (ov.classList.contains('open')) { closeAmbient(); return; }
      const card = curCard();
      if (card) openAmbient(card);
      return;
    }

    // Don't process other shortcuts when focused on a button
    if (ev.target.closest('button')) return;

    // Arrow up/down for vertical scrolling
    if (ev.key === 'ArrowDown') {
      ev.preventDefault();
      feed.scrollBy({top:window.innerHeight, behavior:'smooth'});
      return;
    }
    if (ev.key === 'ArrowUp') {
      ev.preventDefault();
      feed.scrollBy({top:-window.innerHeight, behavior:'smooth'});
      return;
    }

    const card = curCard(); if (!card) return;
    const id = card.dataset.id;
    switch(ev.key) {
      case 'ArrowLeft':  flyOff(card, -1); break;
      case 'ArrowRight': flyOff(card,  1); break;
      case 'l': case 'L': toggleLike(id); break;
      case 's': case 'S': {
        const a = articles.find(x => x.id===id);
        if (a) doShare(a);
        break;
      }
      case 'r': case 'R': {
        const a = articles.find(x => x.id===id);
        if (a) window.open(a.url, '_blank');
        break;
      }
    }
  });
})();

// â”€â”€ KEYBOARD BAR (desktop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const bar = document.getElementById('kbBar');
  if (!bar || 'ontouchstart' in window) return;
  let hideTimer = null;
  function showBar() {
    if (!kbBarEnabled) { bar.classList.remove('show'); return; }
    bar.classList.add('show');
    clearTimeout(hideTimer);
    hideTimer = setTimeout(() => bar.classList.remove('show'), 4000);
  }
  showBar();
  document.addEventListener('mousemove', showBar);
  document.addEventListener('keydown', showBar);
  // Watch for setting changes
  new MutationObserver(() => {
    if (!kbBarEnabled) bar.classList.remove('show');
  }).observe(bar, {attributes:true, attributeFilter:['class']});
})();

// â”€â”€ DOUBLE-TAP TO LIKE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  let lt=0,lx=0,ly=0,zoomed=false;
  const unzoom=()=>setTimeout(()=>{zoomed=false;},1200);
  if(window.visualViewport){window.visualViewport.addEventListener('resize',()=>{if(window.visualViewport.scale>1.05){zoomed=true;lt=0;unzoom();}});}
  document.addEventListener('touchstart',ev=>{
    if(ev.touches.length>1){zoomed=true;lt=0;unzoom();return;}
    if(zoomed){lt=0;return;}
    const card=ev.target.closest('.card');
    if(!card||ev.target.closest('button,.acts,.cbg')){lt=0;return;}
    const now=Date.now(),x=ev.touches[0].clientX,y=ev.touches[0].clientY;
    if(now-lt<340&&Math.hypot(x-lx,y-ly)<40){
      ev.preventDefault();
      toggleLike(card.dataset.id);
      const h=document.createElement('div');h.className='heart';h.textContent='â¤ï¸';
      h.style.cssText=`left:${x}px;top:${y}px`;
      document.body.appendChild(h);setTimeout(()=>h.remove(),750);lt=0;
    }else{lt=now;lx=x;ly=y;}
  },{passive:false});
})();

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadPersistedState();
syncStreakDisplay();
boot();
// Auto-focus feed so arrow keys work immediately on desktop
requestAnimationFrame(() => document.getElementById('feed').focus());
</script>
</body>
</html>
