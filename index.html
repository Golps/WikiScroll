<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WikiScroll — Discover Random Wikipedia Articles in a TikTok-Style Feed</title>
<meta name="description" content="Swipe through random Wikipedia and Wikivoyage articles in a beautiful, infinite feed. Free, no ads, no tracking. 14 languages, offline support, topic filtering. Like TikTok for learning.">
<meta name="keywords" content="Wikipedia reader, Wikivoyage, infinite scroll, random Wikipedia articles, learn something new, TikTok for learning, Wikipedia app, educational app, knowledge discovery, free learning, random knowledge, Wikipedia browser, travel articles">
<meta name="author" content="WikiScroll">
<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
<meta name="googlebot" content="index, follow, max-image-preview:large, max-snippet:-1">
<meta name="bingbot" content="index, follow">
<link rel="canonical" href="https://wikiscroll.com/">
<meta name="theme-color" content="#07070d" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#f4f3ef" media="(prefers-color-scheme: light)">
<meta name="color-scheme" content="dark light">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WikiScroll">
<meta name="application-name" content="WikiScroll">
<meta name="mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">

<!-- Hreflang for multilingual signals -->
<link rel="alternate" hreflang="en" href="https://wikiscroll.com/">
<link rel="alternate" hreflang="es" href="https://wikiscroll.com/?lang=es">
<link rel="alternate" hreflang="fr" href="https://wikiscroll.com/?lang=fr">
<link rel="alternate" hreflang="de" href="https://wikiscroll.com/?lang=de">
<link rel="alternate" hreflang="ja" href="https://wikiscroll.com/?lang=ja">
<link rel="alternate" hreflang="zh" href="https://wikiscroll.com/?lang=zh">
<link rel="alternate" hreflang="x-default" href="https://wikiscroll.com/">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://wikiscroll.com/">
<meta property="og:title" content="WikiScroll — Random Wikipedia Articles, Beautifully Delivered">
<meta property="og:description" content="Swipe through random Wikipedia and Wikivoyage articles in a beautiful, TikTok-style feed. Free, private, works offline. Learn something new every scroll.">
<meta property="og:image" content="https://wikiscroll.com/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="WikiScroll — Discover Wikipedia like never before">
<meta property="og:site_name" content="WikiScroll">
<meta property="og:locale" content="en_US">
<meta property="og:locale:alternate" content="es_ES">
<meta property="og:locale:alternate" content="fr_FR">
<meta property="og:locale:alternate" content="de_DE">
<meta property="og:locale:alternate" content="ja_JP">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="WikiScroll — Random Wikipedia Articles, Beautifully Delivered">
<meta name="twitter:description" content="Swipe through random Wikipedia and Wikivoyage articles in a beautiful feed. Free, no ads, no tracking. Like TikTok for learning.">
<meta name="twitter:image" content="https://wikiscroll.com/og-image.png">
<meta name="twitter:image:alt" content="WikiScroll — Discover Wikipedia like never before">
<meta name="twitter:creator" content="@wikiscroll">

<!-- iMessage / Rich Link -->
<meta name="apple-itunes-app" content="app-argument=https://wikiscroll.com/">

<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "WikiScroll",
  "alternateName": "WikiScroll — Random Wikipedia Reader",
  "url": "https://wikiscroll.com",
  "description": "Infinite scrolling through Wikipedia and Wikivoyage articles in multiple languages. Discover random knowledge in a beautiful, swipeable feed — like TikTok for learning.",
  "applicationCategory": "EducationalApplication",
  "applicationSubCategory": "Knowledge Discovery",
  "operatingSystem": "Any",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD", "availability": "https://schema.org/InStock" },
  "author": { "@type": "Organization", "name": "WikiScroll", "url": "https://wikiscroll.com" },
  "publisher": { "@type": "Organization", "name": "WikiScroll", "url": "https://wikiscroll.com", "logo": { "@type": "ImageObject", "url": "https://wikiscroll.com/icon-512.png" } },
  "browserRequirements": "Requires JavaScript. Works in Chrome, Firefox, Safari, Edge.",
  "softwareVersion": "3.0",
  "datePublished": "2026-02-01",
  "dateModified": "2026-02-25",
  "screenshot": "https://wikiscroll.com/og-image.png",
  "image": "https://wikiscroll.com/og-image.png",
  "featureList": "Infinite scroll Wikipedia articles, Wikivoyage travel guides, 14 languages, 8 topic categories, swipe gestures, ambient reading mode, offline support, reading history, collections, share as image, interactive map explorer, reading streaks, article depth slider, keyboard shortcuts, Progressive Web App",
  "keywords": "Wikipedia, Wikivoyage, infinite scroll, random articles, learning, discovery, knowledge, educational app, PWA, TikTok for learning",
  "inLanguage": ["en","es","fr","de","it","pt","ru","ja","zh","ar","hi","ko","nl","pl"],
  "isAccessibleForFree": true,
  "permissions": "no special permissions required",
  "isAccessibleForFree": true
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "What is WikiScroll?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "WikiScroll is a free web app that presents random Wikipedia and Wikivoyage articles in an infinite, swipeable feed — like TikTok for learning. Swipe right to save articles, left to skip, and explore 14 languages and 8 topic categories."
      }
    },
    {
      "@type": "Question",
      "name": "Is WikiScroll free to use?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes, WikiScroll is completely free with no ads, no tracking, and no account required. All data stays on your device."
      }
    },
    {
      "@type": "Question",
      "name": "Does WikiScroll work offline?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes, WikiScroll is a Progressive Web App (PWA) with offline support. Previously viewed and liked articles are cached and available without an internet connection. You can install it on your home screen for a native app-like experience."
      }
    },
    {
      "@type": "Question",
      "name": "What languages does WikiScroll support?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "WikiScroll supports 14 languages: English, Spanish, French, German, Italian, Portuguese, Russian, Japanese, Chinese, Arabic, Hindi, Korean, Dutch, and Polish."
      }
    },
    {
      "@type": "Question",
      "name": "How do I install WikiScroll on my phone?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "WikiScroll is a Progressive Web App. On iPhone, tap the Share button in Safari and select 'Add to Home Screen'. On Android, tap the three-dot menu in Chrome and select 'Install app' or 'Add to Home Screen'."
      }
    },
    {
      "@type": "Question",
      "name": "Can I filter articles by topic?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes. WikiScroll offers 8 topic categories: Science, History, Geography, Food, Arts & Culture, Technology, Sports, and People. You can select one or more topics to curate your feed."
      }
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "WikiScroll", "item": "https://wikiscroll.com/" }
  ]
}
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3bA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjfqERvhDMj2QIo7uo2djIo40UWE8w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style>
:root{
  --w1:#667eea;--w2:#764ba2;
  --h1:#11998e;--h2:#38ef7d;
  --glass:rgba(10,10,18,.87);
  --border:rgba(255,255,255,.09);
  --dim:rgba(255,255,255,.48);
  --vh:100vh;
}
@supports (height:100dvh) { :root{--vh:100dvh;} }
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-overflow-scrolling:touch;}
body{font-family:'DM Sans',sans-serif;background:#07070d;color:#fff;}

/* ── HEADER ── */
.hdr{
  position:fixed;top:0;left:0;right:0;z-index:300;
  display:grid;grid-template-columns:1fr auto 1fr;
  align-items:center;gap:8px;
  padding:max(13px,env(safe-area-inset-top)) 16px 13px;
  background:linear-gradient(to bottom,rgba(7,7,13,.97) 60%,transparent);
}
.hdr-left,.hdr-mid,.hdr-right{display:flex;align-items:center;}
.hdr-left{justify-content:flex-start;}
.hdr-mid{justify-content:center;}
.hdr-right{justify-content:flex-end;gap:7px;}
.logo{
  font-family:'Syne',sans-serif;font-size:22px;font-weight:800;letter-spacing:-1px;
  background:linear-gradient(135deg,var(--w1),var(--w2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  white-space:nowrap;
}
body.how .logo{
  background:linear-gradient(135deg,var(--h1),var(--h2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}

/* ── TOGGLE ── */
.toggle{
  display:flex;background:rgba(255,255,255,.06);
  border:1px solid var(--border);border-radius:50px;padding:3px;gap:2px;
}
.tbtn{
  font-family:'Syne',sans-serif;font-size:12px;font-weight:700;
  padding:6px 14px;border-radius:50px;border:none;cursor:pointer;
  background:transparent;color:var(--dim);transition:all .22s;white-space:nowrap;
}
.tbtn.on{color:#fff;}
.tbtn.won{background:linear-gradient(135deg,var(--w1),var(--w2));box-shadow:0 2px 12px rgba(102,126,234,.4);}
.tbtn.hon{background:linear-gradient(135deg,var(--h1),var(--h2));box-shadow:0 2px 12px rgba(56,239,125,.25);}

/* ── PILLS / BADGES ── */
.pill{
  display:flex;align-items:center;gap:6px;padding:6px 13px;height:32px;
  background:rgba(255,255,255,.07);border:1px solid var(--border);border-radius:50px;
  color:#fff;cursor:pointer;font-size:12px;font-weight:500;
  transition:background .2s;white-space:nowrap;font-family:'DM Sans',sans-serif;flex-shrink:0;
}
.pill:hover{background:rgba(255,255,255,.13);}
.badge{font-size:10px;font-weight:700;padding:1px 5px;border-radius:20px;background:var(--w2);line-height:1.4;}
body.how .badge{background:var(--h1);}
.topic-badge{background:var(--w1);}

/* ── DESKTOP LANG DROPDOWN ── */
.lang-wrap{position:relative;}
.lang-dd{
  position:absolute;top:calc(100% + 8px);right:0;
  background:rgba(12,12,20,.98);border:1px solid var(--border);
  border-radius:16px;padding:6px;min-width:185px;
  display:none;max-height:360px;overflow-y:auto;
  box-shadow:0 20px 60px rgba(0,0,0,.7);z-index:400;
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.08) transparent;
}
.lang-dd.open{display:block;}
.lopt{
  padding:9px 12px;cursor:pointer;border-radius:10px;
  display:flex;align-items:center;gap:9px;
  font-size:13px;color:rgba(255,255,255,.8);transition:background .15s;
}
.lopt:hover,.lopt.sel{background:rgba(255,255,255,.08);}

/* ── HAMBURGER BTN ── */
.burger-btn{
  display:none;align-items:center;justify-content:center;
  width:36px;height:36px;border-radius:50%;
  background:rgba(255,255,255,.07);border:1px solid var(--border);
  cursor:pointer;flex-shrink:0;position:relative;transition:background .2s;
}
.burger-btn:hover{background:rgba(255,255,255,.13);}
.burger-btn svg{width:18px;height:18px;display:block;}
.burger-dot{
  position:absolute;top:-3px;right:-3px;width:8px;height:8px;
  border-radius:50%;background:var(--w1);display:none;
}
body.how .burger-dot{background:var(--h1);}

/* ── BURGER MENU ── */
.burger-backdrop{
  position:fixed;inset:0;z-index:298;
  background:rgba(0,0,0,.4);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  opacity:0;pointer-events:none;
  transition:opacity .3s cubic-bezier(.4,0,.2,1);
}
.burger-backdrop.open{opacity:1;pointer-events:auto;}
.burger-menu{
  position:fixed;top:0;left:0;right:0;z-index:299;
  background:rgba(7,7,13,.99);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  max-height:0;overflow:hidden;
  transition:max-height .3s cubic-bezier(.4,0,.2,1);
}
.burger-menu.open{max-height:100dvh;overflow-y:auto;}
.burger-inner{
  padding:calc(max(13px,env(safe-area-inset-top)) + 60px) 18px calc(18px + env(safe-area-inset-bottom));
}
.burger-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 0;border-bottom:1px solid var(--border);
}
.burger-row:last-child{border-bottom:none;padding-bottom:0;}
.burger-row-label{display:flex;align-items:center;gap:10px;color:rgba(255,255,255,.75);font-size:14px;font-weight:500;}
.burger-row-label .ico{font-size:18px;line-height:1;}
.burger-row-sub{font-size:11px;color:var(--dim);font-weight:400;margin-top:2px;}
.burger-action{
  display:flex;align-items:center;gap:7px;padding:7px 14px;border-radius:50px;
  background:rgba(255,255,255,.07);border:1px solid var(--border);
  color:#fff;cursor:pointer;font-size:12px;font-weight:500;
  font-family:'DM Sans',sans-serif;transition:background .2s;white-space:nowrap;
}
.burger-action:hover{background:rgba(255,255,255,.13);}
.burger-action.active{background:rgba(102,126,234,.18);border-color:rgba(102,126,234,.35);color:#a5b4fc;}

/* ── INLINE LANG GRID (mobile) ── */
.burger-lang-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:7px;
  max-height:0;overflow:hidden;
  transition:max-height .25s ease,padding .25s ease;padding:0;
}
.burger-lang-grid.open{max-height:340px;padding:10px 0 4px;}
.blopt{
  display:flex;align-items:center;gap:8px;padding:10px 12px;
  border-radius:12px;background:rgba(255,255,255,.05);
  border:1px solid var(--border);color:rgba(255,255,255,.8);
  cursor:pointer;font-size:13px;transition:background .15s,border-color .15s;
}
.blopt:hover{background:rgba(255,255,255,.1);}
.blopt.sel{background:rgba(102,126,234,.15);border-color:rgba(102,126,234,.35);color:#c4ccf5;}

/* ── INLINE TOPIC CHIPS (mobile) ── */
.burger-topics{
  max-height:0;overflow:hidden;
  transition:max-height .25s ease,padding .25s ease;padding:0;
}
.burger-topics.open{max-height:280px;padding:10px 0 4px;}
.burger-topic-grid{display:flex;flex-wrap:wrap;gap:7px;}
.btopic{
  display:flex;align-items:center;gap:6px;padding:8px 13px;
  border-radius:50px;background:rgba(255,255,255,.05);
  border:1px solid var(--border);color:rgba(255,255,255,.75);
  cursor:pointer;font-size:12px;font-weight:500;
  transition:background .15s,border-color .15s;
}
.btopic:hover{background:rgba(255,255,255,.1);}
.btopic.on{background:rgba(102,126,234,.18);border-color:rgba(102,126,234,.4);color:#a5b4fc;}

/* ── TOGGLE SWITCH ── */
.toggle-sw{
  width:44px;height:24px;border-radius:12px;border:none;
  background:rgba(255,255,255,.15);cursor:pointer;position:relative;
  transition:background .2s;flex-shrink:0;
}
.toggle-sw::after{
  content:'';position:absolute;top:2px;left:2px;
  width:20px;height:20px;border-radius:50%;
  background:#fff;transition:transform .2s;
  box-shadow:0 1px 4px rgba(0,0,0,.3);
}
.toggle-sw.on{background:var(--w1);}
body.how .toggle-sw.on{background:var(--h1);}
.toggle-sw.on::after{transform:translateX(20px);}

/* ── TOPIC SHEET ── */
.sheet-overlay{
  position:fixed;inset:0;z-index:480;background:rgba(0,0,0,.5);
  display:none;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
}
.sheet-overlay.open{display:block;}
.topic-sheet{
  position:fixed;bottom:-100%;left:0;right:0;z-index:490;
  background:rgba(8,8,14,.98);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid var(--border);border-radius:24px 24px 0 0;
  padding:0 24px calc(24px + env(safe-area-inset-bottom));
  transition:bottom .32s cubic-bezier(.4,0,.2,1);
  max-height:55vh;overflow-y:auto;
}
.topic-sheet.open{bottom:0;}
.sheet-handle{width:36px;height:4px;background:rgba(255,255,255,.14);border-radius:2px;margin:16px auto 20px;}
.sheet-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:6px;}
.sheet-sub{font-size:13px;color:var(--dim);margin-bottom:20px;line-height:1.5;}
.topic-grid{display:flex;flex-wrap:wrap;gap:10px;}
.topic-chip{
  display:flex;align-items:center;gap:8px;padding:11px 18px;
  border-radius:50px;border:1px solid var(--border);
  background:rgba(255,255,255,.06);color:rgba(255,255,255,.8);
  cursor:pointer;font-size:14px;font-weight:500;transition:all .18s;
}
.topic-chip:hover{background:rgba(255,255,255,.11);}
.topic-chip.on{background:rgba(102,126,234,.2);border-color:rgba(102,126,234,.45);color:#b8c2f8;}
.sheet-reset{
  margin-top:18px;padding:10px 22px;border-radius:50px;border:1px solid var(--border);
  background:transparent;color:var(--dim);cursor:pointer;font-size:13px;
  font-family:'DM Sans',sans-serif;transition:all .18s;
}
.sheet-reset:hover{background:rgba(255,255,255,.07);color:#fff;}

/* ── MODAL ── */
.modal-overlay{
  position:fixed;inset:0;z-index:500;display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,.6);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
}
.modal-overlay.open{display:flex;}
.modal{
  width:min(420px,88vw);background:rgba(12,12,20,.98);
  border:1px solid var(--border);border-radius:24px;padding:32px;
  box-shadow:0 30px 80px rgba(0,0,0,.7);text-align:center;position:relative;
  animation:mshow .22s ease;
}
@keyframes mshow{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.modal-close{
  position:absolute;top:16px;right:18px;font-size:18px;cursor:pointer;
  background:none;border:none;color:var(--dim);transition:color .2s;
}
.modal-close:hover{color:#fff;}
.modal-logo{
  font-family:'Syne',sans-serif;font-size:26px;font-weight:800;letter-spacing:-1px;
  background:linear-gradient(135deg,var(--w1),var(--w2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:14px;
}
.modal-body{font-size:14px;line-height:1.7;color:rgba(255,255,255,.72);margin-bottom:18px;}
.modal-contact{font-size:12px;color:var(--dim);}
.modal-contact a{color:#a5b4fc;text-decoration:none;}

/* ── FEED / CARDS ── */
.feed{
  height:var(--vh);overflow-y:scroll;scroll-snap-type:y mandatory;-webkit-scroll-snap-type:y mandatory;
  scrollbar-width:none;-ms-overflow-style:none;
  touch-action:pan-y;-webkit-overflow-scrolling:touch;
  outline:none;
}
.feed::-webkit-scrollbar{display:none;}
.card{
  height:var(--vh);scroll-snap-align:start;position:relative;
  display:flex;align-items:center;justify-content:center;
  background:#07070d;overflow:hidden;
  will-change:transform,opacity;transform:translateZ(0);
  content-visibility:auto;contain-intrinsic-size:100vw var(--vh);
}
.cbg{position:absolute;inset:0;z-index:0;}
.cbg img{width:100%;height:100%;object-fit:cover;opacity:.45;filter:blur(28px) saturate(1.6);transform:scale(1.12) translateZ(0);}
.cveil{
  position:absolute;inset:0;
  background:rgba(7,7,13,.45),
    radial-gradient(ellipse at 30% 30%,rgba(102,126,234,.1) 0%,transparent 60%),
    radial-gradient(ellipse at 75% 75%,rgba(118,75,162,.07) 0%,transparent 55%);
}
.card.how .cveil{
  background:rgba(7,7,13,.45),
    radial-gradient(ellipse at 30% 30%,rgba(17,153,142,.1) 0%,transparent 60%),
    radial-gradient(ellipse at 75% 75%,rgba(56,239,125,.06) 0%,transparent 55%);
}

/* ── SWIPE INDICATORS ── */
.swipe-ind{
  position:absolute;z-index:2;top:50%;transform:translateY(-50%);
  font-family:'Syne',sans-serif;font-weight:800;font-size:22px;letter-spacing:.5px;
  padding:12px 22px;border-radius:16px;border:3px solid;
  opacity:0;pointer-events:none;transition:opacity .08s;
  text-shadow:0 2px 8px rgba(0,0,0,.5);
  background:rgba(0,0,0,.25);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
}
.like-ind{left:22px;color:#4ade80;border-color:#4ade80;transform:translateY(-50%) rotate(-14deg);}
.skip-ind{right:22px;color:#f87171;border-color:#f87171;transform:translateY(-50%) rotate(14deg);}

/* ── OTD BADGE ── */
.otd-badge{
  position:absolute;z-index:2;
  top:max(68px,calc(env(safe-area-inset-top) + 56px));
  left:50%;transform:translateX(-50%);
  display:flex;align-items:center;gap:6px;white-space:nowrap;
  padding:5px 14px;border-radius:50px;
  background:rgba(251,191,36,.14);border:1px solid rgba(251,191,36,.38);
  color:#fcd34d;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;
  letter-spacing:.8px;pointer-events:none;
}
.otd-star{
  position:absolute;z-index:2;
  top:max(66px,calc(env(safe-area-inset-top) + 54px));
  right:14px;
  font-size:28px;pointer-events:none;
  filter:drop-shadow(0 2px 8px rgba(251,191,36,.5));
  animation:otdPulse 2.5s ease-in-out infinite;
}
@keyframes otdPulse{0%,100%{opacity:.85;transform:scale(1)}50%{opacity:1;transform:scale(1.12)}}

/* ── PANEL ── */
.panel{
  position:relative;z-index:1;width:min(660px,90vw);max-height:74vh;padding:24px;
  background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-radius:26px;border:1px solid var(--border);
  box-shadow:0 30px 80px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.05);
  display:flex;flex-direction:column;overflow:hidden;
}
.chip{
  display:inline-flex;align-items:center;gap:5px;
  font-family:'Syne',sans-serif;font-size:10px;font-weight:700;
  letter-spacing:1.1px;text-transform:uppercase;
  padding:3px 10px;border-radius:20px;margin-bottom:14px;width:fit-content;flex-shrink:0;
}
.chip.w{background:rgba(102,126,234,.16);color:#a5b4fc;border:1px solid rgba(102,126,234,.22);}
.chip.h{background:rgba(17,153,142,.15);color:#6ee7b7;border:1px solid rgba(17,153,142,.22);}
.art-img{width:100%;max-height:220px;object-fit:contain;border-radius:16px;margin-bottom:14px;flex-shrink:0;background:rgba(0,0,0,.25);}
.art-title{
  font-family:'Syne',sans-serif;font-size:21px;font-weight:700;
  line-height:1.22;letter-spacing:-.4px;margin-bottom:10px;flex-shrink:0;
  overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
}
.art-body{
  font-size:14px;line-height:1.65;color:rgba(255,255,255,.73);
  flex-shrink:1;min-height:0;margin-bottom:18px;
  overflow:hidden;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;
}
.acts{display:flex;gap:10px;flex-shrink:0;flex-wrap:nowrap;margin-top:auto;}
.act{
  display:flex;align-items:center;gap:8px;padding:14px 20px;border-radius:14px;
  border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.07);
  color:#fff;cursor:pointer;font-size:15px;font-weight:500;
  transition:background .25s ease,border-color .25s ease,color .25s ease,opacity .1s;
  white-space:nowrap;font-family:'DM Sans',sans-serif;
  -webkit-tap-highlight-color:transparent;
  overflow:hidden;outline:none;
}
.act:hover{background:rgba(255,255,255,.13);}
.act:active{opacity:.75;}
.act:focus-visible{box-shadow:0 0 0 2px rgba(102,126,234,.5);}
.act.liked{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35);color:#fca5a5;}
.act.cta{flex:1;justify-content:center;border:none;font-weight:600;background:linear-gradient(135deg,var(--w1),var(--w2));}
.act.cta.hcta{background:linear-gradient(135deg,var(--h1),var(--h2));}
.act.cta:hover{filter:brightness(1.1);}

/* ── SPINNER ── */
.spin-wrap{height:var(--vh);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;}
.spin{width:42px;height:42px;border:3px solid rgba(255,255,255,.07);border-top-color:var(--w1);border-radius:50%;animation:rot .85s linear infinite;}
.spin.h{border-top-color:var(--h1);}
.spin-lbl{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:.5px;color:var(--dim);}
@keyframes rot{to{transform:rotate(360deg);}}

/* ── HINT ── */
.hint{
  position:fixed;left:50%;z-index:100;
  bottom:max(26px,calc(env(safe-area-inset-bottom) + 12px));
  display:none;flex-direction:column;align-items:center;gap:6px;pointer-events:none;
  animation:hshow .4s .3s both,hbounce 2s .7s infinite;
}
@keyframes hshow{from{opacity:0}to{opacity:1}}
@keyframes hbounce{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-8px)}}
.hint-txt{font-size:11px;color:var(--dim);letter-spacing:.4px;}
.hint-arr{width:16px;height:16px;border-right:2px solid var(--dim);border-bottom:2px solid var(--dim);transform:rotate(45deg);}

/* ── LIKES PANEL ── */
.lp{
  position:fixed;top:0;right:-430px;width:420px;height:var(--vh);
  background:rgba(8,8,14,.97);backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);
  border-left:1px solid var(--border);z-index:400;
  transition:right .32s cubic-bezier(.4,0,.2,1);overflow-y:auto;
  padding:max(84px,calc(env(safe-area-inset-top) + 70px)) 18px max(24px,env(safe-area-inset-bottom));
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.07) transparent;
}
.lp.open{right:0;}
.lp-hdr{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center;}
.lp-x{font-size:20px;cursor:pointer;background:none;border:none;color:var(--dim);transition:color .2s;}
.lp-x:hover{color:#fff;}
.li{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;}
.li-src{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;opacity:.5;margin-bottom:4px;}
.li-offline{font-size:10px;color:#4ade80;opacity:.7;margin-bottom:4px;display:flex;align-items:center;gap:4px;}
.li-ttl{font-family:'Syne',sans-serif;font-size:14px;font-weight:600;margin-bottom:5px;line-height:1.3;}
.li-body{font-size:12px;color:var(--dim);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;margin-bottom:9px;}
.li-acts{display:flex;gap:7px;}
.li-btn{font-size:11px;padding:4px 11px;background:rgba(255,255,255,.07);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,.8);cursor:pointer;transition:background .18s;}
.li-btn:hover{background:rgba(255,255,255,.14);}
.empty{text-align:center;padding:44px 20px;color:var(--dim);}
.empty-ico{font-size:42px;margin-bottom:12px;}
.empty-ttl{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:rgba(255,255,255,.6);margin-bottom:6px;}
.empty-txt{font-size:13px;line-height:1.6;}

/* ── AMBIENT MODE ── */
.ambient-overlay{
  position:fixed;inset:0;z-index:700;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:rgba(0,0,0,0);
  pointer-events:none;visibility:hidden;
  transition:background .35s ease, visibility 0s .35s;
}
.ambient-overlay.open{
  background:rgba(0,0,0,.88);
  pointer-events:auto;visibility:visible;
  transition:background .35s ease, visibility 0s 0s;
}
.ambient-bg{
  position:absolute;inset:-40px;z-index:0;
  background-size:cover;background-position:center;
  filter:blur(48px) saturate(1.5) brightness(.4);
  transform:scale(1.08) translateZ(0);
  opacity:0;
  transition:opacity .4s ease;
}
.ambient-overlay.open .ambient-bg{opacity:1;}
.ambient-content{
  position:relative;z-index:1;text-align:center;
  padding:40px 32px;max-width:min(620px,90vw);max-height:80vh;overflow-y:auto;
  pointer-events:auto;
  opacity:0;transform:translateY(20px);
  transition:opacity .3s ease .05s, transform .3s cubic-bezier(.4,0,.2,1) .05s;
  scrollbar-width:none;-ms-overflow-style:none;
}
.ambient-content::-webkit-scrollbar{display:none;}
.ambient-overlay.open .ambient-content{opacity:1;transform:translateY(0);}
.ambient-label{
  font-family:'Syne',sans-serif;font-size:11px;font-weight:700;
  letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,.35);margin-bottom:28px;
}
.ambient-title{
  font-family:'Syne',sans-serif;
  font-size:clamp(28px,5.5vw,56px);
  font-weight:800;line-height:1.08;letter-spacing:-1.5px;
  color:#fff;margin-bottom:24px;
  text-shadow:0 4px 40px rgba(0,0,0,.6);
}
.ambient-excerpt{
  font-size:15px;line-height:1.75;color:rgba(255,255,255,.52);
  display:-webkit-box;-webkit-line-clamp:12;-webkit-box-orient:vertical;overflow:hidden;
}
.ambient-close{
  position:absolute;top:max(20px,env(safe-area-inset-top));right:20px;z-index:2;
  width:44px;height:44px;border-radius:50%;
  background:rgba(255,255,255,.09);border:1px solid rgba(255,255,255,.12);
  cursor:pointer;color:#fff;font-size:18px;
  display:flex;align-items:center;justify-content:center;
  opacity:0;transition:opacity .3s .1s, background .2s;
}
.ambient-close:hover{background:rgba(255,255,255,.18);}
.ambient-overlay.open .ambient-close{opacity:1;}
.ambient-hint{
  position:absolute;bottom:max(28px,env(safe-area-inset-bottom));
  font-size:11px;color:rgba(255,255,255,.28);letter-spacing:.5px;
  opacity:0;transition:opacity .4s .6s;pointer-events:none;z-index:1;
}
.ambient-overlay.open .ambient-hint{opacity:1;}

/* ── MISC ── */
.heart{position:fixed;font-size:68px;pointer-events:none;z-index:999;transform:translate(-50%,-50%);animation:hpop .7s ease-out forwards;}
@keyframes hpop{0%{transform:translate(-50%,-50%) scale(0);opacity:1}50%{transform:translate(-50%,-50%) scale(1.3);opacity:1}100%{transform:translate(-50%,-60%) scale(1);opacity:0}}
.toast{
  position:fixed;bottom:68px;left:50%;transform:translateX(-50%);
  background:rgba(20,20,30,.96);border:1px solid var(--border);
  color:#fff;padding:9px 18px;border-radius:50px;
  font-size:13px;z-index:9999;pointer-events:none;animation:tin .22s ease;
}
@keyframes tin{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.err{position:relative;z-index:1;width:min(440px,88vw);padding:32px;text-align:center;background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:24px;border:1px solid rgba(239,68,68,.22);}
.err-ico{font-size:40px;margin-bottom:12px;}
.err-ttl{font-size:18px;font-weight:500;margin-bottom:8px;}
.err-msg{font-size:13px;color:var(--dim);line-height:1.6;margin-bottom:20px;}
.err-btn{padding:10px 24px;border:none;border-radius:12px;cursor:pointer;background:linear-gradient(135deg,var(--w1),var(--w2));color:#fff;font-size:14px;font-weight:600;font-family:'DM Sans',sans-serif;}
body.how .err-btn{background:linear-gradient(135deg,var(--h1),var(--h2));}

/* ── META ROW (category tag + reading time) ── */
.meta-row{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-shrink:0;flex-wrap:wrap;}
.cat-tag{
  display:inline-flex;align-items:center;gap:4px;
  font-size:10px;font-weight:600;letter-spacing:.4px;
  padding:3px 9px;border-radius:20px;
  background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);
  color:rgba(255,255,255,.65);
}
.read-time{
  font-size:11px;color:var(--dim);letter-spacing:.2px;
}

/* ── KEYBOARD SHORTCUT BAR ── */
.kb-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:200;
  display:none;align-items:center;justify-content:center;gap:20px;
  padding:10px 20px max(10px,env(safe-area-inset-bottom));
  background:linear-gradient(to top,rgba(7,7,13,.95) 60%,transparent);
  opacity:0;transition:opacity .3s;pointer-events:none;
}
.kb-bar.show{opacity:1;}
.kb-hint{display:flex;align-items:center;gap:6px;font-size:11px;color:rgba(255,255,255,.35);}
.kb-key{
  display:inline-flex;align-items:center;justify-content:center;
  min-width:22px;height:20px;padding:0 5px;
  border-radius:5px;border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.06);
  font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;
  color:rgba(255,255,255,.5);letter-spacing:.3px;
}
@media(min-width:601px){.kb-bar{display:flex;}}
@media(max-width:600px){.kb-bar{display:none !important;}}

/* ── STREAK BADGE IN BURGER ── */
.streak-row{
  display:flex;align-items:center;gap:8px;
  font-size:13px;color:rgba(255,255,255,.65);
}
.streak-fire{font-size:16px;line-height:1;}
.streak-num{font-weight:700;color:#fbbf24;}
.streak-label{font-size:11px;color:var(--dim);}

/* ── BETA TAG ── */
.beta-tag{
  display:inline-block;font-size:9px;font-weight:700;letter-spacing:.8px;
  text-transform:uppercase;padding:2px 6px;border-radius:6px;
  background:rgba(251,191,36,.15);color:#fbbf24;border:1px solid rgba(251,191,36,.25);
  vertical-align:middle;margin-left:6px;line-height:1.3;
}

/* ── DEEPER BUTTON (rabbit hole) ── */
.deeper-row{display:flex;flex-shrink:0;margin-top:8px;}
.act.deeper{
  flex:1;justify-content:center;gap:6px;
  padding:10px 16px;border-radius:12px;font-size:13px;
  background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.18);
  color:rgba(251,191,36,.85);
}
.act.deeper:hover{background:rgba(251,191,36,.12);}
.act.deeper.used{opacity:.4;pointer-events:none;}

/* ── SHARE IMAGE OVERLAY ── */
.share-img-overlay{
  position:fixed;inset:0;z-index:800;display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,.7);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
}
.share-img-overlay.open{display:flex;}
.share-img-card{
  background:rgba(12,12,20,.98);border:1px solid var(--border);
  border-radius:20px;padding:24px;width:min(380px,90vw);text-align:center;
  animation:mshow .22s ease;
}
.share-img-preview{
  width:100%;border-radius:14px;margin-bottom:16px;
  box-shadow:0 8px 30px rgba(0,0,0,.5);
}
.share-img-actions{display:flex;gap:10px;justify-content:center;}
.share-img-btn{
  padding:10px 20px;border-radius:12px;border:1px solid var(--border);
  background:rgba(255,255,255,.07);color:#fff;cursor:pointer;
  font-size:13px;font-weight:500;font-family:'DM Sans',sans-serif;
  transition:background .2s;
}
.share-img-btn:hover{background:rgba(255,255,255,.14);}
.share-img-btn.primary{border:none;background:linear-gradient(135deg,var(--w1),var(--w2));font-weight:600;}
body.how .share-img-btn.primary{background:linear-gradient(135deg,var(--h1),var(--h2));}
.share-img-close{
  position:absolute;top:12px;right:14px;background:none;border:none;
  color:var(--dim);font-size:18px;cursor:pointer;
}

/* ── SETTINGS PANEL (desktop) ── */
.sp-backdrop{
  position:fixed;inset:0;z-index:399;
  background:rgba(0,0,0,.4);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
  opacity:0;pointer-events:none;
  transition:opacity .32s cubic-bezier(.4,0,.2,1);
}
.sp-backdrop.open{opacity:1;pointer-events:auto;}
.sp{
  position:fixed;top:0;right:-440px;width:420px;height:var(--vh);
  background:rgba(8,8,14,.97);backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);
  border-left:1px solid var(--border);z-index:400;
  transition:right .32s cubic-bezier(.4,0,.2,1);overflow-y:auto;
  padding:max(84px,calc(env(safe-area-inset-top) + 70px)) 22px max(24px,env(safe-area-inset-bottom));
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.07) transparent;
}
.sp.open{right:0;}
.sp-hdr{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;}
.sp-x{font-size:20px;cursor:pointer;background:none;border:none;color:var(--dim);transition:color .2s;}
.sp-x:hover{color:#fff;}
.sp-section{margin-bottom:22px;}
.sp-section-title{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;color:rgba(255,255,255,.35);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;}
.sp-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 0;border-bottom:1px solid var(--border);
}
.sp-row:last-child{border-bottom:none;}
.sp-row-label{display:flex;align-items:center;gap:10px;color:rgba(255,255,255,.75);font-size:14px;font-weight:500;flex:1;min-width:0;}
.sp-row-label .ico{font-size:18px;line-height:1;flex-shrink:0;}
.sp-row-sub{font-size:11px;color:var(--dim);font-weight:400;margin-top:2px;}
.sp-about{
  margin-top:8px;padding:20px;border-radius:16px;
  background:rgba(255,255,255,.03);border:1px solid var(--border);
  text-align:center;
}
.sp-about-logo{
  font-family:'Syne',sans-serif;font-size:22px;font-weight:800;letter-spacing:-1px;
  background:linear-gradient(135deg,var(--w1),var(--w2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:10px;
}
body.how .sp-about-logo{
  background:linear-gradient(135deg,var(--h1),var(--h2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.sp-about-body{font-size:13px;line-height:1.7;color:rgba(255,255,255,.55);margin-bottom:10px;}
.sp-about-contact{font-size:11px;color:var(--dim);}

/* ── DESKTOP SWIPE FLASH ── */
.swipe-flash{
  position:absolute;inset:0;z-index:3;pointer-events:none;
  border-radius:0;opacity:0;
  transition:opacity .4s ease-out;
}
.swipe-flash.like{
  background:radial-gradient(ellipse at center,rgba(74,222,128,.2) 0%,transparent 65%);
  box-shadow:inset 0 0 80px rgba(74,222,128,.08);
}
.swipe-flash.skip{
  background:radial-gradient(ellipse at center,rgba(248,113,113,.18) 0%,transparent 65%);
  box-shadow:inset 0 0 80px rgba(248,113,113,.06);
}
.swipe-flash.show{opacity:1;}


/* ── LIGHT THEME ── */
body.light{background:#f4f3ef;color:#1a1a2e;}
body.light .hdr{background:linear-gradient(to bottom,rgba(244,243,239,.97) 60%,transparent);}
body.light .logo{background:linear-gradient(135deg,#4a5ad8,#6b3fa0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
body.light .toggle{background:rgba(0,0,0,.06);border-color:rgba(0,0,0,.1);}
body.light .tbtn{color:rgba(0,0,0,.55);}
body.light .tbtn.on{color:#fff;}
body.light .pill{background:rgba(0,0,0,.06);border-color:rgba(0,0,0,.08);color:#333;}
body.light .pill:hover{background:rgba(0,0,0,.1);}
body.light .card{background:#f4f3ef;}
body.light .cveil{background:rgba(244,243,239,.45),radial-gradient(ellipse at 30% 30%,rgba(102,126,234,.08) 0%,transparent 60%),radial-gradient(ellipse at 75% 75%,rgba(118,75,162,.05) 0%,transparent 55%);}
body.light .panel{background:rgba(255,255,255,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-color:rgba(0,0,0,.08);}
body.light .chip{background:rgba(74,90,216,.1);border-color:rgba(74,90,216,.2);color:#4a5ad8;}
body.light .chip.h{background:rgba(17,153,142,.1);border-color:rgba(17,153,142,.2);color:#0d8a7f;}
body.light .art-title{color:#1a1a2e;}
body.light .art-body{color:rgba(0,0,0,.55);}
body.light .act{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1);color:#333;}
body.light .act:hover{background:rgba(0,0,0,.08);}
body.light .act.liked{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.25);color:#dc2626;}
body.light .act.cta{color:#fff;}
body.light .act.deeper{background:rgba(180,140,20,.06);border-color:rgba(180,140,20,.18);color:rgba(140,100,10,.85);}
body.light .burger-menu,.light .burger-backdrop{background:rgba(244,243,239,.99);}
body.light .burger-backdrop{background:rgba(0,0,0,.25);}
body.light .burger-row{border-color:rgba(0,0,0,.07);}
body.light .burger-row-label{color:rgba(0,0,0,.7);}
body.light .burger-row-sub{color:rgba(0,0,0,.4);}
body.light .burger-action{background:rgba(0,0,0,.05);border-color:rgba(0,0,0,.08);color:#333;}
body.light .burger-action:hover{background:rgba(0,0,0,.1);}
body.light .lp,.light .sp,.light .hp{background:rgba(244,243,239,.97);border-color:rgba(0,0,0,.08);}
body.light .lp-x,.light .sp-x,.light .hp-x{color:rgba(0,0,0,.35);}
body.light .lp-x:hover,.light .sp-x:hover,.light .hp-x:hover{color:#000;}
body.light .li{background:rgba(0,0,0,.03);border-color:rgba(0,0,0,.07);}
body.light .li-ttl{color:#1a1a2e;}
body.light .li-body{color:rgba(0,0,0,.45);}
body.light .li-btn{background:rgba(0,0,0,.05);border-color:rgba(0,0,0,.08);color:rgba(0,0,0,.7);}
body.light .li-btn:hover{background:rgba(0,0,0,.1);}
body.light .sp-row{border-color:rgba(0,0,0,.07);}
body.light .sp-row-label{color:rgba(0,0,0,.7);}
body.light .sp-row-sub{color:rgba(0,0,0,.4);}
body.light .sp-section-title{color:rgba(0,0,0,.3);}
body.light .sp-about{background:rgba(0,0,0,.03);border-color:rgba(0,0,0,.07);}
body.light .sp-about-body{color:rgba(0,0,0,.5);}
body.light .sp-about-contact{color:rgba(0,0,0,.35);}
body.light .modal{background:rgba(255,255,255,.95);border-color:rgba(0,0,0,.08);}
body.light .modal-body{color:rgba(0,0,0,.55);}
body.light .modal-contact{color:rgba(0,0,0,.35);}
body.light .toast{background:rgba(255,255,255,.95);color:#333;border-color:rgba(0,0,0,.1);}
body.light .kb-bar{background:rgba(255,255,255,.88);}
body.light .kb-hint{color:rgba(0,0,0,.5);}
body.light .kb-key{background:rgba(0,0,0,.06);border-color:rgba(0,0,0,.12);color:rgba(0,0,0,.7);}
body.light .cat-tag{background:rgba(0,0,0,.05);border-color:rgba(0,0,0,.1);color:rgba(0,0,0,.6);}
body.light .read-time{color:rgba(0,0,0,.4);}
body.light .meta-row{color:rgba(0,0,0,.5);}
body.light .swipe-ind{background:rgba(255,255,255,.5);}
body.light .toggle-sw{background:rgba(0,0,0,.15);}
body.light .toggle-sw.on{background:#667eea;}
body.light .badge{background:#667eea;color:#fff;}
body.light .hint-txt,.light .hint-arr{color:rgba(0,0,0,.35);border-color:rgba(0,0,0,.35);}
body.light .spin-lbl{color:rgba(0,0,0,.4);}
body.light .sheet-overlay{background:rgba(0,0,0,.3);}
body.light .topic-sheet{background:rgba(255,255,255,.98);border-color:rgba(0,0,0,.08);}
body.light .sheet-title{color:#1a1a2e;}
body.light .sheet-sub{color:rgba(0,0,0,.45);}
body.light .topic-pill{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1);color:rgba(0,0,0,.7);}
body.light .topic-pill.on{background:rgba(102,126,234,.12);border-color:rgba(102,126,234,.3);color:#4a5ad8;}
body.light .sp-backdrop,.light .burger-backdrop{background:rgba(0,0,0,.2);}
body.light .streak-row{color:rgba(0,0,0,.55);}
body.light .streak-num{color:#d97706;}
body.light .streak-label{color:rgba(0,0,0,.35);}
body.light .err{background:rgba(255,255,255,.9);border-color:rgba(239,68,68,.2);}
body.light .err-ttl,.light .err-msg{color:rgba(0,0,0,.6);}
body.light #privacyOverlay .modal{background:rgba(255,255,255,.98);}
body.light #privacyOverlay .modal div{color:rgba(0,0,0,.6) !important;}
body.light #privacyOverlay strong{color:rgba(0,0,0,.8) !important;}
body.light .depth-val{color:#d97706;}
body.light #privacyLinkSettings,body.light #burgerPrivacyLink{color:rgba(0,0,0,.25) !important;}

/* ── HISTORY PANEL ── */
.hp{
  position:fixed;top:0;right:-440px;width:420px;height:var(--vh);
  background:rgba(8,8,14,.97);backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);
  border-left:1px solid var(--border);z-index:400;
  transition:right .32s cubic-bezier(.4,0,.2,1);overflow-y:auto;
  padding:max(84px,calc(env(safe-area-inset-top) + 70px)) 18px max(24px,env(safe-area-inset-bottom));
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.07) transparent;
}
.hp.open{right:0;}
.hp-hdr{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center;}
.hp-x{font-size:20px;cursor:pointer;background:none;border:none;color:var(--dim);transition:color .2s;}
.hp-x:hover{color:#fff;}
.hi{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px;cursor:pointer;transition:background .18s;}
.hi:hover{background:rgba(255,255,255,.08);}
.hi-time{font-size:10px;color:var(--dim);margin-bottom:3px;}
.hi-ttl{font-family:'Syne',sans-serif;font-size:14px;font-weight:600;margin-bottom:3px;line-height:1.3;color:#fff;}
.hi-body{font-size:12px;color:var(--dim);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
@media(max-width:600px){.hp{width:100%;right:-100%;}}

/* ── COLLECTIONS ── */
.coll-tabs{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;}
.coll-tab{
  font-size:11px;padding:5px 12px;border-radius:50px;cursor:pointer;
  background:rgba(255,255,255,.06);border:1px solid var(--border);color:rgba(255,255,255,.6);
  font-family:'DM Sans',sans-serif;transition:all .18s;white-space:nowrap;
}
.coll-tab:hover{background:rgba(255,255,255,.1);}
.coll-tab.on{background:rgba(102,126,234,.15);border-color:rgba(102,126,234,.35);color:#a5b4fc;}
.coll-assign{
  font-size:10px;padding:3px 9px;border-radius:6px;cursor:pointer;
  background:rgba(102,126,234,.08);border:1px solid rgba(102,126,234,.2);color:#a5b4fc;
  font-family:'DM Sans',sans-serif;transition:all .18s;
}
.coll-assign:hover{background:rgba(102,126,234,.18);}
.coll-new-row{display:flex;gap:6px;margin-bottom:14px;}
.coll-new-input{
  flex:1;padding:7px 12px;border-radius:10px;border:1px solid var(--border);
  background:rgba(255,255,255,.05);color:#fff;font-size:12px;
  font-family:'DM Sans',sans-serif;outline:none;
}
.coll-new-input:focus{border-color:rgba(102,126,234,.4);}
.coll-new-btn{
  padding:7px 14px;border-radius:10px;border:none;cursor:pointer;
  background:rgba(102,126,234,.2);color:#a5b4fc;font-size:12px;font-weight:600;
  font-family:'DM Sans',sans-serif;transition:background .18s;
}
.coll-new-btn:hover{background:rgba(102,126,234,.3);}
body.light .coll-tab{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.08);color:rgba(0,0,0,.5);}
body.light .coll-tab.on{background:rgba(74,90,216,.1);border-color:rgba(74,90,216,.25);color:#4a5ad8;}
body.light .coll-assign{background:rgba(74,90,216,.06);border-color:rgba(74,90,216,.15);color:#4a5ad8;}
body.light .coll-new-input{background:rgba(0,0,0,.03);border-color:rgba(0,0,0,.1);color:#333;}
body.light .coll-new-btn{background:rgba(74,90,216,.12);color:#4a5ad8;}
body.light .hi{background:rgba(0,0,0,.03);border-color:rgba(0,0,0,.07);}
body.light .hi:hover{background:rgba(0,0,0,.06);}
body.light .hi-ttl{color:#1a1a2e;}
body.light .hi-body,.light .hi-time{color:rgba(0,0,0,.45);}

/* ── DEPTH SLIDER ── */
.depth-wrap{width:100%;margin-top:6px;}
.depth-track{position:relative;}
.depth-slider{
  -webkit-appearance:none;appearance:none;width:100%;height:6px;
  border-radius:3px;background:linear-gradient(90deg,rgba(102,126,234,.3),rgba(251,191,36,.3),rgba(239,68,68,.3));
  outline:none;cursor:pointer;margin:0;
}
.depth-slider::-webkit-slider-thumb{
  -webkit-appearance:none;width:20px;height:20px;border-radius:50%;
  background:#fbbf24;border:3px solid rgba(251,191,36,.5);cursor:pointer;
  box-shadow:0 2px 10px rgba(251,191,36,.35);transition:transform .15s;
}
.depth-slider::-webkit-slider-thumb:hover{transform:scale(1.15);}
.depth-slider::-moz-range-thumb{
  width:20px;height:20px;border-radius:50%;border:3px solid rgba(251,191,36,.5);
  background:#fbbf24;cursor:pointer;box-shadow:0 2px 10px rgba(251,191,36,.35);
}
.depth-slider::-moz-range-track{height:6px;border-radius:3px;background:linear-gradient(90deg,rgba(102,126,234,.3),rgba(251,191,36,.3),rgba(239,68,68,.3));}
.depth-steps{display:flex;justify-content:space-between;margin-top:10px;padding:0 10px;}
.depth-step{
  display:flex;flex-direction:column;align-items:center;gap:4px;
  font-size:10px;color:var(--dim);transition:color .2s, transform .2s;
  width:0;cursor:pointer;
}
.depth-step span{white-space:nowrap;}
.depth-step .ds-dot{width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,.15);transition:all .2s;}
.depth-step.active{color:rgba(255,255,255,.85);transform:scale(1.05);}
.depth-step.active .ds-dot{width:6px;height:6px;background:#fbbf24;box-shadow:0 0 6px rgba(251,191,36,.4);}
.depth-val{
  display:inline-flex;align-items:center;gap:5px;
  font-size:11px;font-weight:600;color:#fbbf24;margin-top:10px;
}
body.light .depth-slider{background:linear-gradient(90deg,rgba(74,90,216,.15),rgba(180,140,20,.15),rgba(200,60,60,.15));}
body.light .depth-step{color:rgba(0,0,0,.35);}
body.light .depth-step.active{color:rgba(0,0,0,.7);}
body.light .depth-step .ds-dot{background:rgba(0,0,0,.12);}
body.light .depth-step.active .ds-dot{background:#d97706;}

/* ── WIKIVOYAGE MAP EXPLORER ── */
.map-overlay{
  position:fixed;inset:0;z-index:750;
  background:rgba(0,0,0,0);
  pointer-events:none;visibility:hidden;
  transition:background .3s ease, visibility 0s .3s;
}
.map-overlay.open{
  background:rgba(0,0,0,.92);
  pointer-events:auto;visibility:visible;
  transition:background .3s ease, visibility 0s 0s;
}
.map-container{
  position:absolute;inset:60px 16px 16px;
  border-radius:20px;overflow:hidden;
  opacity:0;transform:translateY(20px) scale(.97);
  transition:opacity .35s ease .05s, transform .35s cubic-bezier(.4,0,.2,1) .05s;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
}
.map-overlay.open .map-container{opacity:1;transform:translateY(0) scale(1);}
.map-container #mapCanvas{width:100%;height:100%;z-index:0;}
.map-hdr{
  position:absolute;top:0;left:0;right:0;z-index:10;
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px;
  background:linear-gradient(to bottom,rgba(0,0,0,.7) 0%,rgba(0,0,0,0) 100%);
}
.map-title{
  font-family:'Syne',sans-serif;font-size:16px;font-weight:700;
  color:#fff;letter-spacing:-.3px;
  text-shadow:0 2px 8px rgba(0,0,0,.5);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70%;
}
.map-close{
  width:36px;height:36px;border-radius:50%;
  background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.15);
  cursor:pointer;color:#fff;font-size:16px;
  display:flex;align-items:center;justify-content:center;
  transition:background .2s;flex-shrink:0;
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
}
.map-close:hover{background:rgba(255,255,255,.22);}
.map-badge{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;
  padding:10px 20px;border-radius:50px;
  background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.1);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  color:#fff;font-size:12px;font-weight:500;
  display:flex;align-items:center;gap:8px;
  opacity:0;transform:translateX(-50%) translateY(10px);
  transition:opacity .3s .4s, transform .3s .4s;
}
.map-overlay.open .map-badge{opacity:1;transform:translateX(-50%) translateY(0);}
.map-badge a{color:#a5b4fc;text-decoration:none;font-weight:600;}
.map-loading{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(7,7,13,.9);z-index:5;
  transition:opacity .3s;
}
.map-loading.hidden{opacity:0;pointer-events:none;}
.map-loading-text{color:rgba(255,255,255,.5);font-size:13px;}
/* Map explore button on cards */
.map-btn{
  position:absolute;top:12px;right:12px;z-index:10;
  width:40px;height:40px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  cursor:pointer;font-size:20px;line-height:1;
  transition:transform .2s, background .2s, box-shadow .2s;
  box-shadow:0 4px 16px rgba(0,0,0,.3);
}
.map-btn:hover{transform:scale(1.08);background:rgba(255,255,255,.2);box-shadow:0 6px 24px rgba(0,0,0,.4);}
.map-btn:active{transform:scale(.95);}
body.light .map-btn{background:rgba(0,0,0,.06);border-color:rgba(0,0,0,.1);box-shadow:0 4px 16px rgba(0,0,0,.1);}
body.light .map-container{box-shadow:0 20px 60px rgba(0,0,0,.3);}
body.light .map-hdr{background:linear-gradient(to bottom,rgba(255,255,255,.85) 0%,rgba(255,255,255,0) 100%);}
body.light .map-title{color:#1a1a2e;text-shadow:none;}
body.light .map-close{background:rgba(0,0,0,.06);border-color:rgba(0,0,0,.1);color:#1a1a2e;}
body.light .map-badge{background:rgba(255,255,255,.85);border-color:rgba(0,0,0,.08);color:#1a1a2e;}
body.light .map-badge a{color:#4a5ad8;}
/* Custom map marker */
.map-marker-custom{background:none !important;border:none !important;}
.map-pin{position:relative;width:32px;height:32px;}
.map-pin-dot{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:12px;height:12px;border-radius:50%;background:#667eea;
  box-shadow:0 0 12px rgba(102,126,234,.6),0 0 24px rgba(102,126,234,.3);
  z-index:2;
}
.map-pin-ring{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:28px;height:28px;border-radius:50%;
  border:2px solid rgba(102,126,234,.5);
  animation:map-pulse 2s ease-out infinite;
}
@keyframes map-pulse{
  0%{transform:translate(-50%,-50%) scale(.8);opacity:1;}
  100%{transform:translate(-50%,-50%) scale(2);opacity:0;}
}
/* Leaflet popup overrides */
.leaflet-popup-content-wrapper{
  background:rgba(15,15,25,.92) !important;color:#fff !important;
  border-radius:12px !important;border:1px solid rgba(255,255,255,.1) !important;
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  box-shadow:0 8px 32px rgba(0,0,0,.5) !important;
}
.leaflet-popup-tip{background:rgba(15,15,25,.92) !important;}
.leaflet-popup-content{margin:10px 14px !important;font-family:'DM Sans',sans-serif !important;font-size:13px !important;line-height:1.5 !important;}
body.light .leaflet-popup-content-wrapper{background:rgba(255,255,255,.95) !important;color:#1a1a2e !important;border-color:rgba(0,0,0,.1) !important;}
body.light .leaflet-popup-tip{background:rgba(255,255,255,.95) !important;}
body.light .map-pin-dot{background:#4a5ad8;box-shadow:0 0 12px rgba(74,90,216,.6);}
body.light .map-pin-ring{border-color:rgba(74,90,216,.5);}

/* ── STREAK DISPLAY ── */
.streak-display{display:flex;flex-direction:column;gap:8px;width:100%;}
.streak-main{display:flex;align-items:center;gap:8px;}
.streak-main .streak-fire{font-size:20px;}
.streak-main .streak-num{font-weight:700;font-size:18px;color:var(--fg);}
.streak-progress{
  width:100%;height:4px;border-radius:2px;background:rgba(255,255,255,.08);margin-top:6px;overflow:hidden;
}
.streak-progress-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,#fbbf24,#f59e0b);transition:width .4s ease;}
body.light .streak-progress{background:rgba(0,0,0,.06);}

/* ── OFFLINE BANNER ── */
.offline-banner{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:600;
  padding:10px 22px;border-radius:50px;
  background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);
  color:#fca5a5;font-size:13px;font-weight:500;
  display:none;align-items:center;gap:8px;
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
}
.offline-banner.show{display:flex;}
body.light .offline-banner{background:rgba(239,68,68,.08);color:#dc2626;}
/* ── RESPONSIVE ── */
/* Tablet (iPad, etc.) */
@media(min-width:601px) and (max-width:1024px){
  .hdr{padding:12px 20px;}
  .card{border-radius:0;}
  .panel{max-width:540px;margin:0 auto;padding:28px 32px;border-radius:24px;}
  .art-title{font-size:23px;}
  .art-body{font-size:14.5px;-webkit-line-clamp:10;}
  .art-img{max-height:220px;border-radius:14px;}
  .lp,.sp,.hp{width:380px;}
  .ambient-title{font-size:clamp(32px,4.5vw,48px);}
  .ambient-excerpt{font-size:15.5px;-webkit-line-clamp:14;}
  .burger-menu{width:380px;}
  .map-container{inset:40px;}
  .map-badge{bottom:28px;}
  .depth-step span{font-size:10px;}
  .kb-bar{bottom:16px;}
  .depth-wrap{max-width:340px;}
}
/* iPad landscape & small laptops */
@media(min-width:1025px) and (max-width:1366px){
  .panel{max-width:560px;}
  .art-body{-webkit-line-clamp:11;}
  .map-container{inset:60px 80px;}
}
/* Large iPad Pro portrait */
@media(min-width:768px) and (max-width:1024px) and (orientation:portrait){
  .panel{max-width:600px;padding:32px 40px;}
  .art-title{font-size:26px;}
  .art-body{font-size:15px;-webkit-line-clamp:12;}
  .art-img{max-height:260px;}
  .acts{flex-wrap:wrap;justify-content:center;}
  .act{padding:14px 20px;font-size:14.5px;}
  .map-container{inset:50px 32px 32px;}
}
/* Mobile */
@media(max-width:600px){
  .hdr{grid-template-columns:auto 1fr auto;}
  .logo{font-size:19px;}
  .tbtn{font-size:11px;padding:5px 10px;}
  .panel{width:93vw;max-height:86vh;padding:18px;border-radius:22px;}
  .art-title{font-size:19px;}
  .lp{width:100%;right:-100%;}
  .act{padding:12px 16px;font-size:14px;}
  .hdr-right > .lang-wrap,
  .hdr-right > #likesBtn,
  .hdr-right > #topicsBtn,
  .hdr-right > #settingsBtn{display:none;}
  .burger-btn{display:flex;}
  .card{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;}
  .card img{pointer-events:none;}
  .sp{width:100%;right:-100%;}
  .map-container{inset:12px 8px 8px;border-radius:16px;}
  .map-badge{bottom:14px;padding:8px 14px;font-size:11px;}
  .map-title{font-size:14px;}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="hdr-left"><div class="logo">WikiScroll</div></div>
  <div class="hdr-mid">
    <div class="toggle">
      <button class="tbtn won on" id="wBtn">Wikipedia</button>
      <button class="tbtn" id="hBtn">Wikivoyage</button>
    </div>
  </div>
  <div class="hdr-right">
    <div class="lang-wrap">
      <button class="pill" id="langBtn"><span>🌍</span><span id="langTxt">English</span></button>
      <div class="lang-dd" id="langDd"></div>
    </div>
    <button class="pill" id="likesBtn">
      <span>❤️</span><span>Likes</span>
      <span class="badge" id="badge" style="display:none">0</span>
    </button>
    <button class="pill" id="topicsBtn">
      <span>🎯</span><span>Topics</span>
      <span class="badge topic-badge" id="topicBadge" style="display:none">0</span>
    </button>
    <button class="pill" id="settingsBtn"><span>⚙️</span><span>Settings</span></button>
    <button class="burger-btn" id="burgerBtn" title="Menu">
      <span class="burger-dot" id="burgerDot"></span>
      <svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
        <line x1="2" y1="4.5" x2="16" y2="4.5"/>
        <line x1="2" y1="9" x2="16" y2="9"/>
        <line x1="2" y1="13.5" x2="16" y2="13.5"/>
      </svg>
    </button>
  </div>
</header>

<!-- MOBILE BURGER MENU -->
<div class="burger-backdrop" id="burgerBackdrop"></div>
<div class="burger-menu" id="burgerMenu">
  <div class="burger-inner">
    <div class="burger-row">
      <div class="burger-row-label"><span class="ico">🌍</span><span id="burgerLangTxt">English</span></div>
      <button class="burger-action" id="burgerLangBtn">Change ›</button>
    </div>
    <div class="burger-lang-grid" id="burgerLangGrid"></div>
    <div class="burger-row">
      <div class="burger-row-label"><span class="ico">🎯</span><span>Topics</span></div>
      <button class="burger-action" id="burgerTopicsBtn">Filter ›</button>
    </div>
    <div class="burger-topics" id="burgerTopics">
      <div class="burger-topic-grid" id="burgerTopicGrid"></div>
    </div>
    <div class="burger-row">
      <div class="burger-row-label">
        <span class="ico">👆</span>
        <div><div>Swipe Gestures</div><div class="burger-row-sub">Left to skip · Right to like</div></div>
      </div>
      <button class="toggle-sw on" id="swipeToggle" role="switch" aria-label="Toggle swipe gestures"></button>
    </div>
    <div class="burger-row">
      <div class="burger-row-label">
        <span class="ico">🐇</span>
        <div><div>Rabbit Hole <span class="beta-tag">Beta</span></div><div class="burger-row-sub">Adds a "Go deeper" button to explore related articles from the one you're reading</div></div>
      </div>
      <button class="toggle-sw" id="rabbitToggle" role="switch" aria-label="Toggle rabbit hole mode"></button>
    </div>
    <div class="burger-row">
      <div class="burger-row-label">
        <span class="ico">🔬</span>
        <div><div>Article Depth <span class="beta-tag">Beta</span></div><div class="burger-row-sub">Left = popular hits · Right = deep cuts nobody's heard of</div></div>
      </div>
    </div>
    <div class="burger-row" style="padding-top:0;border:none;">
      <div class="depth-wrap">
        <div class="depth-track">
          <input type="range" class="depth-slider" id="depthSlider" min="1" max="5" value="3" step="1">
        </div>
        <div class="depth-steps" id="depthSteps">
          <div class="depth-step" data-d="1"><div class="ds-dot"></div><span>Popular</span></div>
          <div class="depth-step" data-d="2"><div class="ds-dot"></div><span>Known</span></div>
          <div class="depth-step active" data-d="3"><div class="ds-dot"></div><span>Balanced</span></div>
          <div class="depth-step" data-d="4"><div class="ds-dot"></div><span>Niche</span></div>
          <div class="depth-step" data-d="5"><div class="ds-dot"></div><span>Obscure</span></div>
        </div>
      </div>
    </div>
    <div class="burger-row">
      <div class="burger-row-label">
        <span class="ico">📳</span>
        <div><div>Haptic Feedback <span class="beta-tag">Beta</span></div><div class="burger-row-sub">Light vibration on swipe (iOS 18+ / Android)</div></div>
      </div>
      <button class="toggle-sw" id="hapticToggle" role="switch" aria-label="Toggle haptic feedback"></button>
    </div>
    <div class="burger-row">
      <div class="burger-row-label"><span class="ico">❤️</span><span>Saved Articles</span></div>
      <button class="burger-action" id="burgerLikesBtn">
        View <span class="badge" id="burgerBadge" style="display:none">0</span>
      </button>
    </div>
    <div class="burger-row">
      <div class="burger-row-label"><span class="ico">📜</span><span>History</span></div>
      <button class="burger-action" id="burgerHistoryBtn">View ›</button>
    </div>
    <div class="burger-row">
      <div class="burger-row-label">
        <span class="ico">🌙</span>
        <div><div>Light Mode</div><div class="burger-row-sub">For the 3 users who want it</div></div>
      </div>
      <button class="toggle-sw" id="themeToggle" role="switch" aria-label="Toggle light mode"></button>
    </div>
    <div class="burger-row" style="flex-direction:column;align-items:flex-start;">
      <div class="burger-row-label"><span class="ico">📊</span><span>Today's Stats</span></div>
      <div class="streak-display" style="padding-left:32px;">
        <div class="streak-main">
          <span class="streak-fire">🔥</span>
          <span><span class="streak-num" id="streakCount">0</span> articles today</span>
          <span class="streak-label" id="streakLabel"></span>
        </div>
        <div class="streak-progress"><div class="streak-progress-fill" id="streakProgress" style="width:0%"></div></div>
      </div>
    </div>
    <div class="burger-row" style="flex-direction:column;align-items:stretch;gap:0;padding:0;">
      <div class="sp-about" style="border:none;margin:0;">
        <div class="sp-about-logo">WikiScroll</div>
        <div class="sp-about-body">
          Infinite scrolling through Wikipedia and Wikivoyage in multiple languages.<br><br>
          Swipe right to like · Left to skip · Long-press for Ambient Mode.
        </div>
        <div class="sp-about-contact">contact [at] wikiscroll.com</div>
        <div style="margin-top:10px;"><a href="#" id="burgerPrivacyLink" style="font-size:11px;color:rgba(255,255,255,.25);text-decoration:none;">Privacy Policy</a></div>
      </div>
    </div>
  </div>
</div>

<!-- TOPIC SHEET -->
<div class="sheet-overlay" id="sheetOverlay"></div>
<div class="topic-sheet" id="topicSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Topics</div>
  <div class="sheet-sub">Select topics to bias your feed. Leave all off for fully random.</div>
  <div class="topic-grid" id="topicGrid"></div>
  <button class="sheet-reset" id="sheetReset">Clear all topics</button>
</div>

<!-- LIKES PANEL -->
<div class="lp" id="lp">
  <div class="lp-hdr"><span>Saved Articles</span><button class="lp-x" id="lpClose">✕</button></div>
  <div class="coll-tabs" id="collTabs"></div>
  <div class="coll-new-row">
    <input class="coll-new-input" id="collNewInput" placeholder="New collection name…" maxlength="30">
    <button class="coll-new-btn" id="collNewBtn">+ Create</button>
  </div>
  <div id="likedList"></div>
</div>

<!-- HISTORY PANEL -->
<div class="hp" id="hp">
  <div class="hp-hdr"><span>History</span><button class="hp-x" id="hpClose">✕</button></div>
  <div id="historyList"></div>
</div>

<!-- OFFLINE BANNER -->
<div class="offline-banner" id="offlineBanner">📡 You're offline — cached articles still work</div>

<!-- SEO FALLBACK -->
<noscript>
<div style="max-width:700px;margin:60px auto;padding:20px;font-family:sans-serif;color:#333;line-height:1.8;">
  <h1>WikiScroll — Discover Random Wikipedia Articles in a TikTok-Style Feed</h1>
  <p>WikiScroll is a free Progressive Web App that lets you discover random Wikipedia and Wikivoyage articles in a beautiful, infinite, swipeable feed. Think of it as TikTok for learning — every swipe reveals a new article about science, history, geography, food, arts, technology, sports, or fascinating people from around the world.</p>
  <h2>Features</h2>
  <p>Infinite scroll through curated Wikipedia articles with beautiful card design. Full Wikivoyage travel guide integration with interactive map explorer. Support for 14 languages including English, Spanish, French, German, Italian, Portuguese, Russian, Japanese, Chinese, Arabic, Hindi, Korean, Dutch, and Polish. Topic filtering across 8 categories. Swipe right to save articles, left to skip. Ambient reading mode for distraction-free learning. Reading history to find articles you've seen before. Offline support — works without internet. Dark and light themes. Article depth slider to control how obscure your feed gets. Collections to organize saved articles. Share beautiful image cards to social media. Reading streaks and milestone badges. Keyboard shortcuts for desktop power users. Install as a Progressive Web App on any device.</p>
  <h2>How WikiScroll Works</h2>
  <p>WikiScroll fetches random articles from the Wikipedia and Wikivoyage REST APIs, filters them for quality, images, and relevance, then presents them in a full-screen card format. Each card shows the article title, an excerpt, a thumbnail image, auto-detected category tags, and estimated reading time. Swipe right or tap the heart to save articles for later. Tap "Read Full Article" to visit the original Wikipedia or Wikivoyage page. For Wikivoyage travel articles, an interactive map shows the location on a beautifully styled map powered by Leaflet and OpenStreetMap.</p>
  <h2>Privacy First</h2>
  <p>WikiScroll collects zero data. No analytics, no tracking, no cookies, no accounts. All your preferences, liked articles, and reading history stay on your device in localStorage. WikiScroll is open, transparent, and respects your privacy completely.</p>
  <h2>Install WikiScroll</h2>
  <p>WikiScroll is a Progressive Web App (PWA) that works in any modern browser. Install it on your home screen for a native app-like experience. On iPhone, tap the Share button in Safari and select "Add to Home Screen." On Android, tap the menu in Chrome and select "Install app."</p>
  <p><a href="https://wikiscroll.com/">Launch WikiScroll</a> — Please enable JavaScript to use WikiScroll.</p>
  <h2>Frequently Asked Questions</h2>
  <p><strong>What is WikiScroll?</strong> WikiScroll is a free web app that presents random Wikipedia and Wikivoyage articles in an infinite, swipeable feed — like TikTok for learning.</p>
  <p><strong>Is WikiScroll free to use?</strong> Yes, completely free with no ads, no tracking, and no account required. All data stays on your device.</p>
  <p><strong>Does WikiScroll work offline?</strong> Yes, WikiScroll is a Progressive Web App with offline support. Previously viewed and liked articles are cached and available without an internet connection.</p>
  <p><strong>What languages does WikiScroll support?</strong> 14 languages: English, Spanish, French, German, Italian, Portuguese, Russian, Japanese, Chinese, Arabic, Hindi, Korean, Dutch, and Polish.</p>
</div>
</noscript>

<!-- FEED -->
<div class="feed" id="feed" tabindex="0">
  <div class="spin-wrap" id="spinner">
    <div class="spin"></div>
    <div class="spin-lbl">Loading articles…</div>
  </div>
</div>

<!-- HINT -->
<div class="hint" id="hint">
  <div class="hint-txt">Scroll to discover</div>
  <div class="hint-arr"></div>
</div>

<!-- SETTINGS PANEL (desktop) -->

<!-- PRIVACY POLICY MODAL -->
<div class="modal-overlay" id="privacyOverlay">
  <div class="modal" style="max-height:80vh;overflow-y:auto;text-align:left;max-width:min(520px,90vw);">
    <button class="modal-close" id="privacyClose">✕</button>
    <div class="modal-logo" style="text-align:center;">Privacy Policy</div>
    <div style="font-size:13px;line-height:1.75;color:rgba(255,255,255,.65);">
      <p style="margin-bottom:12px;font-size:11px;color:var(--dim);">Last updated: February 2026</p>

      <p style="margin-bottom:14px;"><strong style="color:rgba(255,255,255,.85);">What WikiScroll is.</strong> WikiScroll is a free, client-side web application that displays random articles from Wikipedia and Wikivoyage. It is hosted on Cloudflare Pages.</p>

      <p style="margin-bottom:14px;"><strong style="color:rgba(255,255,255,.85);">Data we collect.</strong> WikiScroll does <strong>not</strong> collect, store, or transmit any personal data to any server. We have no analytics, no tracking pixels, no cookies set by us, and no third-party advertising SDKs. We do not know who you are.</p>

      <p style="margin-bottom:14px;"><strong style="color:rgba(255,255,255,.85);">Local storage.</strong> Your preferences (liked articles, reading history, settings, theme, streak data, and collections) are stored exclusively in your browser's localStorage and IndexedDB. This data never leaves your device. You can clear it at any time through your browser settings.</p>

      <p style="margin-bottom:14px;"><strong style="color:rgba(255,255,255,.85);">Third-party services.</strong> WikiScroll loads content from the following external services:
      </p>
      <ul style="margin:0 0 14px 18px;padding:0;">
        <li style="margin-bottom:6px;"><strong>Wikipedia / Wikivoyage API</strong> — Article content and images. Subject to the Wikimedia Foundation's privacy policy.</li>
        <li style="margin-bottom:6px;"><strong>Google Fonts</strong> — Typefaces (DM Sans, Syne). Subject to Google's privacy policy.</li>
        <li style="margin-bottom:6px;"><strong>Cloudflare Pages</strong> — Hosting and CDN delivery. Cloudflare may collect standard web server logs (IP address, user agent, timestamps) as part of their infrastructure. Subject to Cloudflare's privacy policy.</li>
      </ul>

      <p style="margin-bottom:14px;"><strong style="color:rgba(255,255,255,.85);">Service Worker.</strong> WikiScroll registers a service worker to cache articles for offline use. This caching is entirely local to your device.</p>

      <p style="margin-bottom:14px;"><strong style="color:rgba(255,255,255,.85);">Children's privacy.</strong> WikiScroll does not knowingly collect data from anyone, including children under 13. Since no personal data is collected or transmitted, COPPA requirements are inherently met.</p>

      <p style="margin-bottom:14px;"><strong style="color:rgba(255,255,255,.85);">Changes to this policy.</strong> We may update this privacy policy from time to time. Any changes will be reflected on this page with an updated revision date.</p>

      <p style="margin-bottom:0;"><strong style="color:rgba(255,255,255,.85);">Contact.</strong> If you have questions about this policy, contact us at contact [at] wikiscroll.com.</p>
    </div>
  </div>
</div>

<!-- SETTINGS PANEL (desktop) -->
<div class="sp-backdrop" id="spBackdrop"></div>
<div class="sp" id="settingsPanel">
  <div class="sp-hdr"><span>Settings</span><button class="sp-x" id="spClose">✕</button></div>

  <div class="sp-section">
    <div class="sp-section-title">Gestures</div>
    <div class="sp-row">
      <div class="sp-row-label">
        <span class="ico">👆</span>
        <div><div>Swipe Gestures</div><div class="sp-row-sub">Left to skip · Right to like</div></div>
      </div>
      <button class="toggle-sw on" id="dkSwipeToggle" role="switch"></button>
    </div>
  </div>

  <div class="sp-section">
    <div class="sp-section-title">Appearance</div>
    <div class="sp-row">
      <div class="sp-row-label">
        <span class="ico">🌙</span>
        <div><div>Light Mode</div><div class="sp-row-sub">For the 3 users who want it</div></div>
      </div>
      <button class="toggle-sw" id="dkThemeToggle" role="switch"></button>
    </div>
  </div>

  <div class="sp-section">
    <div class="sp-section-title">Beta Features</div>
    <div class="sp-row">
      <div class="sp-row-label">
        <span class="ico">🐇</span>
        <div><div>Rabbit Hole <span class="beta-tag">Beta</span></div><div class="sp-row-sub">Adds a "Go deeper" button to explore related articles</div></div>
      </div>
      <button class="toggle-sw" id="dkRabbitToggle" role="switch"></button>
    </div>
    <div class="sp-row">
      <div class="sp-row-label">
        <span class="ico">🔬</span>
        <div><div>Article Depth <span class="beta-tag">Beta</span></div><div class="sp-row-sub">Controls how obscure the articles in your feed are. Slide left for well-known topics, right for hidden gems most people have never heard of</div></div>
      </div>
    </div>
    <div class="sp-row" style="padding-top:0;border:none;">
      <div class="depth-wrap">
        <div class="depth-track">
          <input type="range" class="depth-slider" id="dkDepthSlider" min="1" max="5" value="3" step="1">
        </div>
        <div class="depth-steps" id="dkDepthSteps">
          <div class="depth-step" data-d="1"><div class="ds-dot"></div><span>Popular</span></div>
          <div class="depth-step" data-d="2"><div class="ds-dot"></div><span>Known</span></div>
          <div class="depth-step active" data-d="3"><div class="ds-dot"></div><span>Balanced</span></div>
          <div class="depth-step" data-d="4"><div class="ds-dot"></div><span>Niche</span></div>
          <div class="depth-step" data-d="5"><div class="ds-dot"></div><span>Obscure</span></div>
        </div>
      </div>
    </div>
    <div class="sp-row">
      <div class="sp-row-label">
        <span class="ico">📳</span>
        <div><div>Haptic Feedback <span class="beta-tag">Beta</span></div><div class="sp-row-sub">Light vibration on swipe (iOS 18+ / Android)</div></div>
      </div>
      <button class="toggle-sw" id="dkHapticToggle" role="switch"></button>
    </div>
  </div>

  <div class="sp-section">
    <div class="sp-section-title">Features</div>
    <div class="sp-row">
      <div class="sp-row-label">
        <span class="ico">⌨️</span>
        <div><div>Show Keyboard Hints</div><div class="sp-row-sub">Navigation bar at the bottom of the screen</div></div>
      </div>
      <button class="toggle-sw on" id="dkKbToggle" role="switch"></button>
    </div>
  </div>

  <div class="sp-section">
    <div class="sp-section-title">Stats</div>
    <div class="sp-row" style="flex-direction:column;align-items:flex-start;gap:8px;">
      <div class="sp-row-label"><span class="ico">📊</span><span>Today's Stats</span></div>
      <div class="streak-display" style="padding-left:32px;">
        <div class="streak-main">
          <span class="streak-fire">🔥</span>
          <span><span class="streak-num" id="dkStreakCount">0</span> articles today</span>
          <span class="streak-label" id="dkStreakLabel"></span>
        </div>
        <div class="streak-progress"><div class="streak-progress-fill" id="dkStreakProgress" style="width:0%"></div></div>
      </div>
    </div>
  </div>

  <div class="sp-section">
    <div class="sp-section-title">About</div>
    <div class="sp-about">
      <div class="sp-about-logo">WikiScroll</div>
      <div class="sp-about-body">
        Infinite scrolling through Wikipedia and Wikivoyage in multiple languages.<br><br>
        Swipe right to like · Left to skip · Long-press for Ambient Mode.
      </div>
      <div class="sp-about-contact">contact [at] wikiscroll.com</div>
      <div style="margin-top:10px;"><a href="#" id="privacyLinkSettings" style="font-size:11px;color:rgba(255,255,255,.25);text-decoration:none;">Privacy Policy</a></div>
    </div>
  </div>
</div>

<!-- WIKIVOYAGE MAP EXPLORER -->
<div class="map-overlay" id="mapOverlay">
  <div class="map-container">
    <div class="map-hdr">
      <div class="map-title" id="mapTitle">Exploring…</div>
      <button class="map-close" id="mapClose">✕</button>
    </div>
    <div class="map-loading" id="mapLoading">
      <div class="map-loading-text">🗺️ Loading map…</div>
    </div>
    <div id="mapCanvas"></div>
    <div class="map-badge" id="mapBadge">
      <span>🗺️</span>
      <span id="mapBadgeText">Location</span>
      <span>·</span>
      <a href="#" id="mapReadLink" target="_blank">Read on Wikivoyage ↗</a>
    </div>
  </div>
</div>

<!-- AMBIENT OVERLAY -->
<div class="ambient-overlay" id="ambientOverlay">
  <div class="ambient-bg" id="ambientBg"></div>
  <div class="ambient-content">
    <div class="ambient-label">✦ Ambient Mode</div>
    <div class="ambient-title" id="ambientTitle"></div>
    <div class="ambient-excerpt" id="ambientExcerpt"></div>
  </div>
  <button class="ambient-close" id="ambientClose">✕</button>
  <div class="ambient-hint">Tap anywhere to exit</div>
</div>

<!-- KEYBOARD SHORTCUT BAR (desktop only) -->
<div class="kb-bar" id="kbBar">
  <div class="kb-hint"><span class="kb-key">↑</span><span class="kb-key">↓</span> Scroll</div>
  <div class="kb-hint"><span class="kb-key">←</span><span class="kb-key">→</span> Swipe</div>
  <div class="kb-hint"><span class="kb-key">L</span> Like</div>
  <div class="kb-hint"><span class="kb-key">S</span> Share</div>
  <div class="kb-hint"><span class="kb-key">R</span> Read</div>
  <div class="kb-hint" id="kbDeeperHint" style="display:none"><span class="kb-key">D</span> Go Deeper</div>
  <div class="kb-hint" id="kbMapHint" style="display:none"><span class="kb-key">M</span> Map</div>
  <div class="kb-hint"><span class="kb-key">Space</span> Ambient</div>
  <div class="kb-hint"><span class="kb-key">Esc</span> Close</div>
</div>

<!-- SHARE AS IMAGE OVERLAY -->
<div class="share-img-overlay" id="shareImgOverlay">
  <div class="share-img-card" style="position:relative">
    <button class="share-img-close" id="shareImgClose">✕</button>
    <img class="share-img-preview" id="shareImgPreview" alt="Share card preview">
    <div class="share-img-actions">
      <button class="share-img-btn" id="shareImgDownload">💾 Save Image</button>
      <button class="share-img-btn primary" id="shareImgShare">📤 Share</button>
    </div>
  </div>
</div>

<script>
'use strict';

// ── CONSTANTS ──────────────────────────────────────────────────────────────
const LANGS = [
  {c:'en',n:'English',f:'🇬🇧'},{c:'es',n:'Español',f:'🇪🇸'},
  {c:'fr',n:'Français',f:'🇫🇷'},{c:'de',n:'Deutsch',f:'🇩🇪'},
  {c:'it',n:'Italiano',f:'🇮🇹'},{c:'pt',n:'Português',f:'🇵🇹'},
  {c:'ru',n:'Русский',f:'🇷🇺'},{c:'ja',n:'日本語',f:'🇯🇵'},
  {c:'zh',n:'中文',f:'🇨🇳'},{c:'ar',n:'العربية',f:'🇸🇦'},
  {c:'hi',n:'हिन्दी',f:'🇮🇳'},{c:'ko',n:'한국어',f:'🇰🇷'},
  {c:'nl',n:'Nederlands',f:'🇳🇱'},{c:'pl',n:'Polski',f:'🇵🇱'},
];

const TOPICS = [
  {
    id:'food',label:'Food',emoji:'🍽️',
    cats:['Category:Cheeses','Category:Cocktails','Category:Soups','Category:Breads','Category:Noodle dishes','Category:Rice dishes','Category:Chocolate','Category:Coffee','Category:Tea','Category:Sushi','Category:Stews','Category:Salads','Category:Cakes','Category:Cookies','Category:Pies','Category:Sauces','Category:Fermented foods','Category:Street food'],
    valid:/\b(dish|food|cuisine|ingredient|flavor|flavour|taste|cooked|eaten|recipe|meal|snack|drink|beverage|served|baked|fried|grilled|brewed|fermented|cheese|bread|pasta|meat|vegetable|fruit|spice|herb|sauce|soup|dessert|sweet|savoury|savory)\b/i,
    vCats:['Category:Food and drink','Category:Restaurants'],
  },
  {
    id:'science',label:'Science',emoji:'🔬',
    cats:['Category:Chemical elements','Category:Constellations','Category:Exoplanets','Category:Minerals','Category:Mammals','Category:Birds','Category:Insects','Category:Fish','Category:Reptiles','Category:Amphibians','Category:Spiders','Category:Viruses','Category:Bacteria','Category:Fungi','Category:Mosses','Category:Orchids','Category:Subatomic particles','Category:Comets','Category:Asteroids'],
    valid:/\b(species|genus|family|order|class|element|compound|molecule|atom|particle|planet|star|galaxy|nebula|cell|protein|dna|rna|organism|native to|found in|named after|discovered|described by|scientific name|biology|chemistry|physics|astronomy|ecology|habitat|distribution)\b/i,
    vCats:['Category:Natural attractions','Category:National parks'],
  },
  {
    id:'history',label:'History',emoji:'🏛️',
    cats:['Category:Battles of World War II','Category:Battles of World War I','Category:Battles of the Napoleonic Wars','Category:Battles of the American Civil War','Category:Ancient Rome','Category:Ancient Egypt','Category:Ancient Greece','Category:Medieval castles','Category:Viking Age','Category:Crusades','Category:Byzantine Empire','Category:Ottoman Empire','Category:Mughal Empire','Category:Aztec','Category:Inca Empire','Category:Cold War'],
    valid:/\b(battle|war|siege|empire|kingdom|dynasty|ruled|conquered|revolt|revolution|treaty|medieval|ancient|century|\bbc\b|\bad\b|reign|fought|defeated|founded|established|occupation|invasion|rebellion|republic|pharaoh|emperor|general|army|navy|troops)\b/i,
    vCats:['Category:Historical sites','Category:Castles','Category:UNESCO World Heritage Sites'],
  },
  {
    id:'geo',label:'Geography',emoji:'🌍',
    cats:['Category:Islands of the Pacific Ocean','Category:Islands of the Atlantic Ocean','Category:Islands of the Indian Ocean','Category:Active volcanoes','Category:Mountain ranges','Category:Waterfalls','Category:Glaciers','Category:Deserts','Category:Caves','Category:Canyons','Category:Lagoons','Category:Atolls','Category:Peninsulas','Category:Straits','Category:Bays','Category:Rivers of Africa','Category:Rivers of Asia','Category:Rivers of South America'],
    valid:/\b(island|volcano|mountain|lake|river|ocean|sea|coast|peninsula|valley|glacier|desert|forest|national park|range|peak|summit|elevation|metres|meters|feet|kilometres|km|miles|located|situated|geography|terrain|climate|landscape|inlet|bay|strait|atoll|lagoon|cave|canyon|waterfall)\b/i,
    vCats:['Category:Islands','Category:National parks','Category:Natural attractions','Category:Mountains'],
  },
  {
    id:'arts',label:'Arts',emoji:'🎨',
    cats:['Category:Baroque paintings','Category:Renaissance paintings','Category:Impressionist paintings','Category:Operas','Category:Symphonies','Category:String quartets','Category:Gothic cathedrals','Category:Art Nouveau architecture','Category:Neoclassical architecture','Category:Modernist architecture','Category:Ancient Greek sculptures','Category:Ballet','Category:Silent films','Category:Jazz standards'],
    valid:/\b(painting|sculpture|architecture|composer|symphony|opera|ballet|novel|poem|film|director|musician|artist|gallery|museum|style|movement|genre|performed|written|painted|composed|concerto|sonata|fresco|mosaic|cathedral|palace|artwork|canvas|oil paint|watercolour|watercolor)\b/i,
    vCats:['Category:Museums','Category:Theatres','Category:Art galleries'],
  },
  {
    id:'tech',label:'Technology',emoji:'💻',
    cats:['Category:Inventions by country','Category:Computing','Category:Aviation','Category:Spacecraft','Category:Rockets','Category:Bridges','Category:Tunnels','Category:Locomotives','Category:Motorcycles','Category:Cameras','Category:Telescopes','Category:Particle accelerators','Category:Nuclear reactors','Category:Radio telescopes','Category:Submarines'],
    valid:/\b(invented|invention|patent|engineer|machine|computer|software|hardware|technology|device|system|design|developed|processor|algorithm|network|digital|electric|mechanical|built|manufactured|aircraft|spacecraft|rocket|engine|motor|circuit|semiconductor|satellite|telescope|bridge|tunnel|locomotive)\b/i,
    vCats:['Category:Airports','Category:Bridges'],
  },
  {
    id:'people',label:'People',emoji:'👤',
    cats:['Category:16th-century scientists','Category:17th-century scientists','Category:18th-century scientists','Category:19th-century scientists','Category:20th-century scientists','Category:Renaissance humanists','Category:Enlightenment philosophers','Category:Explorers of Africa','Category:Explorers of Asia','Category:Explorers of the Americas','Category:Women scientists','Category:Nobel laureates in Physics','Category:Nobel laureates in Chemistry','Category:Nobel laureates in Medicine'],
    valid:/\b(born|died|nationality|known for|notable|scientist|artist|philosopher|explorer|writer|inventor|leader|served as|worked as|educated|studied|mathematician|physician|biologist|chemist|physicist|astronomer|naturalist|theologian|statesman|admiral|general|discoverer)\b/i,
    vCats:[],
  },
  {
    id:'sports',label:'Sports',emoji:'⚽',
    cats:['Category:Athletics (track and field)','Category:Swimming','Category:Gymnastics','Category:Cycling','Category:Rowing','Category:Fencing','Category:Archery','Category:Weightlifting','Category:Wrestling','Category:Judo','Category:Karate','Category:Equestrian sports','Category:Sailing','Category:Shooting sports','Category:Bobsleigh','Category:Skiing','Category:Ice skating'],
    valid:/\b(sport|game|team|player|championship|tournament|league|match|athlete|olympic|medal|race|competition|played|competed|won|defeated|ranked|season|record|event|discipline|gold|silver|bronze|competing|coach|club|federation|world cup|grand prix)\b/i,
    vCats:['Category:Sports venues','Category:Stadiums'],
  },
];

const TOPIC_MAP     = Object.fromEntries(TOPICS.map(t => [t.id, t]));
const BAD_TITLE_RE  = /^(list of|lists of|timeline|history of|geography of|demographics|economy of|culture of|politics of|education in|deaths in|events of|index of|outline of|glossary|bibliography|filmography|discography|category:|talk:|wikipedia:)/i;
const GEO_RE        = /\b(city|town|village|municipality|district|region|province|state|country|island|archipelago|coast|peninsula|valley|mountain|lake|river|national park|nature reserve|capital|port|suburb|commune|department|prefecture|ward|borough|settlement|population|located in|situated in|lies in|part of)\b/i;
const NONPLACE_RE   = /\b(phrasebook|itinerary|travel topic|travel guide|travel warning|getting around|getting there|visa|currency|budget|accommodation|hostel|hotel tip|what to see|local cuisine|safety|scam)\b/i;

// ── STATE ──────────────────────────────────────────────────────────────────
let curMode = 'wiki', curLang = 'en';
let curTopics = new Set();
let swipeEnabled = true, rabbitHoleEnabled = false, kbBarEnabled = true;
let lightMode = false, depthLevel = 3, hapticEnabled = false;
let history = [];
let collections = []; // [{name:'Favorites', ids:['w123','w456']}, ...]
let activeCollection = null; // null = show all
let articles = [], liked = new Map(), queue = [];
let filling = false, hinted = false, sentinel = null;
let fillGeneration = 0;
let relatedInQueue = 0;
const MAX_RELATED_IN_QUEUE = 4;
const otdIds = new Set();

// ── LOCALSTORAGE ───────────────────────────────────────────────────────────
function lsGet(k)    { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } }
function lsSet(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} }

function loadPersistedState() {
  const savedLikes = lsGet('ws_liked');
  if (Array.isArray(savedLikes)) { savedLikes.forEach(a => liked.set(a.id, a)); updateBadge(); }
  // Hydrate from IDB as fallback (e.g. localStorage cleared but IDB survives)
  IDB.getAll().then(items => {
    let changed = false;
    items.forEach(a => { if (!liked.has(a.id)) { liked.set(a.id, a); changed = true; } });
    if (changed) { saveLiked(); updateBadge(); }
  });
  const savedTopics = lsGet('ws_topics');
  if (Array.isArray(savedTopics)) { curTopics = new Set(savedTopics); updateTopicBadge(); }
  const settings = lsGet('ws_settings') || {};
  swipeEnabled = settings.swipe !== false;
  rabbitHoleEnabled = settings.rabbitHole === true;
  kbBarEnabled = settings.kbBar !== false;
  lightMode = settings.lightMode === true;
  depthLevel = settings.depth || 3;
  hapticEnabled = settings.haptic === true;
  history = lsGet('ws_history') || [];
  collections = lsGet('ws_collections') || [];
  applyTheme();
  syncAllToggles();
}
function saveLiked()    { lsSet('ws_liked',    [...liked.values()]); }
function saveTopics()   { lsSet('ws_topics',   [...curTopics]); }
function saveSettings() { lsSet('ws_settings', { swipe: swipeEnabled, rabbitHole: rabbitHoleEnabled, kbBar: kbBarEnabled, lightMode: lightMode, depth: depthLevel, haptic: hapticEnabled }); }
function saveHistory()     { lsSet('ws_history', history.slice(0, 50)); }
function saveCollections() { lsSet('ws_collections', collections); }

// ── INDEXEDDB (offline cache for liked articles) ───────────────────────────
const IDB = (() => {
  let db = null;
  const open = () => new Promise((res, rej) => {
    if (db) return res(db);
    const req = indexedDB.open('wikiscroll', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('articles', {keyPath:'id'});
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror   = () => rej();
  });
  const tx = async (mode, fn) => {
    try { const d = await open(); fn(d.transaction('articles', mode).objectStore('articles')); } catch(e) { console.warn('IDB operation failed:', e); }
  };
  return {
    put:    a  => tx('readwrite', s => s.put(a)),
    delete: id => tx('readwrite', s => s.delete(id)),
    getAll: () => open().then(d => new Promise((res) => {
        const req = d.transaction('articles','readonly').objectStore('articles').getAll();
        req.onsuccess = () => res(req.result || []);
        req.onerror   = () => res([]);
      })).catch(() => []),
  };
})();

// ── HELPERS ────────────────────────────────────────────────────────────────
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function stripHtml(s) { return String(s||'').replace(/<[^>]+>/g,''); }
function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t); setTimeout(() => t.remove(), 2200);
}
function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

// ── AUTO-CATEGORY DETECTION ──────────────────────────────────────────────
function detectCategory(text) {
  const sample = (text||'').slice(0,600);
  for (const t of TOPICS) {
    if (t.valid && t.valid.test(sample)) return t;
  }
  return null;
}

// ── READING TIME ─────────────────────────────────────────────────────────
function readingTime(text) {
  const words = (text||'').trim().split(/\s+/).length;
  const mins = Math.max(1, Math.round(words / 200));
  return `${mins} min read`;
}

// ── DAILY STATS / STREAK ─────────────────────────────────────────────────
function todayKey() { return new Date().toISOString().slice(0,10); }
function loadStats() {
  const s = lsGet('ws_stats') || { date:'', count:0, streak:0, lastDate:'' };
  const today = todayKey();
  if (s.date !== today) {
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
    const yKey = yesterday.toISOString().slice(0,10);
    s.streak = (s.date === yKey) ? s.streak + 1 : 1;
    s.lastDate = s.date;
    s.date = today;
    s.count = 0;
    lsSet('ws_stats', s);
  }
  return s;
}
function bumpStat() {
  const s = loadStats();
  s.count++;
  lsSet('ws_stats', s);
  syncStreakDisplay();
}
function syncStreakDisplay() {
  const s = loadStats();
  ['streakCount','dkStreakCount'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = s.count;
  });
  ['streakLabel','dkStreakLabel'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = s.streak > 1 ? `· ${s.streak}-day streak` : '';
  });
  // Progress bar toward next milestone
  const next = [5,10,25,50,100,200].find(n => n > s.count) || 200;
  const prev = [0,5,10,25,50,100].reverse().find(n => n < next) || 0;
  const pct = Math.min(100, ((s.count - prev) / (next - prev)) * 100);
  ['streakProgress','dkStreakProgress'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.width = pct + '%';
  });
}

// ── THEME ──────────────────────────────────────────────────────────────────
function applyTheme() {
  document.body.classList.toggle('light', lightMode);
}

// ── HISTORY TRACKING ──────────────────────────────────────────────────────
function trackHistory(a) {
  // Remove duplicate if exists
  history = history.filter(h => h.id !== a.id);
  history.unshift({ id:a.id, src:a.src, title:a.title, body:a.body?.slice(0,150)||'', url:a.url, time:Date.now() });
  if (history.length > 50) history.length = 50;
  saveHistory();
}
function renderHistory() {
  const c = document.getElementById('historyList');
  if (!history.length) {
    c.innerHTML = '<div class="empty"><div class="empty-ico">📜</div><div class="empty-ttl">No history yet</div><div class="empty-txt">Articles you view will appear here so you can find them again.</div></div>';
    return;
  }
  const now = Date.now();
  c.innerHTML = history.map(h => {
    const ago = now - h.time;
    let timeStr;
    if (ago < 60000) timeStr = 'Just now';
    else if (ago < 3600000) timeStr = Math.floor(ago/60000) + 'm ago';
    else if (ago < 86400000) timeStr = Math.floor(ago/3600000) + 'h ago';
    else timeStr = Math.floor(ago/86400000) + 'd ago';
    return `<div class="hi" data-url="${esc(h.url)}">
      <div class="hi-time">${h.src==='wiki'?'📖':'🗺️'} ${timeStr}</div>
      <div class="hi-ttl">${esc(h.title)}</div>
      <div class="hi-body">${esc(h.body)}</div>
    </div>`;
  }).join('');
}

// ── COLLECTIONS ────────────────────────────────────────────────────────────
function renderCollTabs() {
  const c = document.getElementById('collTabs');
  const tabs = [{name:'All',id:null}].concat(collections.map((col,i) => ({name:col.name,id:i})));
  c.innerHTML = tabs.map(t => `<button class="coll-tab${activeCollection===t.id?' on':''}" data-cid="${t.id}">${esc(t.name)}${t.id!==null?' ('+collections[t.id].ids.length+')':''}</button>`).join('');
}
function createCollection(name) {
  name = name.trim();
  if (!name || collections.some(c => c.name.toLowerCase()===name.toLowerCase())) return;
  collections.push({name, ids:[]});
  saveCollections();
  renderCollTabs();
  toast('📁 Collection "'+name+'" created');
}
function addToCollection(colIdx, articleId) {
  const col = collections[colIdx];
  if (!col || col.ids.includes(articleId)) return;
  col.ids.push(articleId);
  saveCollections();
  renderLikedList();
  toast('Added to "'+col.name+'"');
}
function removeFromCollection(colIdx, articleId) {
  const col = collections[colIdx];
  if (!col) return;
  col.ids = col.ids.filter(id => id !== articleId);
  saveCollections();
  renderLikedList();
}
function deleteCollection(colIdx) {
  collections.splice(colIdx, 1);
  activeCollection = null;
  saveCollections();
  renderCollTabs();
  renderLikedList();
  toast('Collection deleted');
}

// ── DEPTH FILTERING ───────────────────────────────────────────────────────
// depthLevel 1-5: controls min extract length as proxy for article notability
// Level 1 = only well-developed articles (long extracts = notable)
// Level 5 = include very short stubs (obscure deep cuts)
function depthMinChars() {
  const map = {1:350, 2:200, 3:80, 4:50, 5:30};
  return map[depthLevel] || 80;
}

// ── OFFLINE DETECTION ─────────────────────────────────────────────────────
function updateOfflineBanner() {
  document.getElementById('offlineBanner')?.classList.toggle('show', !navigator.onLine);
}
window.addEventListener('online', updateOfflineBanner);
window.addEventListener('offline', updateOfflineBanner);

// ── SERVICE WORKER ────────────────────────────────────────────────────────
if ('serviceWorker' in navigator) {
  // Try external sw.js first (production), fall back to inline blob (development)
  navigator.serviceWorker.register('/sw.js', {scope:'/'}).catch(() => {
    // Fallback: inline service worker via blob URL
    const swCode = `
      const CACHE = 'wikiscroll-v3';
      const SHELL = ['/'];
      self.addEventListener('install', e => {
        e.waitUntil(caches.open(CACHE).then(c => c.addAll(SHELL)));
        self.skipWaiting();
      });
      self.addEventListener('activate', e => {
        e.waitUntil(caches.keys().then(keys => Promise.all(
          keys.filter(k => k !== CACHE).map(k => caches.delete(k))
        )));
        self.clients.claim();
      });
      self.addEventListener('fetch', e => {
        if (e.request.method !== 'GET') return;
        const url = new URL(e.request.url);
        if (url.origin === location.origin || url.hostname.includes('wikipedia.org') || url.hostname.includes('wikivoyage.org')) {
          e.respondWith(
            caches.open(CACHE).then(cache =>
              fetch(e.request).then(resp => {
                if (resp.ok) cache.put(e.request, resp.clone());
                return resp;
              }).catch(() => cache.match(e.request))
            )
          );
        }
      });
    `;
    try {
      const blob = new Blob([swCode], {type:'application/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob), {scope:'/'}).catch(()=>{});
    } catch(e) {}
  });
}

// ── NETWORK ────────────────────────────────────────────────────────────────
function fetchOne(url) {
  const ac = new AbortController(), id = setTimeout(() => ac.abort(), 8000);
  return fetch(url, {signal:ac.signal}).then(r => r.ok ? r.json() : null).catch(() => null).finally(() => clearTimeout(id));
}
function toArticle(d, prefix) {
  return { id: prefix+d.pageid, src: prefix==='w'?'wiki':'how', title: d.title, body: d.extract, img: d.thumbnail?.source||'', url: d.content_urls?.desktop?.page||'#' };
}

// ── ARTICLE VALIDATORS ────────────────────────────────────────────────────
function isValidTitle(t) { return t && !BAD_TITLE_RE.test(t.trim()); }
function isValidWikiPage(p, td) {
  if (!p?.thumbnail?.source) return false;
  const text = stripHtml(p.extract||'');
  const minLen = depthMinChars();
  if (text.length < minLen || !isValidTitle(p.title)) return false;
  if (td?.valid && !td.valid.test(text.slice(0,600))) return false;
  return true;
}
function wikiPageToArticle(p) {
  return { id:'w'+p.pageid, src:'wiki', title:p.title, body:stripHtml(p.extract||''), img:p.thumbnail.source, url:`https://en.wikipedia.org/wiki/${encodeURIComponent(p.title.replace(/ /g,'_'))}` };
}

// ── FETCH FUNCTIONS ────────────────────────────────────────────────────────
async function fetchWiki() {
  const url = `https://${curLang}.wikipedia.org/api/rest_v1/page/random/summary`;
  const all = await Promise.all(Array.from({length:12}, () => fetchOne(url)));
  const minLen = depthMinChars();
  return all.filter(d => d?.thumbnail?.source && (d.extract?.length||0) >= minLen && isValidTitle(d.title)).slice(0,5).map(d => toArticle(d,'w'));
}

async function fetchWikiByTopic() {
  const td = TOPIC_MAP[rand([...curTopics])];
  if (!td) return fetchWiki();
  for (let i=0; i<2; i++) {
    const cat = rand(td.cats);
    const url = ['https://en.wikipedia.org/w/api.php','?action=query','&generator=categorymembers',`&gcmtitle=${encodeURIComponent(cat)}`,'&gcmlimit=30','&gcmtype=page','&gcmnamespace=0','&prop=pageimages%7Cextracts','&exintro=1','&exchars=800','&piprop=thumbnail','&pithumbsize=500','&pilimit=30','&format=json','&origin=*'].join('');
    const data = await fetchOne(url);
    if (!data?.query?.pages) continue;
    const valid = Object.values(data.query.pages).filter(p => isValidWikiPage(p,td)).sort(() => Math.random()-.5).slice(0,5).map(wikiPageToArticle);
    if (valid.length >= 2) return valid;
  }
  return fetchWiki();
}

async function fetchVoyage() {
  const langs = curLang !== 'en' ? [curLang,'en'] : ['en'];
  for (const lang of langs) {
    // Topic-based Wikivoyage category fetch
    if (curTopics.size) {
      const vCats = [...curTopics].flatMap(tid => TOPIC_MAP[tid]?.vCats||[]);
      if (vCats.length) {
        const cat = rand(vCats);
        const url = ['https://en.wikivoyage.org/w/api.php','?action=query','&generator=categorymembers',`&gcmtitle=${encodeURIComponent(cat)}`,'&gcmlimit=25','&gcmtype=page','&gcmnamespace=0','&prop=pageimages%7Cextracts','&exintro=1','&exchars=600','&piprop=thumbnail','&pithumbsize=500','&pilimit=25','&format=json','&origin=*'].join('');
        const data = await fetchOne(url);
        if (data?.query?.pages) {
          const valid = Object.values(data.query.pages).filter(p => {
            if (!p?.thumbnail?.source || !isValidTitle(p.title)) return false;
            const s = stripHtml(p.extract||'').slice(0,500);
            return s.length >= 40 && GEO_RE.test(s) && !NONPLACE_RE.test(s);
          }).sort(() => Math.random()-.5).slice(0,5).map(p => ({
            id:'v'+p.pageid, src:'how', title:p.title, body:stripHtml(p.extract||''), img:p.thumbnail.source,
            url:`https://en.wikivoyage.org/wiki/${encodeURIComponent(p.title.replace(/ /g,'_'))}`,
          }));
          if (valid.length >= 2) return valid;
        }
      }
    }
    // Random fallback
    const url = `https://${lang}.wikivoyage.org/api/rest_v1/page/random/summary`;
    const all  = await Promise.all(Array.from({length:16}, () => fetchOne(url)));
    const good = all.filter(d => {
      if (!d?.thumbnail?.source || !isValidTitle(d.title) || d.extract?.length < 40) return false;
      const s = d.extract.slice(0,500);
      return GEO_RE.test(s) && !NONPLACE_RE.test(s);
    }).slice(0,5).map(d => toArticle(d,'v'));
    if (good.length) return good;
  }
  return [];
}

// ── RABBIT HOLE: FETCH RELATED ────────────────────────────────────────────
async function fetchRelated(article) {
  if (article.src !== 'wiki') return [];
  // Use the Action API to get pages linked from this article, with extracts+thumbnails
  const title = encodeURIComponent(article.title.replace(/ /g, '_'));
  const url = [
    `https://${curLang}.wikipedia.org/w/api.php`,
    '?action=query',
    `&titles=${title}`,
    '&generator=links',
    '&gpllimit=30',
    '&gplnamespace=0',
    '&prop=pageimages%7Cextracts',
    '&exintro=1',
    '&exchars=800',
    '&piprop=thumbnail',
    '&pithumbsize=500',
    '&pilimit=30',
    '&format=json',
    '&origin=*',
  ].join('');
  const data = await fetchOne(url);
  if (!data?.query?.pages) return [];
  const seenIds = new Set(articles.map(a => a.id).concat(queue.map(a => a.id)));
  return Object.values(data.query.pages)
    .filter(p => p?.thumbnail?.source && isValidTitle(p.title) && !seenIds.has('w'+p.pageid))
    .filter(p => {
      const text = stripHtml(p.extract||'');
      return text.length >= 80;
    })
    .sort(() => Math.random() - 0.5)
    .slice(0, 3)
    .map(p => ({
      id: 'w'+p.pageid, src: 'wiki', title: p.title,
      body: stripHtml(p.extract||''),
      img: p.thumbnail.source,
      url: `https://${curLang}.wikipedia.org/wiki/${encodeURIComponent(p.title.replace(/ /g,'_'))}`,
      _related: true,
    }));
}

async function goDeeper(articleId, btn) {
  if (btn.classList.contains('used')) return;
  if (relatedInQueue >= MAX_RELATED_IN_QUEUE) {
    toast('Rabbit hole is full — scroll a bit first');
    return;
  }
  const a = articles.find(x => x.id === articleId);
  if (!a) return;
  btn.textContent = '🐇 Digging…';
  btn.style.pointerEvents = 'none';
  try {
    const related = await fetchRelated(a);
    if (!related.length) {
      toast('No related articles found');
      btn.textContent = '🐇 Go deeper';
      btn.style.pointerEvents = '';
      return;
    }
    // Insert at positions 2-4 in the queue so there's a palette cleanser
    const insertAt = Math.min(2, queue.length);
    queue.splice(insertAt, 0, ...related);
    relatedInQueue += related.length;
    // Preload images
    related.forEach(art => { if (art.img) { const i = new Image(); i.src = art.img; } });
    btn.classList.add('used');
    btn.textContent = `🐇 ${related.length} added`;
    toast(`${related.length} related article${related.length>1?'s':''} queued`);
  } catch {
    btn.textContent = '🐇 Go deeper';
    btn.style.pointerEvents = '';
    toast('Failed to fetch related articles');
  }
}

// ── PREFETCH QUEUE ─────────────────────────────────────────────────────────
const QUEUE_MIN = 8;
async function fillQueue() {
  if (filling) return; filling = true;
  const gen = fillGeneration;
  try {
    const fn = curMode === 'wiki' ? (curTopics.size ? fetchWikiByTopic : fetchWiki) : fetchVoyage;
    const [a, b] = await Promise.all([fn(), fn()]);
    if (gen !== fillGeneration) return; // stale — mode/lang changed while awaiting
    const fresh = [...a,...b];
    queue.push(...fresh);
    fresh.forEach(art => { if (art.img) { const i=new Image(); i.src=art.img; } });
  } finally { filling = false; }
}

function flushQueue(n) {
  const batch = queue.splice(0, n||5);
  if (!batch.length) return;
  batch.forEach(a => { if (a._related) relatedInQueue = Math.max(0, relatedInQueue-1); });
  articles.push(...batch);
  batch.forEach(renderCard);
  if (!hinted && articles.length >= 2) {
    hinted = true;
    const h = document.getElementById('hint');
    h.style.display = 'flex';
    setTimeout(() => { h.style.display='none'; }, 5500);
  }
  attachSentinel();
  if (queue.length < QUEUE_MIN) fillQueue();
}

function attachSentinel() {
  sentinel?.disconnect();
  const cards = document.getElementById('feed').querySelectorAll('.card');
  if (cards.length < 4) return;
  sentinel = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) { sentinel.disconnect(); flushQueue(5); }
  }, {rootMargin:'0px 0px 400% 0px'});
  sentinel.observe(cards[cards.length-4]);
}

// ── DOM PRUNING ───────────────────────────────────────────────────────────
function pruneOldCards() {
  const feed = document.getElementById('feed');
  const cards = feed.querySelectorAll('.card');
  const idx = Math.round(feed.scrollTop / window.innerHeight);
  let pruned = 0;
  cards.forEach((card, i) => {
    if (i < idx - 12) { card.remove(); pruned++; }
  });
  if (pruned) attachSentinel();
}
let pruneTimer = null;
document.getElementById('feed').addEventListener('scroll', () => {
  clearTimeout(pruneTimer);
  pruneTimer = setTimeout(pruneOldCards, 400);
}, {passive:true});

// ── BOOT ───────────────────────────────────────────────────────────────────
async function boot() {
  fetchOnThisDay(); // fire and forget — populates otdIds in background
  try {
    await fillQueue();
    document.getElementById('spinner')?.remove();
    if (!queue.length) { showError(); return; }
    flushQueue(5);
  } catch(e) {
    console.error(e);
    document.getElementById('spinner')?.remove();
    showError();
  }
}

function resetFeed() {
  sentinel?.disconnect();
  fillGeneration++;
  articles=[]; queue=[]; hinted=false; filling=false; relatedInQueue=0;
  document.getElementById('hint').style.display = 'none';
  const isHow = curMode==='how';
  document.getElementById('feed').innerHTML = `<div class="spin-wrap" id="spinner"><div class="spin${isHow?' h':''}"></div><div class="spin-lbl">${isHow?'Loading destinations…':'Loading articles…'}</div></div>`;
  boot();
}

// ── RENDER ─────────────────────────────────────────────────────────────────
function renderCard(a) {
  const isHow   = a.src==='how', isLiked=liked.has(a.id);
  const pageid  = parseInt(a.id.slice(1));
  const isOTD   = a.src==='wiki' && otdIds.has(pageid);
  const img     = a.img ? `<img src="${esc(a.img)}" alt="" onerror="this.remove()">` : '';
  const artImg  = a.img ? `<img src="${esc(a.img)}" alt="" class="art-img" onerror="this.remove()">` : '';
  const cat     = detectCategory(a.body);
  const catHtml = cat ? `<span class="cat-tag">${cat.emoji} ${esc(cat.label)}</span>` : '';
  const rtHtml  = `<span class="read-time">⏱ ${readingTime(a.body)}</span>`;
  const card    = document.createElement('div');
  card.className = 'card'+(isHow?' how':'');
  card.dataset.id = a.id;
  card.innerHTML = `
    <div class="cbg">${img}<div class="cveil"></div></div>
    ${isOTD ? '<div class="otd-badge">📅 On This Day</div><div class="otd-star">⭐</div>' : ''}
    <div class="swipe-ind like-ind">❤️ Like</div>
    <div class="swipe-ind skip-ind">✕ Skip</div>
    <div class="panel">
      <div class="chip ${isHow?'h':'w'}">${isHow?'🗺️ Wikivoyage':'📖 Wikipedia'}</div>
      ${artImg}
      <div class="meta-row">${catHtml}${rtHtml}</div>
      <h2 class="art-title"></h2>
      <p class="art-body"></p>
      <div class="acts">
        <button class="act${isLiked?' liked':''}" id="lb-${esc(a.id)}">${isLiked?'❤️ Liked':'🤍 Like'}</button>
        <button class="act">📤 Share</button>
        <button class="act cta${isHow?' hcta':''}">${isHow?'📋':'📖'} Read Full Article</button>
      </div>
    </div>`;
  card.querySelector('.art-title').textContent = a.title;
  card.querySelector('.art-body').textContent  = a.body;
  const [likeBtn,shareBtn,readBtn] = card.querySelectorAll('.acts > .act');
  likeBtn.addEventListener('click',  () => toggleLike(a.id));
  shareBtn.addEventListener('click', () => doShare(a));
  readBtn.addEventListener('click',  () => window.open(a.url,'_blank'));
  // Wikivoyage: add floating map button at top-right of panel
  if (isHow) {
    const mapBtn = document.createElement('button');
    mapBtn.className = 'map-btn';
    mapBtn.title = 'Explore on Map';
    mapBtn.textContent = '🗺️';
    mapBtn.addEventListener('click', (e) => { e.stopPropagation(); openMap(a); });
    card.querySelector('.panel').appendChild(mapBtn);
  }
  // Rabbit Hole: add "Go deeper" button for wiki articles
  if (rabbitHoleEnabled && a.src === 'wiki') {
    const deeperRow = document.createElement('div');
    deeperRow.className = 'deeper-row';
    const deeperBtn = document.createElement('button');
    deeperBtn.className = 'act deeper';
    deeperBtn.textContent = '🐇 Go deeper';
    deeperBtn.addEventListener('click', () => goDeeper(a.id, deeperBtn));
    deeperRow.appendChild(deeperBtn);
    card.querySelector('.panel').appendChild(deeperRow);
  }
  document.getElementById('feed').appendChild(card);
  trackHistory(a);
}

function showError() {
  const isHow = curMode==='how';
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<div class="cbg"><div class="cveil"></div></div><div class="err"><div class="err-ico">${isHow?'🗺️':'📖'}</div><div class="err-ttl">Nothing loaded</div><div class="err-msg">${isHow?'Wikivoyage':'Wikipedia'} didn't respond.</div><button class="err-btn">Try again</button></div>`;
  card.querySelector('.err-btn').addEventListener('click', resetFeed);
  document.getElementById('feed').appendChild(card);
}

// ── LIKES + IDB ────────────────────────────────────────────────────────────
function toggleLike(id) {
  const a = articles.find(x => x.id===id); if (!a) return;
  const wasLiked = liked.has(id);
  if (wasLiked) { liked.delete(id); IDB.delete(id); }
  else          { liked.set(id, a); IDB.put(a); }
  saveLiked(); updateBadge();
  const btn = document.getElementById('lb-'+id);
  if (btn) {
    const on = liked.has(id);
    if (on) {
      // Liking: instant class + text
      btn.className = 'act liked';
      btn.textContent = '❤️ Liked';
    } else {
      // Unliking: remove class first (starts CSS transition), then swap text after a frame
      btn.className = 'act';
      requestAnimationFrame(() => { btn.textContent = '🤍 Like'; });
    }
  }
}
function removeLike(id) {
  liked.delete(id); IDB.delete(id); saveLiked(); updateBadge();
  const btn = document.getElementById('lb-'+id);
  if (btn) { btn.className='act'; requestAnimationFrame(() => { btn.textContent='🤍 Like'; }); }
  renderLikedList();
}
function updateBadge() {
  const n = liked.size;
  ['badge','burgerBadge'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.textContent=n; el.style.display=n?'inline-block':'none'; }
  });
  const dot = document.getElementById('burgerDot');
  if (dot) dot.style.display = (n||curTopics.size) ? 'block' : 'none';
}
function updateTopicBadge() {
  const n = curTopics.size;
  const tb = document.getElementById('topicBadge');
  if (tb) { tb.textContent=n; tb.style.display=n?'inline-block':'none'; }
  const bb = document.getElementById('burgerTopicsBtn');
  if (bb) bb.className='burger-action'+(n?' active':'');
  const dtb = document.getElementById('topicsBtn');
  if (dtb) dtb.style.background = n?'rgba(102,126,234,.18)':'';
  const dot = document.getElementById('burgerDot');
  if (dot) dot.style.display = (liked.size||n) ? 'block' : 'none';
}

function renderLikedList() {
  renderCollTabs();
  const c = document.getElementById('likedList');
  let items = [...liked.values()].reverse();
  // Filter by active collection
  if (activeCollection !== null && collections[activeCollection]) {
    const ids = new Set(collections[activeCollection].ids);
    items = items.filter(a => ids.has(a.id));
  }
  if (!items.length) {
    const msg = activeCollection !== null
      ? 'No articles in this collection yet. Add some from the "All" tab.'
      : 'Like articles while scrolling to save them here. They\'ll be available offline too.';
    const ico = activeCollection !== null ? '📁' : '🔖';
    const ttl = activeCollection !== null ? 'Empty collection' : 'Nothing saved yet';
    c.innerHTML = `<div class="empty"><div class="empty-ico">${ico}</div><div class="empty-ttl">${ttl}</div><div class="empty-txt">${msg}</div></div>`;
    if (activeCollection !== null) {
      c.innerHTML += `<div style="text-align:center;margin-top:12px;"><button class="li-btn" id="deleteCollBtn" style="color:#f87171;">Delete this collection</button></div>`;
    }
    return;
  }
  const offline = !navigator.onLine;
  // Build collection assignment dropdown HTML
  const collOpts = collections.map((col,i) => `<button class="coll-assign" data-addcoll="${i}" data-aid="ARTID">📁 ${esc(col.name)}</button>`).join('');
  c.innerHTML = items.map(a => {
    const inColls = collections.filter(col => col.ids.includes(a.id)).map(col => col.name);
    const collLabel = inColls.length ? `<div style="font-size:10px;color:#a5b4fc;margin-bottom:4px;">📁 ${esc(inColls.join(', '))}</div>` : '';
    const opts = collOpts.replaceAll('ARTID', esc(a.id));
    return `<div class="li">
      <div class="li-src">${a.src==='wiki'?'📖 Wikipedia':'🗺️ Wikivoyage'}</div>
      ${offline ? '<div class="li-offline">✓ Available offline</div>' : ''}
      ${collLabel}
      <div class="li-ttl">${esc(a.title)}</div>
      <div class="li-body">${esc(a.body.slice(0,130))}</div>
      <div class="li-acts">
        <button class="li-btn" data-read="${esc(a.url)}">Read</button>
        <button class="li-btn" data-share-url="${esc(a.url)}" data-share-title="${esc(a.title)}">Share</button>
        ${opts}
        <button class="li-btn" data-unlike="${esc(a.id)}">Remove</button>
      </div>
    </div>`;
  }).join('');
  if (activeCollection !== null) {
    c.innerHTML += `<div style="text-align:center;margin-top:12px;"><button class="li-btn" id="deleteCollBtn" style="color:#f87171;">Delete this collection</button></div>`;
  }
}
document.getElementById('likedList').addEventListener('click', ev => {
  const btn = ev.target.closest('.li-btn,.coll-assign'); if (!btn) return;
  if      (btn.dataset.read)     window.open(btn.dataset.read,'_blank');
  else if (btn.dataset.unlike)   removeLike(btn.dataset.unlike);
  else if (btn.dataset.shareUrl) doShare({url: btn.dataset.shareUrl, title: btn.dataset.shareTitle});
  else if (btn.dataset.addcoll !== undefined) addToCollection(parseInt(btn.dataset.addcoll), btn.dataset.aid);
  if (btn.id === 'deleteCollBtn' && activeCollection !== null) deleteCollection(activeCollection);
});
document.getElementById('collTabs').addEventListener('click', ev => {
  const tab = ev.target.closest('.coll-tab'); if (!tab) return;
  const cid = tab.dataset.cid;
  activeCollection = cid === 'null' ? null : parseInt(cid);
  renderLikedList();
});
document.getElementById('collNewBtn').addEventListener('click', () => {
  const input = document.getElementById('collNewInput');
  createCollection(input.value);
  input.value = '';
});
document.getElementById('collNewInput').addEventListener('keydown', ev => {
  if (ev.key === 'Enter') { createCollection(ev.target.value); ev.target.value = ''; }
});

// ── SHARE ──────────────────────────────────────────────────────────────────
function doShare(a) {
  // a can be an article object or {url, title} from liked list
  const url = a.url, title = a.title;
  if (!a.body) {
    // Simple share (from liked list with no body context)
    if (navigator.share) navigator.share({title,url}).catch(()=>{});
    else if (navigator.clipboard) navigator.clipboard.writeText(url).then(()=>toast('Link copied!')).catch(()=>{});
    return;
  }
  // Offer image share
  openShareImage(a);
}

function openShareImage(a) {
  const canvas = document.createElement('canvas');
  const W = 1080, H = 1350;
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d');

  // Background gradient
  const isHow = a.src === 'how';
  const grd = ctx.createLinearGradient(0, 0, W, H);
  if (isHow) { grd.addColorStop(0, '#0a1a18'); grd.addColorStop(0.5, '#0d2420'); grd.addColorStop(1, '#071510'); }
  else       { grd.addColorStop(0, '#0a0a18'); grd.addColorStop(0.5, '#141028'); grd.addColorStop(1, '#0d0820'); }
  ctx.fillStyle = grd;
  ctx.fillRect(0, 0, W, H);

  // Decorative gradient orbs
  const orb1 = ctx.createRadialGradient(W*0.25, H*0.2, 0, W*0.25, H*0.2, 400);
  orb1.addColorStop(0, isHow ? 'rgba(17,153,142,.15)' : 'rgba(102,126,234,.15)');
  orb1.addColorStop(1, 'transparent');
  ctx.fillStyle = orb1; ctx.fillRect(0, 0, W, H);
  const orb2 = ctx.createRadialGradient(W*0.8, H*0.7, 0, W*0.8, H*0.7, 350);
  orb2.addColorStop(0, isHow ? 'rgba(56,239,125,.08)' : 'rgba(118,75,162,.1)');
  orb2.addColorStop(1, 'transparent');
  ctx.fillStyle = orb2; ctx.fillRect(0, 0, W, H);

  // Source badge
  ctx.fillStyle = isHow ? 'rgba(17,153,142,.2)' : 'rgba(102,126,234,.2)';
  const badgeText = isHow ? '🗺️  WIKIVOYAGE' : '📖  WIKIPEDIA';
  ctx.font = '600 28px "DM Sans", sans-serif';
  const bw = ctx.measureText(badgeText).width + 48;
  const bx = (W - bw) / 2, by = 100;
  ctx.beginPath();
  ctx.roundRect(bx, by, bw, 52, 26);
  ctx.fill();
  ctx.fillStyle = isHow ? '#6ee7b7' : '#a5b4fc';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(badgeText, W/2, by+26);

  // Category tag
  const cat = detectCategory(a.body);
  if (cat) {
    ctx.font = '500 24px "DM Sans", sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,.35)';
    ctx.fillText(`${cat.emoji}  ${cat.label}`, W/2, by + 90);
  }

  // Title — word-wrap
  ctx.fillStyle = '#ffffff';
  ctx.font = '800 64px "Syne", sans-serif';
  ctx.textAlign = 'center';
  const titleY = cat ? 300 : 260;
  const titleLines = wrapText(ctx, a.title, W - 140, 64);
  titleLines.forEach((line, i) => {
    ctx.fillText(line, W/2, titleY + i * 78);
  });

  // Excerpt — word-wrap
  const excerptY = titleY + titleLines.length * 78 + 50;
  ctx.fillStyle = 'rgba(255,255,255,.55)';
  ctx.font = '400 30px "DM Sans", sans-serif';
  const bodyLines = wrapText(ctx, a.body.slice(0, 400), W - 140, 30);
  bodyLines.slice(0, 8).forEach((line, i) => {
    ctx.fillText(line, W/2, excerptY + i * 46);
  });

  // Bottom branding
  ctx.fillStyle = 'rgba(255,255,255,.2)';
  ctx.font = '700 26px "Syne", sans-serif';
  ctx.fillText('WikiScroll', W/2, H - 100);
  ctx.font = '400 20px "DM Sans", sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,.15)';
  ctx.fillText('wikiscroll.com', W/2, H - 65);

  // Divider line
  ctx.strokeStyle = 'rgba(255,255,255,.06)';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(W*0.3, H-130); ctx.lineTo(W*0.7, H-130); ctx.stroke();

  // Show preview
  const dataUrl = canvas.toDataURL('image/png');
  const preview = document.getElementById('shareImgPreview');
  preview.src = dataUrl;
  document.getElementById('shareImgOverlay').classList.add('open');
  // Store for share/download
  preview._canvas = canvas;
  preview._article = a;
}

function wrapText(ctx, text, maxW, fontSize) {
  const words = text.split(/\s+/);
  const lines = [];
  let cur = '';
  for (const w of words) {
    const test = cur ? cur + ' ' + w : w;
    if (ctx.measureText(test).width > maxW && cur) {
      lines.push(cur);
      cur = w;
    } else cur = test;
  }
  if (cur) lines.push(cur);
  return lines;
}

// Share image overlay events
document.getElementById('shareImgClose').addEventListener('click', () => {
  document.getElementById('shareImgOverlay').classList.remove('open');
});
document.getElementById('shareImgOverlay').addEventListener('click', ev => {
  if (ev.target === ev.currentTarget) ev.currentTarget.classList.remove('open');
});
document.getElementById('shareImgDownload').addEventListener('click', () => {
  const preview = document.getElementById('shareImgPreview');
  const link = document.createElement('a');
  link.download = `wikiscroll-${(preview._article?.title||'card').replace(/\s+/g,'-').slice(0,40)}.png`;
  link.href = preview.src;
  link.click();
  toast('Image saved!');
});
document.getElementById('shareImgShare').addEventListener('click', async () => {
  const preview = document.getElementById('shareImgPreview');
  const a = preview._article;
  if (navigator.share && navigator.canShare) {
    try {
      const blob = await new Promise(r => preview._canvas.toBlob(r, 'image/png'));
      const file = new File([blob], 'wikiscroll.png', {type:'image/png'});
      if (navigator.canShare({files:[file]})) {
        await navigator.share({title: a?.title||'WikiScroll', text: a?.title, url: a?.url, files:[file]});
      } else {
        await navigator.share({title: a?.title||'WikiScroll', url: a?.url});
      }
    } catch(e) { if (e.name!=='AbortError') toast('Share failed'); }
  } else if (a?.url) {
    if (navigator.clipboard) navigator.clipboard.writeText(a.url).then(()=>toast('Link copied!')).catch(()=>{});
  }
  document.getElementById('shareImgOverlay').classList.remove('open');
});

// ── ON THIS DAY ────────────────────────────────────────────────────────────
async function fetchOnThisDay() {
  try {
    const now = new Date();
    const data = await fetchOne(`https://en.wikipedia.org/api/rest_v1/feed/onthisday/events/${now.getMonth()+1}/${now.getDate()}`);
    (data?.events||[]).forEach(ev => (ev.pages||[]).forEach(p => { if (p.pageid) otdIds.add(p.pageid); }));
    // Badge any already-rendered cards that match
    document.getElementById('feed').querySelectorAll('.card').forEach(card => {
      const a = articles.find(x => x.id===card.dataset.id);
      if (a?.src==='wiki' && otdIds.has(parseInt(a.id.slice(1))) && !card.querySelector('.otd-badge')) {
        const badge = document.createElement('div');
        badge.className = 'otd-badge'; badge.textContent = '📅 On This Day';
        card.appendChild(badge);
        const star = document.createElement('div');
        star.className = 'otd-star'; star.textContent = '⭐';
        card.appendChild(star);
      }
    });
  } catch {}
}

// ── TOPICS ─────────────────────────────────────────────────────────────────
function buildTopicChips(container, cls) {
  container.innerHTML = TOPICS.map(t => `<button class="${cls}${curTopics.has(t.id)?' on':''}" data-tid="${t.id}">${t.emoji} ${t.label}</button>`).join('');
}
function toggleTopic(id) {
  curTopics.has(id) ? curTopics.delete(id) : curTopics.add(id);
  saveTopics(); updateTopicBadge();
  document.querySelectorAll('[data-tid]').forEach(el => el.classList.toggle('on', curTopics.has(el.dataset.tid)));
  resetFeed();
}

buildTopicChips(document.getElementById('topicGrid'),      'topic-chip');
buildTopicChips(document.getElementById('burgerTopicGrid'),'btopic');

document.getElementById('topicGrid').addEventListener('click', ev => {
  const c = ev.target.closest('.topic-chip'); if (c) toggleTopic(c.dataset.tid);
});
document.getElementById('burgerTopicGrid').addEventListener('click', ev => {
  const c = ev.target.closest('.btopic'); if (c) toggleTopic(c.dataset.tid);
});
document.getElementById('sheetReset').addEventListener('click', () => {
  curTopics.clear(); saveTopics(); updateTopicBadge();
  document.querySelectorAll('[data-tid]').forEach(el => el.classList.remove('on'));
  resetFeed();
});
function openTopicSheet()  { document.getElementById('topicSheet').classList.add('open');    document.getElementById('sheetOverlay').classList.add('open'); }
function closeTopicSheet() { document.getElementById('topicSheet').classList.remove('open'); document.getElementById('sheetOverlay').classList.remove('open'); }
document.getElementById('topicsBtn').addEventListener('click',    openTopicSheet);
document.getElementById('sheetOverlay').addEventListener('click', closeTopicSheet);

// ── LANGUAGE ───────────────────────────────────────────────────────────────
const desktopLangDd = document.getElementById('langDd');
const burgerLangGrid = document.getElementById('burgerLangGrid');

desktopLangDd.innerHTML  = LANGS.map(l => `<div class="lopt${l.c===curLang?' sel':''}" data-c="${l.c}">${l.f} ${l.n}</div>`).join('');
burgerLangGrid.innerHTML = LANGS.map(l => `<button class="blopt${l.c===curLang?' sel':''}" data-c="${l.c}">${l.f} ${l.n}</button>`).join('');

function setLang(c) {
  curLang = c;
  const lang = LANGS.find(l => l.c===c);
  if (lang) { document.getElementById('langTxt').textContent = lang.n; document.getElementById('burgerLangTxt').textContent = lang.n; }
  desktopLangDd.querySelectorAll('.lopt').forEach(o  => o.classList.toggle('sel',  o.dataset.c===curLang));
  burgerLangGrid.querySelectorAll('.blopt').forEach(o => o.classList.toggle('sel', o.dataset.c===curLang));
  resetFeed();
}

document.getElementById('langBtn').addEventListener('click', ev => { ev.stopPropagation(); desktopLangDd.classList.toggle('open'); });
desktopLangDd.addEventListener('click', ev => { const o=ev.target.closest('.lopt'); if(o){setLang(o.dataset.c);desktopLangDd.classList.remove('open');} });
document.addEventListener('click', ev => { if (!ev.target.closest('.lang-wrap')) desktopLangDd.classList.remove('open'); });

burgerLangGrid.addEventListener('click', ev => {
  const o = ev.target.closest('.blopt');
  if (!o) return;
  setLang(o.dataset.c);
  burgerLangGrid.classList.remove('open');
  document.getElementById('burgerLangBtn').textContent = 'Change ›';
});
document.getElementById('burgerLangBtn').addEventListener('click', ev => {
  ev.stopPropagation();
  const isOpen = burgerLangGrid.classList.toggle('open');
  ev.currentTarget.textContent = isOpen ? 'Close ✕' : 'Change ›';
});

// ── MODE TOGGLE ─────────────────────────────────────────────────────────────
function setMode(m) {
  if (curMode===m) return; curMode=m;
  const isHow = m==='how';
  document.getElementById('wBtn').className = 'tbtn'+(isHow?'':' won on');
  document.getElementById('hBtn').className = 'tbtn'+(isHow?' hon on':'');
  document.body.classList.toggle('how', isHow);
  resetFeed();
}
document.getElementById('wBtn').addEventListener('click', () => setMode('wiki'));
document.getElementById('hBtn').addEventListener('click', () => setMode('how'));

// ── BURGER ─────────────────────────────────────────────────────────────────
function closeBurger() {
  document.getElementById('burgerMenu').classList.remove('open');
  document.getElementById('burgerBackdrop').classList.remove('open');
  burgerLangGrid.classList.remove('open');
  document.getElementById('burgerLangBtn').textContent = 'Change ›';
  document.getElementById('burgerTopics').classList.remove('open');
  document.getElementById('burgerTopicsBtn').textContent = 'Filter ›';
}
function openBurger() {
  document.getElementById('burgerMenu').classList.add('open');
  document.getElementById('burgerBackdrop').classList.add('open');
}
document.getElementById('burgerBtn').addEventListener('click', ev => {
  ev.stopPropagation();
  const menu = document.getElementById('burgerMenu');
  if (menu.classList.contains('open')) closeBurger();
  else openBurger();
});
document.getElementById('burgerBackdrop').addEventListener('click', closeBurger);
document.getElementById('burgerTopicsBtn').addEventListener('click', ev => {
  ev.stopPropagation();
  const isOpen = document.getElementById('burgerTopics').classList.toggle('open');
  ev.currentTarget.textContent = isOpen ? 'Close ✕' : 'Filter ›';
});
document.getElementById('burgerLikesBtn').addEventListener('click', () => { closeBurger(); document.getElementById('lp').classList.add('open'); document.getElementById('spBackdrop').classList.add('open'); renderLikedList(); });

// ── SETTINGS ───────────────────────────────────────────────────────────────
function syncDepthSteps() {
  document.querySelectorAll('.depth-steps').forEach(container => {
    container.querySelectorAll('.depth-step').forEach(step => {
      step.classList.toggle('active', parseInt(step.dataset.d) === depthLevel);
    });
  });
}
function syncAllToggles() {
  // Swipe — mobile + desktop
  document.getElementById('swipeToggle')?.classList.toggle('on', swipeEnabled);
  document.getElementById('dkSwipeToggle')?.classList.toggle('on', swipeEnabled);
  // Rabbit Hole — mobile + desktop
  document.getElementById('rabbitToggle')?.classList.toggle('on', rabbitHoleEnabled);
  document.getElementById('dkRabbitToggle')?.classList.toggle('on', rabbitHoleEnabled);
  // KB bar — desktop only
  document.getElementById('dkKbToggle')?.classList.toggle('on', kbBarEnabled);
  // Theme — mobile + desktop
  document.getElementById('themeToggle')?.classList.toggle('on', lightMode);
  document.getElementById('dkThemeToggle')?.classList.toggle('on', lightMode);
  // Haptic — mobile + desktop
  document.getElementById('hapticToggle')?.classList.toggle('on', hapticEnabled);
  document.getElementById('dkHapticToggle')?.classList.toggle('on', hapticEnabled);
  // Depth — mobile + desktop
  const ds1 = document.getElementById('depthSlider');
  const ds2 = document.getElementById('dkDepthSlider');
  if (ds1) ds1.value = depthLevel;
  if (ds2) ds2.value = depthLevel;
  syncDepthSteps();
}
function setSwipe(val) { swipeEnabled=val; saveSettings(); syncAllToggles(); }
function setRabbit(val) {
  rabbitHoleEnabled=val; saveSettings(); syncAllToggles();
  toast(rabbitHoleEnabled ? '🐇 Rabbit Hole enabled' : 'Rabbit Hole disabled');
  if (rabbitHoleEnabled) resetFeed();
}
function setKbBar(val) { kbBarEnabled=val; saveSettings(); syncAllToggles(); }
function setTheme(val) { lightMode=val; saveSettings(); applyTheme(); syncAllToggles(); }
function setDepth(val) { depthLevel=parseInt(val)||3; saveSettings(); syncAllToggles(); resetFeed(); }

// Mobile toggles
document.getElementById('swipeToggle').addEventListener('click', () => setSwipe(!swipeEnabled));
document.getElementById('rabbitToggle').addEventListener('click', () => setRabbit(!rabbitHoleEnabled));

// Desktop settings panel toggles
document.getElementById('dkSwipeToggle').addEventListener('click', () => setSwipe(!swipeEnabled));
document.getElementById('dkRabbitToggle').addEventListener('click', () => setRabbit(!rabbitHoleEnabled));
document.getElementById('dkKbToggle').addEventListener('click', () => setKbBar(!kbBarEnabled));

// Theme toggles
document.getElementById('themeToggle').addEventListener('click', () => setTheme(!lightMode));
document.getElementById('dkThemeToggle').addEventListener('click', () => setTheme(!lightMode));

// Haptic feedback
function setHaptic(val) { hapticEnabled=val; saveSettings(); syncAllToggles(); toast(hapticEnabled ? '📳 Haptic feedback enabled' : 'Haptic feedback disabled'); }
document.getElementById('hapticToggle').addEventListener('click', () => setHaptic(!hapticEnabled));
document.getElementById('dkHapticToggle').addEventListener('click', () => setHaptic(!hapticEnabled));

// iOS haptic workaround: need <input type="checkbox" switch> + <label>, click the LABEL
// Based on ios-haptics library pattern (Safari 17.4+ / iOS 18+)
const _hapticId = 'ws-haptic-cb';
const _hapticInput = document.createElement('input');
_hapticInput.type = 'checkbox';
_hapticInput.id = _hapticId;
_hapticInput.setAttribute('switch', '');
_hapticInput.style.cssText = 'position:fixed;top:-200px;left:-200px;opacity:0;pointer-events:none;';
const _hapticLabel = document.createElement('label');
_hapticLabel.htmlFor = _hapticId;
_hapticLabel.style.cssText = 'position:fixed;top:-200px;left:-200px;opacity:0;pointer-events:none;';
document.body.appendChild(_hapticInput);
document.body.appendChild(_hapticLabel);

function triggerHaptic() {
  if (!hapticEnabled) return;
  // Android: Vibration API
  if (navigator.vibrate) { navigator.vibrate(12); return; }
  // iOS: click the label associated with the switch checkbox
  // This triggers Safari's native haptic feedback for switch toggles
  try { _hapticLabel.click(); } catch {}
}

// Depth sliders — sync both sliders + step indicators on drag
document.getElementById('depthSlider').addEventListener('input', ev => {
  document.getElementById('dkDepthSlider').value = ev.target.value;
  depthLevel = parseInt(ev.target.value); syncDepthSteps();
});
document.getElementById('depthSlider').addEventListener('change', ev => setDepth(ev.target.value));
document.getElementById('dkDepthSlider').addEventListener('input', ev => {
  document.getElementById('depthSlider').value = ev.target.value;
  depthLevel = parseInt(ev.target.value); syncDepthSteps();
});
document.getElementById('dkDepthSlider').addEventListener('change', ev => setDepth(ev.target.value));

// Depth step labels are clickable too
document.querySelectorAll('.depth-steps').forEach(container => {
  container.addEventListener('click', ev => {
    const step = ev.target.closest('.depth-step');
    if (!step) return;
    const val = parseInt(step.dataset.d);
    document.getElementById('depthSlider').value = val;
    document.getElementById('dkDepthSlider').value = val;
    setDepth(val);
  });
});

// History panel
document.getElementById('burgerHistoryBtn').addEventListener('click', () => { closeBurger(); document.getElementById('hp').classList.add('open'); document.getElementById('spBackdrop').classList.add('open'); renderHistory(); });
document.getElementById('hpClose').addEventListener('click', closeAllPanels);
document.getElementById('historyList').addEventListener('click', ev => {
  const hi = ev.target.closest('.hi'); if (!hi?.dataset.url) return;
  window.open(hi.dataset.url, '_blank');
});

// Desktop settings panel open/close
function openSettings()  {
  document.getElementById('settingsPanel').classList.add('open');
  document.getElementById('spBackdrop').classList.add('open');
  syncStreakDisplay();
}
function closeSettings() {
  document.getElementById('settingsPanel').classList.remove('open');
  document.getElementById('spBackdrop').classList.remove('open');
}
function closeAllPanels() {
  closeSettings();
  document.getElementById('lp').classList.remove('open');
  document.getElementById('hp').classList.remove('open');
  document.getElementById('spBackdrop').classList.remove('open');
}
document.getElementById('settingsBtn').addEventListener('click', () => {
  const panel = document.getElementById('settingsPanel');
  if (panel.classList.contains('open')) closeAllPanels();
  else { closeAllPanels(); openSettings(); }
});
document.getElementById('spClose').addEventListener('click', closeAllPanels);
document.getElementById('spBackdrop').addEventListener('click', closeAllPanels);

// ── HEADER BUTTONS ──────────────────────────────────────────────────────────
document.getElementById('likesBtn').addEventListener('click', () => {
  const lp = document.getElementById('lp');
  if (lp.classList.contains('open')) { closeAllPanels(); return; }
  closeAllPanels();
  lp.classList.add('open');
  document.getElementById('spBackdrop').classList.add('open');
  renderLikedList();
});
document.getElementById('lpClose').addEventListener('click', closeAllPanels);

// Privacy policy modal
function openPrivacy() {
  closeSettings(); closeBurger();
  document.getElementById('privacyOverlay').classList.add('open');
}
document.getElementById('privacyClose').addEventListener('click', () => document.getElementById('privacyOverlay').classList.remove('open'));
document.getElementById('privacyOverlay').addEventListener('click', function(ev) { if(ev.target===this) this.classList.remove('open'); });
document.getElementById('privacyLinkSettings').addEventListener('click', ev => { ev.preventDefault(); openPrivacy(); });
document.getElementById('burgerPrivacyLink')?.addEventListener('click', ev => { ev.preventDefault(); closeBurger(); openPrivacy(); });
document.addEventListener('keydown', ev => {
  if (ev.key!=='Escape') return;
  document.getElementById('privacyOverlay').classList.remove('open');
  document.getElementById('shareImgOverlay').classList.remove('open');
  document.getElementById('mapOverlay').classList.remove('open');
  closeAllPanels(); closeBurger(); closeTopicSheet(); closeAmbient();
  document.getElementById('feed').focus();
});

// ── AMBIENT MODE ───────────────────────────────────────────────────────────
function openAmbient(card) {
  const a = articles.find(x => x.id===card.dataset.id); if (!a) return;
  document.getElementById('ambientTitle').textContent   = a.title;
  document.getElementById('ambientExcerpt').textContent = a.body;
  const bg = document.getElementById('ambientBg');
  bg.style.backgroundImage = a.img ? `url("${a.img.replace(/[\\"()]/g, '\\$&')}")` : '';
  const ov = document.getElementById('ambientOverlay');
  ov.classList.add('open');
}

function closeAmbient() {
  const ov = document.getElementById('ambientOverlay');
  if (!ov.classList.contains('open')) return;
  ov.classList.remove('open');
  document.getElementById('feed').focus();
}

document.getElementById('ambientOverlay').addEventListener('click', ev => {
  if (!ev.target.closest('.ambient-content,.ambient-close')) closeAmbient();
});
document.getElementById('ambientClose').addEventListener('click', closeAmbient);

// ── SWIPE GESTURES + LONG PRESS ────────────────────────────────────────────
(function() {
  const feed = document.getElementById('feed');
  let startX=0, startY=0, curDx=0;
  let activeCard=null, swiping=false, lpTimer=null;
  let flyLock = false;

  function curCard() {
    const idx = Math.round(feed.scrollTop/window.innerHeight);
    return feed.querySelectorAll('.card')[idx]||null;
  }
  function ind(card, cls) { return card?.querySelector('.'+cls); }

  function applyDrag(card, dx) {
    // Pure GPU transform — no JS layout triggers
    const rot = dx * 0.035;
    card.style.transition = 'none';
    card.style.transform = `translateX(${dx}px) rotate(${rot}deg) translateZ(0)`;
    const p = Math.min(Math.abs(dx)/90, 1);
    const li = ind(card,'like-ind'), si = ind(card,'skip-ind');
    if (dx > 0) { if(li)li.style.opacity=p; if(si)si.style.opacity=0; }
    else         { if(si)si.style.opacity=p; if(li)li.style.opacity=0; }
  }

  function springBack(card) {
    card.style.transition = 'transform .4s cubic-bezier(.175,.885,.32,1.275)';
    card.style.transform = 'translateZ(0)';
    const li = ind(card,'like-ind'), si = ind(card,'skip-ind');
    if(li){ li.style.transition='opacity .25s'; li.style.opacity=0; }
    if(si){ si.style.transition='opacity .25s'; si.style.opacity=0; }
  }

  function resetCard(card) {
    card.style.transition = 'none';
    card.style.transform = '';
    card.style.opacity = '';
    const li = ind(card,'like-ind'), si = ind(card,'skip-ind');
    if(li){ li.style.transition=''; li.style.opacity=0; }
    if(si){ si.style.transition=''; si.style.opacity=0; }
    void card.offsetWidth; // force reflow to commit reset
    card.style.transition = '';
  }

  function advanceFeed() {
    const nextTop = (Math.round(feed.scrollTop / window.innerHeight) + 1) * window.innerHeight;
    feed.style.scrollSnapType = 'none';
    feed.style.webkitScrollSnapType = 'none';
    feed.scrollTop = nextTop;
    // Double-rAF ensures the browser commits the scroll position before re-enabling snap
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        feed.style.scrollSnapType = '';
        feed.style.webkitScrollSnapType = '';
      });
    });
  }

  function flyOff(card, dir) {
    if (flyLock) return;
    flyLock = true;

    // 1) Flash indicator instantly
    const li = ind(card,'like-ind'), si = ind(card,'skip-ind');
    if (dir > 0) { if(li){li.style.transition='none';li.style.opacity='1';} if(si)si.style.opacity='0'; }
    else          { if(si){si.style.transition='none';si.style.opacity='1';} if(li)li.style.opacity='0'; }

    // 2) Like on right
    if (dir > 0) toggleLike(card.dataset.id);

    // 3) Fly off — single GPU transition
    requestAnimationFrame(() => {
      const dist = dir > 0 ? 110 : -110;
      const rot = dir > 0 ? 8 : -8;
      card.style.transition = 'transform .45s cubic-bezier(.32,.94,.6,1), opacity .35s ease-out';
      card.style.transform = `translateX(${dist}vw) rotate(${rot}deg) translateZ(0)`;
      card.style.opacity = '0';

      // 4) Glow flash on next card
      const nextIdx = Math.round(feed.scrollTop/window.innerHeight) + 1;
      const nextCard = feed.querySelectorAll('.card')[nextIdx];
      if (nextCard) {
        let flash = nextCard.querySelector('.swipe-flash');
        if (!flash) {
          flash = document.createElement('div');
          flash.className = 'swipe-flash';
          nextCard.appendChild(flash);
        }
        flash.classList.remove('like','skip','show');
        void flash.offsetWidth;
        flash.classList.add(dir > 0 ? 'like' : 'skip', 'show');
        setTimeout(() => flash.classList.remove('show'), 600);
      }

      // 5) Wait for transition to end, then advance
      let done = false;
      const finish = () => {
        if (done) return;
        done = true;
        card.removeEventListener('transitionend', finish);
        advanceFeed();
        // Reset card after it's scrolled away
        requestAnimationFrame(() => {
          resetCard(card);
          flyLock = false;
        });
      };
      card.addEventListener('transitionend', finish, {once:true});
      // Safety timeout — transitionend can fail on fast tabs or GPU glitches
      setTimeout(finish, 550);
    });
  }

  document.addEventListener('touchstart', ev => {
    if (ev.touches.length>1) return;
    const card = ev.target.closest('.card');
    if (!card || ev.target.closest('button,.acts')) return;
    startX=ev.touches[0].clientX; startY=ev.touches[0].clientY;
    curDx=0; swiping=false; activeCard=card;
    lpTimer = setTimeout(()=>{ if(!swiping){ openAmbient(card); activeCard=null; } lpTimer=null; },620);
  },{passive:true});

  document.addEventListener('touchmove', ev => {
    if (!activeCard) return;
    const dx=ev.touches[0].clientX-startX, dy=ev.touches[0].clientY-startY;
    if (!swiping) {
      if (Math.abs(dy)>Math.abs(dx)+8) { clearTimeout(lpTimer); activeCard=null; return; }
      if (Math.abs(dx)>10) { swiping=true; clearTimeout(lpTimer); }
      else return;
    }
    if (activeCard!==curCard()) { springBack(activeCard); activeCard=null; return; }
    curDx=dx;
    if (swipeEnabled && ev.cancelable) { applyDrag(activeCard,curDx); ev.preventDefault(); }
  },{passive:false});

  document.addEventListener('touchend', ()=>{
    clearTimeout(lpTimer);
    if (!activeCard||!swiping) { activeCard=null; swiping=false; return; }
    const card=activeCard; activeCard=null; swiping=false;
    if (swipeEnabled && Math.abs(curDx)>90) { triggerHaptic(); flyOff(card, curDx>0?1:-1); }
    else springBack(card);
  },{passive:true});

  // Desktop keyboard shortcuts
  document.addEventListener('keydown', ev => {
    if (ev.target.closest('input,textarea')) return;

    // Space always toggles ambient regardless of focus
    if (ev.key === ' ') {
      ev.preventDefault();
      const ov = document.getElementById('ambientOverlay');
      if (ov.classList.contains('open')) { closeAmbient(); return; }
      const card = curCard();
      if (card) openAmbient(card);
      return;
    }

    // Don't process other shortcuts when focused on a button
    if (ev.target.closest('button')) return;

    // Arrow up/down for vertical scrolling
    if (ev.key === 'ArrowDown') {
      ev.preventDefault();
      feed.scrollBy({top:window.innerHeight, behavior:'smooth'});
      return;
    }
    if (ev.key === 'ArrowUp') {
      ev.preventDefault();
      feed.scrollBy({top:-window.innerHeight, behavior:'smooth'});
      return;
    }

    const card = curCard(); if (!card) return;
    const id = card.dataset.id;
    switch(ev.key) {
      case 'ArrowLeft':  ev.preventDefault(); flyOff(card, -1); break;
      case 'ArrowRight': ev.preventDefault(); flyOff(card,  1); break;
      case 'l': case 'L': toggleLike(id); break;
      case 's': case 'S': {
        const a = articles.find(x => x.id===id);
        if (a) doShare(a);
        break;
      }
      case 'r': case 'R': {
        const a = articles.find(x => x.id===id);
        if (a) window.open(a.url, '_blank');
        break;
      }
      case 'd': case 'D': {
        if (!rabbitHoleEnabled) break;
        const deeperBtn = card.querySelector('.deeper');
        if (deeperBtn && !deeperBtn.classList.contains('used')) {
          const a = articles.find(x => x.id===id);
          if (a) goDeeper(a.id, deeperBtn);
        }
        break;
      }
      case 'm': case 'M': {
        const a = articles.find(x => x.id===id);
        if (a?.src === 'how') openMap(a);
        break;
      }
    }
  });
})();

// ── KEYBOARD BAR (desktop) ────────────────────────────────────────────────
(function() {
  const bar = document.getElementById('kbBar');
  if (!bar || 'ontouchstart' in window) return;
  let hideTimer = null;
  function showBar() {
    if (!kbBarEnabled) { bar.classList.remove('show'); return; }
    bar.classList.add('show');
    clearTimeout(hideTimer);
    hideTimer = setTimeout(() => bar.classList.remove('show'), 4000);
  }
  showBar();
  document.addEventListener('mousemove', showBar);
  document.addEventListener('keydown', showBar);
  // Watch for setting changes
  new MutationObserver(() => {
    if (!kbBarEnabled) bar.classList.remove('show');
  }).observe(bar, {attributes:true, attributeFilter:['class']});
})();

// ── DOUBLE-TAP TO LIKE ──────────────────────────────────────────────────────
(function() {
  let lt=0,lx=0,ly=0,zoomed=false;
  const unzoom=()=>setTimeout(()=>{zoomed=false;},1200);
  if(window.visualViewport){window.visualViewport.addEventListener('resize',()=>{if(window.visualViewport.scale>1.05){zoomed=true;lt=0;unzoom();}});}
  document.addEventListener('touchstart',ev=>{
    if(ev.touches.length>1){zoomed=true;lt=0;unzoom();return;}
    if(zoomed){lt=0;return;}
    const card=ev.target.closest('.card');
    if(!card||ev.target.closest('button,.acts,.cbg')){lt=0;return;}
    const now=Date.now(),x=ev.touches[0].clientX,y=ev.touches[0].clientY;
    if(now-lt<340&&Math.hypot(x-lx,y-ly)<40){
      ev.preventDefault();
      toggleLike(card.dataset.id);
      const h=document.createElement('div');h.className='heart';h.textContent='❤️';
      h.style.cssText=`left:${x}px;top:${y}px`;
      document.body.appendChild(h);setTimeout(()=>h.remove(),750);lt=0;
    }else{lt=now;lx=x;ly=y;}
  },{passive:false});
})();

// ── MAP EXPLORER (Wikivoyage) ─────────────────────────────────────────────
let mapInstance = null;
let mapMarker = null;

async function geocodePlace(title) {
  // Use Nominatim to geocode the place name
  const q = encodeURIComponent(title.replace(/\s*\(.*?\)\s*/g, '').trim());
  const url = `https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1&accept-language=en`;
  try {
    const resp = await fetch(url, { headers: { 'User-Agent': 'WikiScroll/1.0' } });
    const data = await resp.json();
    if (data?.length) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), display: data[0].display_name };
  } catch {}
  return null;
}

async function openMap(article) {
  const overlay = document.getElementById('mapOverlay');
  const loading = document.getElementById('mapLoading');
  const canvas = document.getElementById('mapCanvas');
  const titleEl = document.getElementById('mapTitle');
  const badgeText = document.getElementById('mapBadgeText');
  const readLink = document.getElementById('mapReadLink');

  // Show overlay with loading state
  titleEl.textContent = article.title;
  badgeText.textContent = article.title;
  readLink.href = article.url;
  loading.classList.remove('hidden');
  overlay.classList.add('open');

  // Geocode the place
  const geo = await geocodePlace(article.title);
  if (!geo) {
    loading.querySelector('.map-loading-text').textContent = '📍 Could not locate this place';
    setTimeout(() => loading.classList.add('hidden'), 2000);
    // Still show a world view
    if (!mapInstance) {
      mapInstance = L.map(canvas, { zoomControl: false, attributionControl: false }).setView([20, 0], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19, subdomains: 'abcd',
      }).addTo(mapInstance);
      L.control.zoom({ position: 'bottomright' }).addTo(mapInstance);
    }
    setTimeout(() => mapInstance.invalidateSize(), 100);
    return;
  }

  loading.classList.add('hidden');

  if (!mapInstance) {
    mapInstance = L.map(canvas, { zoomControl: false, attributionControl: false }).setView([geo.lat, geo.lng], 8);
    const isDark = !document.body.classList.contains('light');
    L.tileLayer(isDark
      ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
      : 'https://{s}.basemaps.cartocdn.com/voyager/{z}/{x}/{y}{r}.png', {
      maxZoom: 19, subdomains: 'abcd',
    }).addTo(mapInstance);
    L.control.zoom({ position: 'bottomright' }).addTo(mapInstance);
  } else {
    mapInstance.setView([geo.lat, geo.lng], 8, { animate: true, duration: 1.2 });
  }

  // Custom marker
  const markerIcon = L.divIcon({
    className: 'map-marker-custom',
    html: '<div class="map-pin"><div class="map-pin-dot"></div><div class="map-pin-ring"></div></div>',
    iconSize: [32, 32],
    iconAnchor: [16, 16],
  });
  if (mapMarker) mapMarker.remove();
  mapMarker = L.marker([geo.lat, geo.lng], { icon: markerIcon }).addTo(mapInstance);
  mapMarker.bindPopup(`<strong>${article.title}</strong><br><span style="font-size:12px;opacity:.7">${geo.display?.split(',').slice(0,3).join(',') || ''}</span>`).openPopup();

  // Ensure map renders properly after CSS transition
  setTimeout(() => mapInstance.invalidateSize(), 350);
}

function closeMap() {
  document.getElementById('mapOverlay').classList.remove('open');
}
document.getElementById('mapClose').addEventListener('click', closeMap);
document.getElementById('mapOverlay').addEventListener('click', ev => {
  if (ev.target === ev.currentTarget) closeMap();
});

// ── DYNAMIC KB HINTS ─────────────────────────────────────────────────────
function updateKbHints() {
  const feed = document.getElementById('feed');
  const idx = Math.round(feed.scrollTop / window.innerHeight);
  const card = feed.querySelectorAll('.card')[idx];
  const a = card ? articles.find(x => x.id === card.dataset.id) : null;
  const dEl = document.getElementById('kbDeeperHint');
  const mEl = document.getElementById('kbMapHint');
  if (dEl) dEl.style.display = (rabbitHoleEnabled && a?.src === 'wiki') ? '' : 'none';
  if (mEl) mEl.style.display = (a?.src === 'how') ? '' : 'none';
}

// ── SCROLL-BASED VIEW TRACKING ──────────────────────────────────────────
let _lastViewedIdx = -1;
function trackScrollView() {
  const feed = document.getElementById('feed');
  const idx = Math.round(feed.scrollTop / window.innerHeight);
  if (idx !== _lastViewedIdx && idx >= 0) {
    _lastViewedIdx = idx;
    const card = feed.querySelectorAll('.card')[idx];
    if (card && card.dataset.id) {
      bumpStat();
      triggerHaptic();
    }
  }
}

document.getElementById('feed').addEventListener('scroll', () => {
  requestAnimationFrame(() => { updateKbHints(); trackScrollView(); });
}, { passive: true });

// ── INIT ────────────────────────────────────────────────────────────────────
loadPersistedState();
syncStreakDisplay();
updateOfflineBanner();
boot();
// Auto-focus feed so arrow keys work immediately on desktop
requestAnimationFrame(() => document.getElementById('feed').focus());
// Count the first card as viewed once it's rendered
setTimeout(() => { _lastViewedIdx = 0; bumpStat(); }, 1500);
</script>
</body>
</html>
